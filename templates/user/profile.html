    {% extends "user/base.html" %}
    {% load static %}
    {% block title %}Profile{% endblock %}
    {% block content %}
    <style>
    :root{
        --bg1:#16031f; --bg2:#2a0830; --paper:#ffffff; --ink:#121316; --muted:#68707a;
        --line:#edf0f5; --shadow:0 18px 48px rgba(0,0,0,.18); --brand:#ff734a; --chip:#f5f7fb;
    }
    .page{
        background: radial-gradient(1200px 700px at 15% -10%, rgba(255,255,255,.06), transparent),
                    linear-gradient(180deg, var(--bg1), var(--bg2));
        padding:30px 0 54px;
    }
    .wrap{max-width:1240px;margin:0 auto;padding:0 16px;color:#fff}
    .crumb{opacity:.8;font-size:14px;margin-bottom:10px}
    .welcome{font-size:28px;font-weight:800;margin:0 0 18px 323px;text-align:center}

    .grid{display:grid;grid-template-columns:360px 1fr;gap:30px;align-items:start;margin: 0px -86px 0px -98px;}
    /* Header: large capsule */
    .head-xl{
    background:#fff;
    border-radius:32px;                 /* stronger rounding like reference */
    padding:28px 28px;                  /* taller header */
    border:1px solid #eef1f5;
    box-shadow:0 10px 26px rgba(0,0,0,.10);  /* soft long shadow */
    }
    .head-xl .head-inner{
    display:flex; align-items:center; gap:22px;
    }
    @media(max-width:600px){
    .avatar-xl{width:84px;height:84px}
    .uname-xl{font-size:28px}
    .head-xl{padding:20px}
    }

    /* Avatar size */
    .avatar-xl{width:120px;height:120px;border-radius:50%;overflow:hidden;
    box-shadow:0 8px 22px rgba(0,0,0,.12);
    }
    .avatar-xl img{width:100%;height:100%;object-fit:cover}

    /* Name typography */
    .uname-xl{font-size:40px; font-weight:800; letter-spacing:.2px; color:#111}

    /* Remove the side tabs for this header variant */
    .head-xl::before, .head-xl::after{display:none}
    @media(max-width:1100px){.grid{grid-template-columns:1fr}}

    /* LEFT: sidebar */
    .side{


        background:var(--paper); color:var(--ink); border:1px solid var(--line);
        border-radius:36px; box-shadow:var(--shadow); overflow:visible;
    }
    .head{
    padding:22px 24px 18px;
    border-bottom:1px solid #eef1f6;
    background:#fff;
    border-radius:36px;
    position:relative;
    }
    .head::before,
    .head::after{
    content:""; position:absolute; width:20px; height:32px; background:#111;
    top:74px; border-radius:4px;
    }
    .head::before,.head::after{ top:88px }  /* was 74px */
    .head::before{left:14px}
    .head::after{right:14px}
    .avatar{width:80px;height:80px;border-radius:50%;box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .uname{font-size:22px;font-weight:900}
    .menu{padding:8px 10px 14px 0px}
    .ic{width:26px; font-size:18px; opacity:.95}
    .mi + .mi{margin-top:4px}            /* tighter vertical spacing */
    .mi:hover{background:#f5f7fb}
    .mi:active{transform:translateY(1px)}
    .badge{background:#eef2ff;color:#3247ff}
    .mi.is-active{
    background:#f1f6ff; color:#1144cc; box-shadow:inset 0 0 0 1px #dbe7ff;
    }
    .mi{
    display:flex; align-items:center; gap:14px;
    padding:12px 14px; border-radius:14px; font-weight:800; color:#171a1f;
    letter-spacing:.1px; line-height:1.1;
    }

    .menu a{color:inherit;text-decoration:none}
    .menu a:visited{color:inherit}

    /* RIGHT: content card */
    .panel{
        background:var(--paper); color:var(--ink); border:1px solid var(--line);
        border-radius:34px; box-shadow:var(--shadow); overflow:hidden;
    }
    .pwrap{padding:18px}
    .tiles{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:8px}
    @media(max-width:720px){.tiles{grid-template-columns:1fr}}
    .tile{
        height:150px; border-radius:18px; background:#f7f9fc; border:1px solid #eef2f7; overflow:hidden; position:relative;
        display:flex; align-items:flex-end; padding:16px; font-weight:900; font-size:24px;
    }
    .tile small{display:block;font-weight:600;color:#7c858e;font-size:14px;margin-top:6px}

    .section{background:#fff;border:1px solid var(--line);border-radius:20px;padding:18px;margin-top:12px}
    .sec-title{font-weight:900;font-size:22px;margin:2px 0 14px; position:relative}
    .sec-title::after{
        content:""; position:absolute; left:0; bottom:-6px; width:140px; height:4px; background:var(--brand); border-radius:999px;
    }

    .formgrid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:720px){.formgrid{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:6px}
    .label{font-size:13px;color:#6f757c}
    .input{
        height:48px;border:1px solid #e6ebf0;border-radius:12px;padding:0 14px;background:#fff;
    }
    .pw{position:relative}
    .eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);cursor:pointer;opacity:.65}
    .actions{display:flex;gap:14px;margin-top:16px}
    .btn{height:42px;padding:0 18px;border-radius:12px;border:1px solid #e6ebf0;background:#ff6f3d;color:#fff;font-weight:900}
    .btn.ghost{background:#fff;color:#111}

    /* Sidebar overall width consistency */
    @media(min-width:1101px){
    .side{width:360px}
    }
    /* Align sidebar with content card vertically */
    .grid{align-items:start}

    /* Image tiles like reference */
    .tile{
        text-decoration: none;
    }
    .tile.img{
    height:180px;
    border-radius:18px;
    border:1px solid #eef2f7;
    background:#f9fbff;
    overflow:hidden;
    position:relative;
    display:flex;
    align-items:flex-end;
    padding:18px;
    }
    .tile.img .t-title{font-weight:900;font-size:28px;color:#111;margin:0; text-decoration: none;}
    .tile.img .t-sub{display:block;font-weight:600;color:#7c858e;font-size:14px;margin-top:6px}
    .t-title{
        text-decoration: none;
    }
    /* artwork on the right */
    .tile.img::after{
    content:"";
    position:absolute; right:0; top:0; bottom:0; width:48%;
    background-size:cover; background-position:right center; background-repeat:no-repeat;
    border-top-right-radius:18px; border-bottom-right-radius:18px;
    filter: none;
    }

    /* specific images */
    .tile.order::after{
    background-image:url("https://res.cloudinary.com/dxndvadjt/image/upload/v1765253113/pngwing_g2goot.png");
    }
    .tile.billing::after{
    background-image:url("https://res.cloudinary.com/dxndvadjt/image/upload/v1765253154/house1_vzuwup.png");
    }

    /* spacing between title and sub on single line at large screens */
    @media(min-width:900px){
    .tile.img{padding:24px}
    .tile.img .t-row{display:flex;align-items:baseline;gap:10px}
    }
.input.error {
    border-color: #ef4444 !important;
    background-color: #fef2f2 !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
}

.error-message {
    color: #ef4444;
    font-size: 12px;
    margin-top: 4px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-5px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.error-message::before {
    content: '⚠️';
    font-size: 14px;
}

.field.has-error .label {
    color: #ef4444;
}

/* Success message styling */
.messages {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    max-width: 400px;
}

.message {
    background: #fff;
    border-left: 4px solid #10b981;
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    animation: slideInRight 0.3s ease;
}

.message.error {
    border-left-color: #ef4444;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}
</style>

<section class="page">
<div class="wrap">
    <div class="welcome">Welcome {{ user.get_full_name|default:user.username }}!</div>

    <!-- Messages Display -->
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="grid">
        {% include "user/sidebar.html" with active_tab="profile" %}

        <!-- Content -->
        <div class="panel">
            <div class="pwrap">
                <!-- Tiles -->
                <div class="tiles">
                    <a class="tile img order" href="{% url 'orders' %}">
                        <div class="t-row">
                            <h3 class="t-title">Order Tracking <br><span class="t-sub">See your order history</span></h3>
                        </div>
                    </a>

                    <a class="tile img billing" href="{% url 'address' %}">
                        <div class="t-row">
                            <h3 class="t-title">Billing Address <br><span class="t-sub">Set your billing address.</span></h3>
                        </div>
                    </a>
                </div>

                <!-- Account Details -->
                <div class="section">
                    <div class="sec-title">Account Details</div>

                    <form id="profile-form" method="post" action="{% url 'profile_update' %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="formgrid">
                            <!-- First Name -->
                            <div class="field {% if errors.first_name %}has-error{% endif %}">
                                <label class="label">First Name <span style="color: #ef4444;">*</span></label>
                                <input 
                                    class="input {% if errors.first_name %}error{% endif %}" 
                                    type="text" 
                                    name="first_name" 
                                    value="{{ form_data.first_name|default:user.first_name }}" 
                                    readonly
                                    maxlength="50"
                                    id="first_name"
                                >
                                {% if errors.first_name %}
                                <div class="error-message">{{ errors.first_name }}</div>
                                {% endif %}
                            </div>

                            <!-- Last Name -->
                            <div class="field {% if errors.last_name %}has-error{% endif %}">
                                <label class="label">Last Name <span style="color: #ef4444;">*</span></label>
                                <input 
                                    class="input {% if errors.last_name %}error{% endif %}" 
                                    type="text" 
                                    name="last_name" 
                                    value="{{ form_data.last_name|default:user.last_name }}" 
                                    readonly
                                    maxlength="50"
                                    id="last_name"
                                >
                                {% if errors.last_name %}
                                <div class="error-message">{{ errors.last_name }}</div>
                                {% endif %}
                            </div>

                            <!-- Email -->
                            <div class="field">
                                <label class="label">Email Address</label>
                                <input 
                                    class="input" 
                                    type="email" 
                                    name="email" 
                                    value="{{ user.email }}" 
                                    readonly
                                >
                            </div>

                            <!-- Phone -->
                            <div class="field {% if errors.phone %}has-error{% endif %}">
                                <label class="label">Phone</label>
                                <input 
                                    class="input {% if errors.phone %}error{% endif %}" 
                                    type="text" 
                                    name="phone" 
                                    value="{{ form_data.phone|default:user.profile.phone|default:'' }}" 
                                    readonly
                                    placeholder="e.g., +91 9876543210"
                                    id="phone"
                                >
                                {% if errors.phone %}
                                <div class="error-message">{{ errors.phone }}</div>
                                {% endif %}
                            </div>

                            <!-- Avatar -->
                            <div class="field {% if errors.avatar %}has-error{% endif %}" id="avatar-field" style="display:none">
                                <label class="label">Avatar (JPG only, max 5MB)</label>
                                <input 
                                    class="input {% if errors.avatar %}error{% endif %}" 
                                    id="avatar-input" 
                                    type="file" 
                                    name="avatar" 
                                    accept=".jpg,.jpeg,image/jpeg"
                                >
                                {% if user.profile.avatar %}
                                <small class="label">Current: {{ user.profile.avatar.name }}</small>
                                {% endif %}
                                {% if errors.avatar %}
                                <div class="error-message">{{ errors.avatar }}</div>
                                {% endif %}

                                <!-- Crop UI -->
                                <div id="cropper-wrap" style="display:none; margin-top:10px;">
                                    <img id="cropper-image" style="max-width:100%; border-radius:12px;" />
                                    <div class="actions" style="margin-top:10px;">
                                        <button class="btn" type="button" id="crop-apply">Apply Crop</button>
                                        <button class="btn ghost" type="button" id="crop-cancel">Cancel</button>
                                    </div>
                                </div>

                                <input type="hidden" name="avatar_cropped" id="avatar-cropped-holder" />
                            </div>
                        </div>

                        <div class="actions">
                            <button class="btn" type="button" id="edit-btn">Edit Profile</button>
                            <button class="btn" type="submit" id="save-btn" style="display:none">Save Changes</button>
                            <button class="btn ghost" type="button" id="cancel-btn" style="display:none">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
</section>

<!-- Your existing cropper script -->
<script>
(function(){
  const fileInput = document.getElementById('avatar-input');
  const wrap = document.getElementById('cropper-wrap');
  const img = document.getElementById('cropper-image');
  const applyBtn = document.getElementById('crop-apply');
  const cancelBtn = document.getElementById('crop-cancel');
  const form = document.getElementById('profile-form');
  let cropper;

  function revoke(url){ try{ URL.revokeObjectURL(url); }catch(_){} }

  fileInput.addEventListener('change', function(){
    const f = this.files && this.files[0];
    if(!f) return;

    // Client-side type guard
    const okTypes = ['image/jpeg', 'image/pjpeg'];
    if (!okTypes.includes(f.type)) {
      alert('❌ Only JPG format is allowed.');
      this.value = '';
      return;
    }

    // Client-side size check
    const maxSize = 5 * 1024 * 1024; // 5MB
    if (f.size > maxSize) {
      alert(`❌ File size must be less than 5MB (current: ${(f.size / 1024 / 1024).toFixed(1)}MB)`);
      this.value = '';
      return;
    }

    const url = URL.createObjectURL(f);
    img.src = url;
    wrap.style.display = '';
    
    if (cropper) cropper.destroy();
    cropper = new Cropper(img, {
      aspectRatio: 1,
      viewMode: 1,
      autoCropArea: 1,
      background: false,
      movable: true,
      zoomable: true,
      rotatable: false,
      scalable: false,
      responsive: true,
    });

    cancelBtn.onclick = () => {
      if (cropper) { cropper.destroy(); cropper = null; }
      wrap.style.display = 'none';
      revoke(url);
      fileInput.value = '';
    };

    applyBtn.onclick = async () => {
      if (!cropper) return;
      const canvas = cropper.getCroppedCanvas({ width: 512, height: 512 });
      canvas.toBlob(function(blob){
        if (!blob) { alert('❌ Failed to crop image.'); return; }
        const file = new File([blob], 'avatar.jpg', { type: 'image/jpeg' });
        form._avatarCroppedBlob = file;
        fileInput.value = '';
        wrap.style.display = 'none';
        cropper.destroy(); cropper = null;
        revoke(url);
        alert('✅ Crop applied. Click Save Changes to upload.');
      }, 'image/jpeg', 0.9);
    };
  });
})();
</script>

<!-- Edit/Cancel functionality with CLIENT-SIDE VALIDATION -->
<script>
(function() {
    const form = document.getElementById('profile-form');
    const editBtn = document.getElementById('edit-btn');
    const saveBtn = document.getElementById('save-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const avatarField = document.getElementById('avatar-field');
    const inputs = form.querySelectorAll('input.input');

    const initial = {};
    inputs.forEach(i => initial[i.name] = i.value);

    function setReadonly(ro) {
        inputs.forEach(i => { i.readOnly = ro; });
        avatarField.style.display = ro ? 'none' : '';
    }

    editBtn.addEventListener('click', function() {
        setReadonly(false);
        editBtn.style.display = 'none';
        saveBtn.style.display = '';
        cancelBtn.style.display = '';
        
        // Clear previous errors
        document.querySelectorAll('.error-message').forEach(el => el.remove());
        document.querySelectorAll('.input.error').forEach(el => el.classList.remove('error'));
    });

    cancelBtn.addEventListener('click', function() {
        inputs.forEach(i => i.value = initial[i.name] || '');
        setReadonly(true);
        editBtn.style.display = '';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        
        const av = form.querySelector('input[type=file][name=avatar]');
        if (av) av.value = '';
        
        // Clear errors
        document.querySelectorAll('.error-message').forEach(el => el.remove());
        document.querySelectorAll('.input.error').forEach(el => el.classList.remove('error'));
    });

    // CLIENT-SIDE VALIDATION on submit
    form.addEventListener('submit', function(e) {
        // Clear previous errors
        document.querySelectorAll('.error-message').forEach(el => el.remove());
        document.querySelectorAll('.input.error').forEach(el => el.classList.remove('error'));
        
        let hasErrors = false;
        
        // First Name
        const firstName = document.getElementById('first_name').value.trim();
        if (!firstName) {
            showError('first_name', 'First name is required');
            hasErrors = true;
        } else if (firstName.length < 2) {
            showError('first_name', 'First name must be at least 2 characters');
            hasErrors = true;
        } else if (!/^[a-zA-Z\s]+$/.test(firstName)) {
            showError('first_name', 'First name can only contain letters and spaces');
            hasErrors = true;
        }
        
        // Last Name
        const lastName = document.getElementById('last_name').value.trim();
        if (!lastName) {
            showError('last_name', 'Last name is required');
            hasErrors = true;
        } else if (lastName.length < 2) {
            showError('last_name', 'Last name must be at least 2 characters');
            hasErrors = true;
        } else if (!/^[a-zA-Z\s]+$/.test(lastName)) {
            showError('last_name', 'Last name can only contain letters and spaces');
            hasErrors = true;
        }
        
        // Phone (if provided)
        const phone = document.getElementById('phone').value.trim();
        if (phone) {
            const phoneClean = phone.replace(/[\s\-]/g, '');
            if (!/^\+?[0-9]{10,15}$/.test(phoneClean)) {
                showError('phone', 'Phone must be 10-15 digits');
                hasErrors = true;
            }
        }
        
        if (hasErrors) {
            e.preventDefault();
            // Scroll to first error
            const firstError = document.querySelector('.input.error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        }
    });
    
    function showError(fieldId, message) {
        const field = document.getElementById(fieldId);
        if (!field) return;
        
        field.classList.add('error');
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        
        field.parentElement.appendChild(errorDiv);
    }
})();
</script>

<!-- Auto-hide messages after 5 seconds -->
<script>
setTimeout(function() {
    const messages = document.querySelector('.messages');
    if (messages) {
        messages.style.transition = 'opacity 0.5s';
        messages.style.opacity = '0';
        setTimeout(() => messages.remove(), 500);
    }
}, 5000);
</script>

<!-- Email change & cropper submit handler (keep your existing code) -->
<script>
(function(){
  const form = document.getElementById('profile-form');
  const saveBtn = document.getElementById('save-btn');

  function getCookie(name){
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i=0;i<cookies.length;i++){
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  async function postFormWithOptionalCrop(){
    const emailInput = form.querySelector('input[name="email"]');
    const originalEmail = "{{ user.email|escapejs }}".toLowerCase();
    const newEmail = (emailInput ? emailInput.value.trim().toLowerCase() : originalEmail);

    if (newEmail !== originalEmail) {
      const fd = new FormData();
      fd.append('new_email', newEmail);
      const res = await fetch("{% url 'start_email_change' %}", {
        method:'POST', body: fd,
        headers: { 'X-CSRFToken': csrftoken },
        credentials: 'same-origin'
      });
      const data = await res.json();
      if (data.ok) {
        location.href = "{% url 'email_change_otp_page' %}";
      } else {
        alert(data.error || 'Unable to start email change');
      }
      return;
    }

    const fd2 = new FormData(form);
    if (form._avatarCroppedBlob) {
      fd2.delete('avatar');
      fd2.append('avatar_cropped', form._avatarCroppedBlob, 'avatar.jpg');
    }

    const res2 = await fetch(form.action, {
      method: 'POST',
      body: fd2,
      headers: { 'X-CSRFToken': csrftoken },
      credentials: 'same-origin'
    });
    if (res2.redirected) {
      location.href = res2.url;
    } else {
      location.reload();
    }
  }

  saveBtn.addEventListener('click', function(e){
    e.preventDefault();
    
    // Trigger form validation first
    const event = new Event('submit', { cancelable: true });
    if (form.dispatchEvent(event)) {
      postFormWithOptionalCrop();
    }
  });
})();
</script>

{% endblock %}