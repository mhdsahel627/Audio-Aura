    {% extends "user/base.html" %}
    {% load static %}
    {% block title %}Profile{% endblock %}
    {% block content %}
    <style>
    :root{
        --bg1:#16031f; --bg2:#2a0830; --paper:#ffffff; --ink:#121316; --muted:#68707a;
        --line:#edf0f5; --shadow:0 18px 48px rgba(0,0,0,.18); --brand:#ff734a; --chip:#f5f7fb;
    }
    .page{
        background: radial-gradient(1200px 700px at 15% -10%, rgba(255,255,255,.06), transparent),
                    linear-gradient(180deg, var(--bg1), var(--bg2));
        padding:30px 0 54px;
    }
    .wrap{max-width:1240px;margin:0 auto;padding:0 16px;color:#fff}
    .crumb{opacity:.8;font-size:14px;margin-bottom:10px}
    .welcome{font-size:28px;font-weight:800;margin:0 0 18px 323px;text-align:center}

    .grid{display:grid;grid-template-columns:360px 1fr;gap:30px;align-items:start;margin: 0px -86px 0px -98px;}
    /* Header: large capsule */
    .head-xl{
    background:#fff;
    border-radius:32px;                 /* stronger rounding like reference */
    padding:28px 28px;                  /* taller header */
    border:1px solid #eef1f5;
    box-shadow:0 10px 26px rgba(0,0,0,.10);  /* soft long shadow */
    }
    .head-xl .head-inner{
    display:flex; align-items:center; gap:22px;
    }
    @media(max-width:600px){
    .avatar-xl{width:84px;height:84px}
    .uname-xl{font-size:28px}
    .head-xl{padding:20px}
    }

    /* Avatar size */
    .avatar-xl{width:120px;height:120px;border-radius:50%;overflow:hidden;
    box-shadow:0 8px 22px rgba(0,0,0,.12);
    }
    .avatar-xl img{width:100%;height:100%;object-fit:cover}

    /* Name typography */
    .uname-xl{font-size:40px; font-weight:800; letter-spacing:.2px; color:#111}

    /* Remove the side tabs for this header variant */
    .head-xl::before, .head-xl::after{display:none}
    @media(max-width:1100px){.grid{grid-template-columns:1fr}}

    /* LEFT: sidebar */
    .side{


        background:var(--paper); color:var(--ink); border:1px solid var(--line);
        border-radius:36px; box-shadow:var(--shadow); overflow:visible;
    }
    .head{
    padding:22px 24px 18px;
    border-bottom:1px solid #eef1f6;
    background:#fff;
    border-radius:36px;
    position:relative;
    }
    .head::before,
    .head::after{
    content:""; position:absolute; width:20px; height:32px; background:#111;
    top:74px; border-radius:4px;
    }
    .head::before,.head::after{ top:88px }  /* was 74px */
    .head::before{left:14px}
    .head::after{right:14px}
    .avatar{width:80px;height:80px;border-radius:50%;box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .uname{font-size:22px;font-weight:900}
    .menu{padding:8px 10px 14px 0px}
    .ic{width:26px; font-size:18px; opacity:.95}
    .mi + .mi{margin-top:4px}            /* tighter vertical spacing */
    .mi:hover{background:#f5f7fb}
    .mi:active{transform:translateY(1px)}
    .badge{background:#eef2ff;color:#3247ff}
    .mi.is-active{
    background:#f1f6ff; color:#1144cc; box-shadow:inset 0 0 0 1px #dbe7ff;
    }
    .mi{
    display:flex; align-items:center; gap:14px;
    padding:12px 14px; border-radius:14px; font-weight:800; color:#171a1f;
    letter-spacing:.1px; line-height:1.1;
    }

    .menu a{color:inherit;text-decoration:none}
    .menu a:visited{color:inherit}

    /* RIGHT: content card */
    .panel{
        background:var(--paper); color:var(--ink); border:1px solid var(--line);
        border-radius:34px; box-shadow:var(--shadow); overflow:hidden;
    }
    .pwrap{padding:18px}
    .tiles{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:8px}
    @media(max-width:720px){.tiles{grid-template-columns:1fr}}
    .tile{
        height:150px; border-radius:18px; background:#f7f9fc; border:1px solid #eef2f7; overflow:hidden; position:relative;
        display:flex; align-items:flex-end; padding:16px; font-weight:900; font-size:24px;
    }
    .tile small{display:block;font-weight:600;color:#7c858e;font-size:14px;margin-top:6px}

    .section{background:#fff;border:1px solid var(--line);border-radius:20px;padding:18px;margin-top:12px}
    .sec-title{font-weight:900;font-size:22px;margin:2px 0 14px; position:relative}
    .sec-title::after{
        content:""; position:absolute; left:0; bottom:-6px; width:140px; height:4px; background:var(--brand); border-radius:999px;
    }

    .formgrid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:720px){.formgrid{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:6px}
    .label{font-size:13px;color:#6f757c}
    .input{
        height:48px;border:1px solid #e6ebf0;border-radius:12px;padding:0 14px;background:#fff;
    }
    .pw{position:relative}
    .eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);cursor:pointer;opacity:.65}
    .actions{display:flex;gap:14px;margin-top:16px}
    .btn{height:42px;padding:0 18px;border-radius:12px;border:1px solid #e6ebf0;background:#ff6f3d;color:#fff;font-weight:900}
    .btn.ghost{background:#fff;color:#111}

    /* Sidebar overall width consistency */
    @media(min-width:1101px){
    .side{width:360px}
    }
    /* Align sidebar with content card vertically */
    .grid{align-items:start}

    /* Image tiles like reference */
    .tile{
        text-decoration: none;
    }
    .tile.img{
    height:180px;
    border-radius:18px;
    border:1px solid #eef2f7;
    background:#f9fbff;
    overflow:hidden;
    position:relative;
    display:flex;
    align-items:flex-end;
    padding:18px;
    }
    .tile.img .t-title{font-weight:900;font-size:28px;color:#111;margin:0; text-decoration: none;}
    .tile.img .t-sub{display:block;font-weight:600;color:#7c858e;font-size:14px;margin-top:6px}
    .t-title{
        text-decoration: none;
    }
    /* artwork on the right */
    .tile.img::after{
    content:"";
    position:absolute; right:0; top:0; bottom:0; width:48%;
    background-size:cover; background-position:right center; background-repeat:no-repeat;
    border-top-right-radius:18px; border-bottom-right-radius:18px;
    filter: none;
    }

    /* specific images */
    .tile.order::after{
    background-image:url("https://res.cloudinary.com/dxndvadjt/image/upload/v1765253113/pngwing_g2goot.png");
    }
    .tile.billing::after{
    background-image:url("https://res.cloudinary.com/dxndvadjt/image/upload/v1765253154/house1_vzuwup.png");
    }

    /* spacing between title and sub on single line at large screens */
    @media(min-width:900px){
    .tile.img{padding:24px}
    .tile.img .t-row{display:flex;align-items:baseline;gap:10px}
    }

    </style>

    <section class="page">
    <div class="wrap">
       
        <div class="welcome">Welcome {{ user.get_full_name|default:user.username }} !</div>

        <div class="grid">

      {% include "user/sidebar.html" with active_tab="profile" %}

        <!-- Content -->
        <div class="panel">
            <div class="pwrap">

            <!-- Tiles -->
                <div class="tiles">
                <a class="tile img order" href="{% url 'orders' %}">
                    <div class="t-row">
                    <h3 class="t-title">Order Tracking <br><span class="t-sub">See your order history</span></h3>
                    </div>
                </a>

                <a class="tile img billing" href="{% url 'address' %}">
                    <div class="t-row">
                    <h3 class="t-title">Billing Address <br> <span class="t-sub">Set your billing address.</span></h3>
                    
                    </div>
                </a>
                </div>

            <!-- Account details -->
            <div class="section">
                <div class="sec-title">Account Details</div>

                <form id="profile-form" method="post" action="{% url 'profile_update' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="formgrid">
                    <div class="field">
                    <label class="label">First Name</label>
                    <input class="input" type="text" name="first_name" value="{{ user.first_name }}" readonly>
                    </div>
                    <div class="field">
                    <label class="label">Last Name</label>
                    <input class="input" type="text" name="last_name" value="{{ user.last_name }}" readonly>
                    </div>

                    <div class="field">
                    <label class="label">Email Address</label>
                    <input class="input" type="email" name="email" value="{{ user.email }}" readonly>
                    </div>
                    <div class="field">
                    <label class="label">Phone</label>
                    <input class="input" type="text" name="phone" value="{{ user.profile.phone|default:'' }}" readonly>
                    </div>

                    <!-- Avatar edit (hidden until Edit mode) -->
                    <div class="field" id="avatar-field" style="display:none">
                    <label class="label">Avatar</label>

                    <!-- Only JPG allowed by accept -->
                    <input class="input" id="avatar-input" type="file" name="avatar" accept=".jpg,.jpeg,image/jpeg">

                    {% if user.profile.avatar %}
                        <small class="label">Current: {{ user.profile.avatar.name }}</small>
                    {% endif %}

                    <!-- Crop UI -->
                    <div id="cropper-wrap" style="display:none; margin-top:10px;">
                        <img id="cropper-image" style="max-width:100%; border-radius:12px;" />
                        <div class="actions" style="margin-top:10px;">
                        <button class="btn" type="button" id="crop-apply">Apply Crop</button>
                        <button class="btn ghost" type="button" id="crop-cancel">Cancel</button>
                        </div>
                    </div>

                    <!-- Will be filled by JS submit hook as a file via FormData -->
                    <input type="hidden" name="avatar_cropped" id="avatar-cropped-holder" />
                    </div>

                </div>

                <div class="actions">
                    <button class="btn" type="button" id="edit-btn">Edit Profile</button>
                    <button class="btn" type="submit" id="save-btn" style="display:none">Save Changes</button>
                    <button class="btn ghost" type="button" id="cancel-btn" style="display:none">Cancel</button>
                    
                </div>
                </form>
            </div>

            </div>
        </div>

        </div>
    </div>
    </section>

 <script>
(function(){
  const form = document.getElementById('profile-form');
  const saveBtn = document.getElementById('save-btn');

  function getCookie(name){
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i=0;i<cookies.length;i++){
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  async function postFormWithOptionalCrop(){
    // Handle email OTP flow first, if email changed
    const emailInput = form.querySelector('input[name="email"]');
    const originalEmail = "{{ user.email|escapejs }}".toLowerCase();
    const newEmail = (emailInput ? emailInput.value.trim().toLowerCase() : originalEmail);

    if (newEmail !== originalEmail) {
      const fd = new FormData();
      fd.append('new_email', newEmail);
      const res = await fetch("{% url 'start_email_change' %}", {
        method:'POST', body: fd,
        headers: { 'X-CSRFToken': csrftoken },
        credentials: 'same-origin'
      });
      const data = await res.json();
      if (data.ok) {
        location.href = "{% url 'email_change_otp_page' %}";
      } else {
        alert(data.error || 'Unable to start email change');
      }
      return;
    }

    // Build FormData for profile update, include cropped if available
    const fd2 = new FormData(form);
    if (form._avatarCroppedBlob) {
      // Prefer cropped; drop raw
      fd2.delete('avatar');
      fd2.append('avatar_cropped', form._avatarCroppedBlob, 'avatar.jpg');
    }

    const res2 = await fetch(form.action, {
      method: 'POST',
      body: fd2,
      headers: { 'X-CSRFToken': csrftoken },
      credentials: 'same-origin'
    });
    if (res2.redirected) {
      location.href = res2.url;
    } else {
      location.reload();
    }
  }

  saveBtn.addEventListener('click', function(e){
    e.preventDefault();
    postFormWithOptionalCrop();
  });

  // Prevent native submit from bypassing the crop flow
  form.addEventListener('submit', function(e){
    // If Save is clicked, we already handle; block default to avoid duplicate posts
    e.preventDefault();
    // Optionally call postFormWithOptionalCrop() if someone triggers Enter key submit:
    postFormWithOptionalCrop();
  });
})();
</script>


    <script>
    // CSRF helper (reads cookie)
    function getCookie(name){
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
            }
        }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Email-change save handler
document.getElementById('save-btn').addEventListener('click', async function(event){
  event.preventDefault(); // ensure form doesn't submit
  const form = document.getElementById('profile-form');
  const email = form.querySelector('input[name="email"]').value.trim().toLowerCase();
  const original = "{{ user.email|escapejs }}".toLowerCase();

  if (email !== original) {
    const fd = new FormData();
    fd.append('new_email', email);
    const res = await fetch("{% url 'start_email_change' %}", {
      method:'POST',
      body: fd,
      headers: { 'X-CSRFToken': csrftoken },
      credentials: 'same-origin'
    });
    const data = await res.json();
    if (data.ok) {
      // navigate to full OTP page
      location.href = "{% url 'email_change_otp_page' %}";
    } else {
      alert(data.error || 'Unable to start email change');
    }
  } else {
    form.submit();
  }
});

    document.getElementById('confirm-email-otp').addEventListener('click', async function(){
        const code = document.getElementById('email-otp').value.trim();
        const fd = new FormData();
        fd.append('otp', code);
        const res = await fetch("{% url 'verify_email_change' %}", {
        method:'POST',
        body: fd,
        headers: { 'X-CSRFToken': csrftoken },
        credentials: 'same-origin'
        });
        const data = await res.json();
        if (data.ok) {
        location.reload();
        } else {
        alert(data.error || 'Verification failed');
        }
    });

    document.getElementById('resend-email-otp').addEventListener('click', async function(){
        const email = document.querySelector('input[name="email"]').value.trim();
        const fd = new FormData();
        fd.append('new_email', email);
        await fetch("{% url 'start_email_change' %}", {
        method:'POST',
        body: fd,
        headers: { 'X-CSRFToken': csrftoken },
        credentials: 'same-origin'
        });
        alert('OTP resent');
    });
    </script>

    <script>
    (function() {
        const form = document.getElementById('profile-form');
        const editBtn = document.getElementById('edit-btn');
        const saveBtn = document.getElementById('save-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const avatarField = document.getElementById('avatar-field');
        const inputs = form.querySelectorAll('input.input');

        const initial = {};
        inputs.forEach(i => initial[i.name] = i.value);

        function setReadonly(ro) {
        inputs.forEach(i => { i.readOnly = ro; }); // remove the email exception
        avatarField.style.display = ro ? 'none' : '';
        }

        editBtn.addEventListener('click', function() {
        setReadonly(false);
        editBtn.style.display = 'none';
        saveBtn.style.display = '';
        cancelBtn.style.display = '';
        });

        cancelBtn.addEventListener('click', function() {
        inputs.forEach(i => i.value = initial[i.name] || '');
        setReadonly(true);
        editBtn.style.display = '';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        const av = form.querySelector('input[type=file][name=avatar]');
        if (av) av.value = '';
        });
    })();
    </script>

<script>
(function(){
  const fileInput = document.getElementById('avatar-input');
  const wrap = document.getElementById('cropper-wrap');
  const img = document.getElementById('cropper-image');
  const applyBtn = document.getElementById('crop-apply');
  const cancelBtn = document.getElementById('crop-cancel');
  const form = document.getElementById('profile-form');
  let cropper;

  function revoke(url){ try{ URL.revokeObjectURL(url); }catch(_){} }

  fileInput.addEventListener('change', function(){
    const f = this.files && this.files[0];
    if(!f) return;

    // Client-side type guard: allow only JPG
    const okTypes = ['image/jpeg', 'image/pjpeg'];
    if (!okTypes.includes(f.type)) {
      alert('Only JPG format is allowed.');
      this.value = '';
      return;
    }

    const url = URL.createObjectURL(f);
    img.src = url;
    wrap.style.display = '';
    // Destroy old cropper if any
    if (cropper) cropper.destroy();
    cropper = new Cropper(img, {
      aspectRatio: 1, // square avatar
      viewMode: 1,
      autoCropArea: 1,
      background: false,
      movable: true,
      zoomable: true,
      rotatable: false,
      scalable: false,
      responsive: true,
    });

    cancelBtn.onclick = () => {
      if (cropper) { cropper.destroy(); cropper = null; }
      wrap.style.display = 'none';
      revoke(url);
      fileInput.value = '';
    };

    applyBtn.onclick = async () => {
    if (!cropper) return;
    const canvas = cropper.getCroppedCanvas({ width: 512, height: 512 });
    canvas.toBlob(function(blob){
        if (!blob) { alert('Failed to crop image.'); return; }
        const file = new File([blob], 'avatar.jpg', { type: 'image/jpeg' });
        form._avatarCroppedBlob = file;
        // Critical: clear raw input so native form cannot upload the original
        fileInput.value = '';
        wrap.style.display = 'none';
        cropper.destroy(); cropper = null;
        revoke(url);
        alert('Crop applied. Click Save Changes to upload.');
    }, 'image/jpeg', 0.9);
    };
  });

  // Intercept submit to append cropped blob as avatar_cropped
  form.addEventListener('submit', function(e){
    if (form._avatarCroppedBlob) {
      // Build FormData manually and post
      e.preventDefault();
      const fd = new FormData(form);
      fd.delete('avatar'); // ignore raw file if any
      fd.append('avatar_cropped', form._avatarCroppedBlob, 'avatar.jpg');

      fetch(form.action, {
        method: 'POST',
        body: fd,
        headers: { 'X-CSRFToken': (document.querySelector('input[name=csrfmiddlewaretoken]')||{}).value || '' },
        credentials: 'same-origin'
      }).then(r => window.location.reload());
    }
  });
})();
</script>


    {% endblock %}
