{% extends 'user/base.html' %}
{% load static %}

{% block title %}Choose Delivery Point{% endblock %}

{% block content %}
<style>
  :root{
    --panel:#efeff1; --paper:#ffffff; --ink:#111; --muted:#6b6b6f;
    --line:#e9e9ec; --brand:#000; --radius:18px;
    --shadow:0px 12px 28px rgba(0,0,0,0.3); --cardShadow:0 8px 20px rgba(0,0,0,.10);
    --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --shadow-2xl: 0 35px 60px -15px rgba(0, 0, 0, 0.3);
  }
  *{box-sizing:border-box}
  body{color:var(--ink); font-family:Inter,system-ui,Arial,sans-serif}

  .shell{max-width:1240px; margin:28px auto; padding:0 16px}
  .head{text-align:center; font-weight:700; letter-spacing:.4px; font-size:13px; color:#fff; margin-bottom:10px}

  .layout{display:grid; grid-template-columns: 440px 1fr; gap:28px; background:#fff; padding:0; border-radius:28px;}
  @media (max-width:1060px){ .layout{grid-template-columns:1fr} }

  /* Left summary */
  .summary{ background:var(--panel); border:1px solid #dedee2; border-radius:28px; box-shadow:var(--shadow); padding:18px; }
  .sum-row{display:flex; justify-content:space-between; align-items:center}
  .sum-title{font-size:12px; color:#3a3a41; font-weight:700}
  .thumbs{display:flex; gap:10px; padding:14px 0 12px}
  .thumbs img{width:42px; height:42px; border-radius:999px; border:2px solid #fff; box-shadow:0 4px 12px rgba(0,0,0,.20)}
  .amount{font-weight:700}
  .coupon{display:block; width:100%; height:46px; border-radius:12px; border:0; background:#000; color:#fff; font-weight:700; margin:10px 0 18px; cursor:pointer}
  .promo{border-radius:18px; overflow:hidden; background:#000}
  .promo img{display:block; width:100%; height:auto}

  /* Address grid */
  .grid{display:grid; grid-template-columns: repeat(2, minmax(300px,1fr)); gap:22px; padding:26px 23px 24px 0;}
  @media (max-width:760px){ .grid{grid-template-columns:1fr} }

  .card{ position:relative; background:var(--paper); border:1px solid var(--line); border-radius:18px; box-shadow:var(--cardShadow); padding:20px 20px 74px 20px; transition:all 0.3s ease; }
  .card-head{display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px}
  .name{font-weight:700; font-size:14px}
  .sub{font-size:12px; color:#49494e; margin-top:2px}
  .edit{ width:36px; height:36px; border-radius:10px; border:1px solid var(--line); display:inline-flex; align-items:center; justify-content:center; background:#fff; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.06); transition:all 0.25s ease; }
  .edit:hover{ background:#f8fafc; transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,.12); }
  .addr{margin:12px 0; font-size:13px; line-height:1.55; color:#222}
  .meta{font-size:12px; color:#5a5a61}
  .deliver{ position:absolute; right:20px; bottom:20px; height:42px; padding:0 18px; border-radius:10px; border:0; background:#000; color:#fff; font-weight:700; cursor:pointer; box-shadow:0 6px 16px rgba(0,0,0,.18); transition:all 0.25s ease; }
  .deliver:hover{ background:#1a1a1a; transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.25); }
  .select{ position:absolute; inset:0; opacity:0; border-radius:18px; cursor:pointer; }
  .card:has(.select:checked){ border-color:#111; box-shadow:0 10px 24px rgba(0,0,0,.18); transform:translateY(-2px); }

  .add{ display:flex; align-items:center; justify-content:center; background:#fff; border:1px dashed #cfcfd4; border-radius:18px; min-height:248px; transition:all 0.3s ease; cursor:pointer; }
  .add:hover{ border-color:#999; background:#fafafa; }
  .add-wrap{display:flex; flex-direction:column; align-items:center; gap:10px; color:#262626}
  .plus{width:44px; height:44px; border-radius:999px; border:1px solid #333; display:flex; align-items:center; justify-content:center; font-size:22px; transition:all 0.3s ease;}
  .add:hover .plus{ transform:rotate(90deg); background:#000; color:#fff; }
  .add button{height:40px; padding:0 16px; border-radius:10px; border:1px solid #222; background:#fff; cursor:pointer; transition:all 0.25s ease;}
  .add button:hover{ background:#000; color:#fff; }

  /* ============ ENHANCED MODAL STYLES ============ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0);
    backdrop-filter: blur(0px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .modal-overlay.active {
    z-index: 6000;
    display: flex;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(16px);
    animation: overlayFadeIn 0.4s ease;
  }

  @keyframes overlayFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .modal-container {
    width: 100%;
    max-width: 750px;
    max-height: 90vh;
    background: white;
    border-radius: 32px;
    box-shadow: var(--shadow-2xl);
    position: relative;
    overflow: hidden;
    transform: scale(0.9) translateY(30px);
    opacity: 0;
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .modal-overlay.active .modal-container {
    transform: scale(1) translateY(0);
    opacity: 1;
  }

  .modal-header-band {
    height: 8px;
    background: var(--gradient-primary);
    position: relative;
    overflow: hidden;
  }

  .modal-header-band::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: shimmer 2s infinite;
  }

  @keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
  }

  .modal-content {
    padding: 40px;
    max-height: calc(90vh - 8px);
    overflow-y: auto;
  }

  .modal-content::-webkit-scrollbar {
    width: 10px;
  }

  .modal-content::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 10px;
    margin: 10px 0;
  }

  .modal-content::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #667eea, #764ba2);
    border-radius: 10px;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 36px;
    position: relative;
  }

  .modal-title-wrapper {
    flex: 1;
  }

  .modal-title {
    font-size: 36px;
    font-weight: 900;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -1.5px;
    margin-bottom: 8px;
    animation: titleSlideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes titleSlideIn {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .modal-subtitle {
    font-size: 16px;
    color: #64748b;
    font-weight: 500;
    animation: subtitleSlideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s backwards;
  }

  @keyframes subtitleSlideIn {
    from {
      opacity: 0;
      transform: translateX(-15px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .close-btn {
    width: 44px;
    height: 44px;
    border-radius: 14px;
    border: 2px solid #e2e8f0;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 24px;
    color: #64748b;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    flex-shrink: 0;
    margin-left: 20px;
  }

  .close-btn:hover {
    background: var(--gradient-primary);
    color: white;
    border-color: transparent;
    transform: rotate(90deg) scale(1.1);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
    animation: formFadeIn 0.6s ease 0.2s backwards;
  }

  @keyframes formFadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 640px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
  }

  .form-field {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .form-field.full-width {
    grid-column: 1 / -1;
  }

  .form-label {
    font-size: 14px;
    font-weight: 700;
    color: #334155;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .required {
    color: #ef4444;
    font-size: 16px;
  }

  .label-icon {
    font-size: 16px;
  }

  .input-wrapper {
    position: relative;
  }

  .form-input,
  .form-select,
  .form-textarea {
    width: 100%;
    height: 54px;
    padding: 0 18px;
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    font-size: 15px;
    color: #0f172a;
    background: white;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: inherit;
  }

  .form-input:hover,
  .form-select:hover,
  .form-textarea:hover {
    border-color: #cbd5e1;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .form-input:focus,
  .form-select:focus,
  .form-textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15), 0 4px 12px rgba(102, 126, 234, 0.1);
    transform: translateY(-1px);
  }

  .form-textarea {
    height: 120px;
    padding: 16px 18px;
    resize: vertical;
    min-height: 80px;
  }

  .form-input::placeholder,
  .form-textarea::placeholder {
    color: #94a3b8;
  }

  .input-spinner {
    position: absolute;
    right: 18px;
    top: 50%;
    transform: translateY(-50%);
    width: 22px;
    height: 22px;
    border: 3px solid #f3f4f6;
    border-top: 3px solid #667eea;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    display: none;
  }

  .input-spinner.active {
    display: block;
  }

  @keyframes spin {
    0% { transform: translateY(-50%) rotate(0deg); }
    100% { transform: translateY(-50%) rotate(360deg); }
  }

  .form-input.success {
    animation: successPulse 0.6s ease;
  }

  @keyframes successPulse {
    0% {
      border-color: #e2e8f0;
    }
    50% {
      border-color: #10b981;
      background: #f0fdf4;
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
    }
    100% {
      border-color: #e2e8f0;
    }
  }

  .error-message {
    font-size: 13px;
    color: #ef4444;
    font-weight: 600;
    display: none;
    padding-left: 4px;
    animation: shake 0.4s ease;
  }

  .error-message.active {
    display: block;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-6px); }
    75% { transform: translateX(6px); }
  }

  .checkbox-field {
    display: flex;
    align-items: center;
    gap: 14px;
    cursor: pointer;
    padding: 16px;
    border-radius: 16px;
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    transition: all 0.3s ease;
  }

  .checkbox-field:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
  }

  .form-checkbox {
    width: 26px;
    height: 26px;
    border-radius: 10px;
    border: 2px solid #cbd5e1;
    cursor: pointer;
    appearance: none;
    background: white;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    flex-shrink: 0;
  }

  .form-checkbox:checked {
    background: var(--gradient-primary);
    border-color: transparent;
    transform: scale(1.05);
  }

  .form-checkbox:checked::after {
    content: '‚úì';
    position: absolute;
    color: white;
    font-size: 18px;
    font-weight: bold;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    animation: checkBounce 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes checkBounce {
    0% {
      transform: translate(-50%, -50%) scale(0);
    }
    50% {
      transform: translate(-50%, -50%) scale(1.2);
    }
    100% {
      transform: translate(-50%, -50%) scale(1);
    }
  }

  .checkbox-label {
    font-size: 15px;
    font-weight: 600;
    color: #334155;
  }

  .form-actions {
    display: flex;
    gap: 14px;
    justify-content: flex-end;
    margin-top: 40px;
    padding-top: 30px;
    border-top: 2px solid #f1f5f9;
    animation: actionsFadeIn 0.6s ease 0.3s backwards;
  }

  @keyframes actionsFadeIn {
    from {
      opacity: 0;
      transform: translateY(15px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .btn {
    height: 54px;
    padding: 0 36px;
    border-radius: 16px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 2px solid #e2e8f0;
    background: white;
    color: #475569;
  }

  .btn:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
  }

  .btn-primary {
    background: var(--gradient-primary);
    color: white;
    border: none;
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
    position: relative;
    overflow: hidden;
  }

  .btn-primary::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
    transform: translateX(-100%);
    transition: transform 0.6s ease;
  }

  .btn-primary:hover::before {
    transform: translateX(100%);
  }

  .btn-primary:hover {
    box-shadow: 0 12px 32px rgba(102, 126, 234, 0.5);
    transform: translateY(-3px) scale(1.02);
  }

  .btn-primary:active {
    transform: translateY(-1px) scale(0.98);
  }

  @media (max-width: 640px) {
    .modal-content {
      padding: 30px 24px;
    }

    .modal-title {
      font-size: 28px;
    }

    .form-actions {
      flex-direction: column-reverse;
    }

    .btn {
      width: 100%;
    }
  }

  .modal-container::after {
    content: '';
    position: absolute;
    top: -150px;
    right: -150px;
    width: 350px;
    height: 350px;
    background: radial-gradient(circle, rgba(102, 126, 234, 0.08) 0%, transparent 70%);
    border-radius: 50%;
    pointer-events: none;
    animation: float 6s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% { transform: translate(0, 0) scale(1); }
    50% { transform: translate(-20px, 20px) scale(1.05); }
  }
</style>

<section class="shell">
  <div class="head">CHOOSE DELIVERY POINT</div>

  <div class="layout">
    <!-- Left summary -->
    <aside class="summary">
      <div class="sum-row">
        <div class="sum-title">Order summary ¬∑ {{ products_count }} products</div>
        <div class="amount">‚Çπ {{ total_payable }}</div>
      </div>
      <div class="thumbs">
        {% for it in items|slice:":6" %}
        <img src="{% if it.image %}{{ it.image }}{% else %}{% static 'images/logo.png' %}{% endif %}" alt="{{ it.name }}">
        {% endfor %}
      </div>
      <button class="coupon" type="button">Address Point</button>
      <div class="promo" aria-hidden="true">
        <img src="{% static 'images/Screenshot 2025-10-06 182700.png' %}" alt="">
      </div>
    </aside>

    <!-- Right grid -->
    <div class="right">
      <form id="addrFormMain" method="post" action="{% url 'select_address' %}">
        {% csrf_token %}
        <div class="grid">
          {% for a in addresses %}
          <label class="card">
            <input class="select" type="radio" name="address_id" value="{{ a.id }}"
                   {% if a.is_default or a.id == default_address_id %}checked{% endif %}>
            <div class="card-head">
              <div>
                <div class="name">{{ a.full_name }}</div>
                <div class="sub">{{ a.phone }}</div>
              </div>



            </div>

            <div class="addr">
              {{ a.address_line1 }}{% if a.address_line2 %}, {{ a.address_line2 }}{% endif %}<br>
              {{ a.city }} ¬∑ {{ a.postcode }}
            </div>
            <div class="meta">{{ a.state }}, {{ a.country }} {% if a.is_default %}¬∑ Default{% endif %}</div>

            <div style="position:absolute; left:20px; bottom:20px; display:flex; gap:8px;">
              <form method="post" action="{% url 'address_delete' a.id %}?next={% url 'address_check' %}" onsubmit="return confirm('Delete this address?')">
                {% csrf_token %}
                <button type="submit" class="edit" title="Delete" onclick="event.stopPropagation();">üóë</button>
                <button type="button" class="edit"
                      title="Edit"
                      onclick="openEdit(this, event);"
                      data-id="{{ a.id }}"
                      data-name="{{ a.full_name|escape }}"
                      data-phone="{{ a.phone|escape }}"
                      data-line1="{{ a.address_line1|escape }}"
                      data-line2="{{ a.address_line2|default_if_none:''|escape }}"
                      data-city="{{ a.city|escape }}"
                      data-state="{{ a.state|escape }}"
                      data-postcode="{{ a.postcode|escape }}"
                      data-country="{{ a.country|escape }}"
                      data-notes="{{ a.notes|default_if_none:''|escape }}"
                      data-default="{{ a.is_default|yesno:'1,0' }}">‚úé
              </button>

              </form>
              {% if not a.is_default %}
              <form method="post" action="{% url 'address_make_default' a.id %}?next={% url 'address_check' %}">
                {% csrf_token %}
                <button type="submit" class="edit" title="Make Default" onclick="event.stopPropagation();">‚òÖ</button>
              </form>
              {% endif %}
            </div>

            <button type="submit" class="deliver">DELIVER HERE</button>
          </label>
          {% empty %}
          <div class="add" onclick="openDrawerCreate()">
            <div class="add-wrap">
              <div class="plus">+</div>
              <div>No addresses found</div>
              <button type="button" onclick="event.stopPropagation(); openDrawerCreate()">Add</button>
            </div>
          </div>
          {% endfor %}

          <!-- Add tile -->
          <div class="add" onclick="openDrawerCreate()">
            <div class="add-wrap">
              <div class="plus">+</div>
              <div>Add new Address</div>
              <button type="button" onclick="event.stopPropagation(); openDrawerCreate()">Add</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>

<!-- Enhanced Modal -->
<div class="modal-overlay" id="addressModal" onclick="if(event.target === this) closeModal()">
  <div class="modal-container">
    <div class="modal-header-band"></div>
    
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title-wrapper">
          <h2 class="modal-title" id="modalTitle">Add New Address</h2>
          <p class="modal-subtitle" id="modalSubtitle">Fill in your delivery details</p>
        </div>
        <button type="button" class="close-btn" onclick="closeModal()" aria-label="Close">√ó</button>
      </div>

      <form id="addressForm" method="post">
        {% csrf_token %}
        <input type="hidden" name="mode" id="mode" value="create">
        <input type="hidden" name="addr_id" id="addr_id" value="">
        
        <div class="form-grid">
          <!-- Full Name -->
          <div class="form-field">
            <label class="form-label">
              <span class="label-icon">üë§</span>
              Full Name
              <span class="required">*</span>
            </label>
            <input 
              type="text" 
              class="form-input" 
              name="full_name" 
              placeholder="John Doe" 
              required
            >
          </div>

          <!-- Phone -->
          <div class="form-field">
            <label class="form-label">
              <span class="label-icon">üì±</span>
              Phone Number
              <span class="required">*</span>
            </label>
            <input 
              type="tel" 
              class="form-input" 
              name="phone" 
              placeholder="+91 98765 43210" 
              required
            >
          </div>

          <!-- Address Line 1 -->
          <div class="form-field full-width">
            <label class="form-label">
              <span class="label-icon">üè†</span>
              Address Line 1
              <span class="required">*</span>
            </label>
            <input 
              type="text" 
              class="form-input" 
              name="address_line1" 
              placeholder="House number, Street name" 
              required
            >
          </div>

          <!-- Address Line 2 -->
          <div class="form-field full-width">
            <label class="form-label">
              <span class="label-icon">üè¢</span>
              Address Line 2
            </label>
            <input 
              type="text" 
              class="form-input" 
              name="address_line2" 
              placeholder="Apartment, Suite, Building (Optional)"
            >
          </div>

          <!-- Postcode with Auto-fill -->
          <div class="form-field">
            <label class="form-label">
              <span class="label-icon">üìÆ</span>
              Postcode / PIN
              <span class="required">*</span>
            </label>
            <div class="input-wrapper">
              <input 
                type="text" 
                class="form-input" 
                id="postcode" 
                name="postcode" 
                placeholder="123456" 
                maxlength="6" 
                pattern="[0-9]{6}"
                required
              >
              <span class="input-spinner" id="postcodeSpinner"></span>
            </div>
            <span class="error-message" id="postcodeError">Invalid pincode</span>
          </div>

          <!-- City -->
          <div class="form-field">
            <label class="form-label">
              <span class="label-icon">üåÜ</span>
              City
              <span class="required">*</span>
            </label>
            <input 
              type="text" 
              class="form-input" 
              id="city" 
              name="city" 
              placeholder="Mumbai" 
              required
            >
          </div>

          <!-- State -->
          <div class="form-field">
            <label class="form-label">
              <span class="label-icon">üìç</span>
              State
              <span class="required">*</span>
            </label>
            <input 
              type="text" 
              class="form-input" 
              id="state" 
              name="state" 
              placeholder="Maharashtra" 
              required
            >
          </div>

          <!-- Country -->
          <div class="form-field">
            <label class="form-label">
              <span class="label-icon">üåç</span>
              Country
              <span class="required">*</span>
            </label>
            <select class="form-select" id="country" name="country" required>
              <option value="">Select country</option>
              <option value="India">India</option>
              <option value="United States">United States</option>
              <option value="United Kingdom">United Kingdom</option>
              <option value="Canada">Canada</option>
              <option value="Australia">Australia</option>
            </select>
          </div>

          <!-- Delivery Notes -->
          <div class="form-field full-width">
            <label class="form-label">
              <span class="label-icon">üìù</span>
              Delivery Notes
            </label>
            <textarea 
              class="form-textarea" 
              name="notes" 
              placeholder="Landmarks, special instructions, gate code, etc."
            ></textarea>
          </div>

          <!-- Default Checkbox -->
          <div class="form-field full-width">
            <label class="checkbox-field">
              <input type="checkbox" class="form-checkbox" name="is_default" id="is_default">
              <span class="checkbox-label">‚≠ê Make this my default address</span>
            </label>
          </div>
        </div>

        <!-- Actions -->
        <div class="form-actions">
          <button type="button" class="btn" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">Save Address</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const modal = document.getElementById('addressModal');
  const form = document.getElementById('addressForm');
  const postcodeInput = document.getElementById('postcode');
  const cityInput = document.getElementById('city');
  const stateInput = document.getElementById('state');
  const countryInput = document.getElementById('country');
  const spinner = document.getElementById('postcodeSpinner');
  const errorMsg = document.getElementById('postcodeError');
  const submitBtn = document.getElementById('submitBtn');

  let debounceTimer;
  let isSubmitting = false;

  function openModal() {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    modal.classList.remove('active');
    document.body.style.overflow = '';
    form.reset();
  }

  function showNotification(message, type = 'success') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      background: ${type === 'success' ? '#10b981' : '#ef4444'};
      color: white;
      border-radius: 12px;
      font-weight: 600;
      z-index: 10000;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  function openDrawerCreate() {
    form.reset();
    errorMsg.classList.remove('active');
    spinner.classList.remove('active');
    document.getElementById('modalTitle').textContent = 'Add New Address';
    document.getElementById('modalSubtitle').textContent = 'Fill in your delivery details';
    document.getElementById('mode').value = 'create';
    document.getElementById('addr_id').value = '';
    
    // Use checkout-specific URL
    form.action = "{% url 'checkout_address_create' %}";
    
    submitBtn.textContent = 'Save Address';
    submitBtn.disabled = false;
    openModal();
  }

  window.openEdit = function(btn, event) {
    if (event) {
      event.preventDefault();
      event.stopPropagation();
      event.stopImmediatePropagation();
    }
    
    form.reset();
    errorMsg.classList.remove('active');
    spinner.classList.remove('active');
    
    document.getElementById('modalTitle').textContent = 'Edit Address';
    document.getElementById('modalSubtitle').textContent = 'Update your delivery details';
    document.getElementById('mode').value = 'edit';
    document.getElementById('addr_id').value = btn.dataset.id;
    
    // Use checkout-specific update URL
    const updateUrl = "{% url 'checkout_address_update' 0 %}".replace('/0/', '/' + btn.dataset.id + '/');
    form.action = updateUrl;
    
    // Populate fields
    document.querySelector('[name=full_name]').value = btn.dataset.name || '';
    document.querySelector('[name=phone]').value = btn.dataset.phone || '';
    document.querySelector('[name=address_line1]').value = btn.dataset.line1 || '';
    document.querySelector('[name=address_line2]').value = btn.dataset.line2 || '';
    document.querySelector('[name=notes]').value = btn.dataset.notes || '';
    postcodeInput.value = btn.dataset.postcode || '';
    cityInput.value = btn.dataset.city || '';
    stateInput.value = btn.dataset.state || '';
    countryInput.value = btn.dataset.country || '';
    document.getElementById('is_default').checked = btn.dataset.default === '1';
    
    submitBtn.textContent = 'Update Address';
    submitBtn.disabled = false;
    openModal();
  };

  // AJAX Form Submission
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (isSubmitting) return;
    isSubmitting = true;
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';
    
    const formData = new FormData(form);
    const mode = document.getElementById('mode').value;
    
    try {
      const response = await fetch(form.action, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        },
        body: formData
      });
      
      const data = await response.json();
      
      if (data.success) {
        showNotification(data.message, 'success');
        closeModal();
        
        // Reload address list dynamically
        if (mode === 'create') {
          addAddressCard(data.address);
        } else {
          updateAddressCard(data.address);
        }
        
      } else {
        // Show validation errors
        if (data.errors) {
          let errorMsg = 'Please fix the following errors:\n';
          for (let field in data.errors) {
            errorMsg += `- ${data.errors[field]}\n`;
          }
          showNotification(errorMsg, 'error');
        } else {
          showNotification(data.message || 'An error occurred', 'error');
        }
      }
      
    } catch (error) {
      console.error('Error:', error);
      showNotification('Network error. Please try again.', 'error');
    } finally {
      isSubmitting = false;
      submitBtn.disabled = false;
      submitBtn.textContent = mode === 'create' ? 'Save Address' : 'Update Address';
    }
  });

  // Add new address card to grid
  function addAddressCard(addr) {
    const grid = document.querySelector('.grid');
    const addTile = grid.querySelector('.add');
    
    const cardHTML = `
      <label class="card">
        <input class="select" type="radio" name="address_id" value="${addr.id}" ${addr.is_default ? 'checked' : ''}>
        <div class="card-head">
          <div>
            <div class="name">${addr.full_name}</div>
            <div class="sub">${addr.phone}</div>
          </div>
        </div>
        <div class="addr">
          ${addr.address_line1}${addr.address_line2 ? ', ' + addr.address_line2 : ''}<br>
          ${addr.city} ¬∑ ${addr.postcode}
        </div>
        <div class="meta">${addr.state}, ${addr.country} ${addr.is_default ? '¬∑ Default' : ''}</div>
        
        <div style="position:absolute; left:20px; bottom:20px; display:flex; gap:8px;">
          <form method="post" action="{% url 'address_delete' 0 %}".replace('/0/', '/${addr.id}/') + "?next={% url 'checkout' %}" onsubmit="return confirm('Delete this address?')">
            {% csrf_token %}
            <button type="submit" class="edit" title="Delete" onclick="event.stopPropagation();">üóë</button>
            <button type="button" class="edit" title="Edit" 
                    onclick="openEdit(this, event);"
                    data-id="${addr.id}"
                    data-name="${addr.full_name}"
                    data-phone="${addr.phone}"
                    data-line1="${addr.address_line1}"
                    data-line2="${addr.address_line2}"
                    data-city="${addr.city}"
                    data-state="${addr.state}"
                    data-postcode="${addr.postcode}"
                    data-country="${addr.country}"
                    data-notes="${addr.notes}"
                    data-default="${addr.is_default ? '1' : '0'}">‚úé</button>
          </form>
        </div>
        
        <button type="submit" class="deliver">DELIVER HERE</button>
      </label>
    `;
    
    addTile.insertAdjacentHTML('beforebegin', cardHTML);
  }

  // Update existing address card
  function updateAddressCard(addr) {
    const cards = document.querySelectorAll('.card');
    cards.forEach(card => {
      const radio = card.querySelector('input[type="radio"]');
      if (radio && radio.value == addr.id) {
        card.querySelector('.name').textContent = addr.full_name;
        card.querySelector('.sub').textContent = addr.phone;
        card.querySelector('.addr').innerHTML = `
          ${addr.address_line1}${addr.address_line2 ? ', ' + addr.address_line2 : ''}<br>
          ${addr.city} ¬∑ ${addr.postcode}
        `;
        card.querySelector('.meta').textContent = `${addr.state}, ${addr.country} ${addr.is_default ? '¬∑ Default' : ''}`;
        
        // Update edit button data
        const editBtn = card.querySelector('button[title="Edit"]');
        if (editBtn) {
          editBtn.dataset.name = addr.full_name;
          editBtn.dataset.phone = addr.phone;
          editBtn.dataset.line1 = addr.address_line1;
          editBtn.dataset.line2 = addr.address_line2;
          editBtn.dataset.city = addr.city;
          editBtn.dataset.state = addr.state;
          editBtn.dataset.postcode = addr.postcode;
          editBtn.dataset.country = addr.country;
          editBtn.dataset.notes = addr.notes;
          editBtn.dataset.default = addr.is_default ? '1' : '0';
        }
      }
    });
  }

  // Close on Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal.classList.contains('active')) {
      closeModal();
    }
  });

  // Pincode Auto-fill
  postcodeInput.addEventListener('input', function(e) {
    const pincode = e.target.value.trim();
    clearTimeout(debounceTimer);
    errorMsg.classList.remove('active');
    
    if (pincode.length === 6 && /^\d{6}$/.test(pincode)) {
      spinner.classList.add('active');
      debounceTimer = setTimeout(() => fetchPincodeData(pincode), 500);
    } else {
      spinner.classList.remove('active');
    }
  });

  async function fetchPincodeData(pincode) {
    try {
      const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
      const data = await response.json();
      spinner.classList.remove('active');
      
      if (data && data[0] && data[0].Status === 'Success' && data[0].PostOffice && data[0].PostOffice.length > 0) {
        const postOffice = data[0].PostOffice[0];
        cityInput.value = postOffice.District || postOffice.Block || '';
        stateInput.value = postOffice.State || '';
        countryInput.value = 'India';
        
        [postcodeInput, cityInput, stateInput, countryInput].forEach(input => {
          input.classList.add('success');
          setTimeout(() => input.classList.remove('success'), 600);
        });
      } else {
        errorMsg.classList.add('active');
        postcodeInput.focus();
      }
    } catch (error) {
      console.error('Error fetching pincode data:', error);
      spinner.classList.remove('active');
      errorMsg.textContent = 'Unable to fetch location';
      errorMsg.classList.add('active');
    }
  }

  // Add animation styles
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(400px); opacity: 0; }
    }
  `;
  document.head.appendChild(style);
</script>



{% endblock %}