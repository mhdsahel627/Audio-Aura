  {% extends 'user/base.html' %}
  {% load static %}

  {% block title %}Checkout - Audio Aura{% endblock %}

  {% block content %}
  <style>
    :root{
      --ink:#111;
      --muted:#6b6f75;
      --paper:#fff;
      --panel:#f2f2f4;
      --line:#e5e6ea;
      --good:#1fb774;
      --danger:#ff6b6b;
      --shadow:0 10px 24px rgba(0,0,0,.14);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{color:var(--ink); font-family:Inter,system-ui,Arial,sans-serif}

    .checkout{max-width:1240px; margin:28px auto; padding:0 16px}
    .bar{
      display:flex; align-items:center; gap:14px;
      background:var(--paper);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px 14px;
      box-shadow:var(--shadow);
    }
    .bar .icon{width:36px; height:36px; border-radius:12px; border:1px solid var(--line); display:flex; align-items:center; justify-content:center}
    .bar .title{font-size:12px; text-transform:uppercase; color:#6a6f75; font-weight:700; letter-spacing:.3px}
    .bar .addr{flex:1; font-weight:600}
    .bar .addr b{font-weight:800}
    .bar .action{height:40px; padding:0 16px; border-radius:10px; border:1px solid var(--line); background:#f8f8f9; cursor:pointer}

    .grid{display:grid; grid-template-columns: 1fr 360px; gap:24px; margin-top:18px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    /* Left column */
    .section-title{font-weight:800; margin:8px 0 10px}
    .list{display:flex; flex-direction:column; gap:16px}

    .item{
      position:relative;
      display:grid; grid-template-columns: 110px 1fr; gap:16px;
      background:var(--paper);
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:0 8px 18px rgba(0,0,0,.10);
      padding:8px 8px 8px;
    }
    .thumb{width:110px; height:110px; border-radius:12px; overflow:hidden; background:#120710}
    .thumb img{width:100%; height:100%; object-fit:cover}
    .badge{position:absolute; left:20px; bottom:12px; background:#ffc107; color:#2b1b00; font-size:11px; padding:4px 8px; border-radius:999px; font-weight:700}

    .info{display:flex; flex-direction:column; gap:6px}
    .title{font-size:18px; font-weight:800}
    .price-row{display:flex; align-items:center; gap:10px; position:relative; padding-bottom:8px; margin-bottom:8px}
    .curr{font-weight:800; font-size:18px}
    .mrp{color:#9aa0a6; text-decoration:line-through}
    .off{color:#29c08c; font-weight:800}
    .price-row::after{content:""; position:absolute; left:0; right:0; bottom:0; height:1px; background:#dadde2}

    .chips{display:flex; gap:6px; flex-wrap:wrap}
    .chip{font-size:11px; padding:4px 6px; border:1px solid #d7d9df; border-radius:999px; background:#f6f7f8; color:#555}

    /* qty dock in top-right of card */
    .dock{
      position:absolute; right:12px; top:12px; display:flex; align-items:center; gap:10px;
    }
    .qty{display:inline-flex; align-items:center; height:36px; border:1px solid #cfd3da; border-radius:8px; overflow:hidden; background:#fff}
    .step{width:36px; height:36px; display:flex; align-items:center; justify-content:center; background:#f7f8fa; border:0; cursor:pointer}
    .qty input{width:38px; height:36px; border:0; text-align:center; background:#fff; font-weight:700}
    .remove{
      position:absolute; right:12px; bottom:12px;
      height:34px; padding:0 14px; border-radius:8px; border:0; background:#000; color:#fff; font-weight:700; cursor:pointer;
    }

    /* Subtotal bar */
    .subtotal{
      display:flex; justify-content:space-between; align-items:center;
      background:#fff; border:2px solid #111; border-radius:8px; padding:12px 14px; margin-top:8px;
    }
    .subtotal .label{font-weight:800; letter-spacing:.2px}
    .subtotal .compare{color:#8a8f98; text-decoration:line-through; margin-right:10px}
    .save{color:#19C09F; font-size:12px; margin-top:4px; text-align:right}

    .note{color:#8b8f95; text-align:center; font-size:12px; margin-top:54px }

    .primary{
    border: 1px solid #8c898d;
    display: block;
    width: 320px;
    max-width: 100%;
    margin: 8px auto 0;
    background: #000;
    color: #fff;
    /* border: 0; */
    height: 40px;
    border-radius: 6px;
    font-weight: 800;
    }

    /* Right: Price details */
  .summary-card.checkout-summary{
    position: sticky; top:16px;
    background:#fff;
    border:1px solid var(--line);
    border-radius:16px;
    padding:18px;
    height:fit-content;
    box-shadow:var(--shadow);
  }
  .summary-card.checkout-summary h3{
    margin:0 0 12px;
    font-size:16px;
    letter-spacing:.5px;
    color:#000;
  }
  .summary-card.checkout-summary .summary-row{
    display:flex; justify-content:space-between; margin:12px 0; color:#000;
  }
  .summary-card.checkout-summary .summary-row span:first-child{ color:#000; }
  .summary-card.checkout-summary .good{ color:var(--good); }
  .summary-card.checkout-summary .divider{ border:0; border-top:1px solid var(--line); margin:12px 0; }
  .summary-card.checkout-summary .summary-total{
    display:flex; justify-content:space-between; align-items:center;
    font-weight:800; color:#000; font-size:18px;
  }
  .summary-card.checkout-summary .total{ font-size:20px; }
  .summary-card.checkout-summary .save-note{
    background:#102a1d; color:#8ef0bd; border:1px solid #1a4c36;
    padding:10px 12px; border-radius:10px; margin:14px 0; font-weight:600;
  }
  .summary-card.checkout-summary .secure{
    display:flex; gap:10px; align-items:center; margin-top:8px;
  }
  .summary-card.checkout-summary .shield{
    background:#2a1a30; border:1px solid #3c2a46; color:#8be1ae;
    width:26px; height:26px; display:inline-flex; align-items:center; justify-content:center; border-radius:999px;
  }
  .summary-card.checkout-summary .secure-text p{
    margin:0; color:#000; font-size:13px;
  }

    .sum-title{font-size:12px; font-weight:800; color:#636b6f; margin:0 0 10px}
    .row{display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eceff3}
    .row:last-child{border-bottom:0}
    .label{color:#6b6f75}
    .total{font-weight:900}
    .save-note{margin-top:10px; background:#0f361f; color:#8ef0bd; border:1px solid #1b5333; padding:10px; border-radius:10px; font-weight:700}
  .bar .action.missing {
    text-decoration: none;
      background: #111;
      color: #fff;
      border-color: #111;
      padding: 6px 15px 6px 15px;
  }
  .bar .action {
      height: 40px;
      padding: 7px 15px 7px 15px;
      border-radius: 10px;
      border: 1px solid var(--line);
      color: white;
      background: #000000;
      cursor: pointer;
      text-decoration: none;
  }
  .coupon-card-modern {
      background: #EFF3F5;
      border-radius: 18px;
      border: 1.5px solid #e3e8ed;
      padding: 15px 8px 3px 9px;
      margin-bottom: 20px;
      width: 361px;
      max-width: 400px;
      box-sizing: border-box;
  }

  .coupon-row {
    display: flex;
    align-items: center;
    gap: 13px;
  }

  .coupon-card-icn {
      width: 13px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 0px;
      margin-left: 19px;
  }

  .coupon-title-modern {
      font-size: 13px;

      font-weight: 700;
      color: #262b32;
      flex: 1 1 auto;
      margin-left: 2px;
  }

  .coupon-apply-modern {
  background: #181b1e;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 7px 32px;
      /* font-size: 1.19rem; */
      font-weight: 700;
      cursor: pointer;
      outline: none;
      margin: 0px 7px -24px 0px;
      transition: background 0.13s;
  }
  .coupon-apply-modern:hover {
    background: #232526;
  }

  .coupon-code-row {
      margin: 0px 0 5px 52px;
      font-size: 10px;
      /* font-size: 1.08rem; */
      font-weight: 600;
      display: flex
  ;
      align-items: center;
      gap: 7px;
  }

  .coupon-code-label-modern {
    color: #556;
    font-size: 14px;
    font-weight: 600;
  }
  .coupon-code-modern {
      font-size: 15px;
      color: #253858;
      font-weight: 800;
      letter-spacing: .7px;

  }

  .coupon-divider-modern {
      border: none;
      border-bottom: 1.3px solid #a1a5b5;
      margin: 22px 0 10px 0;
  }

  .coupon-viewall-modern {
      display: block;
      text-align: center;
      /* font-size: 1.18rem; */
      color: #181b1e;
      font-weight: 700;
      letter-spacing: 0.4px;
      text-decoration: none;
      margin-bottom: 7px;
      margin-top: 0;
      transition: color .15s;
  }
  .coupon-viewall-modern:hover {
    color: #8e44ad;
  }

  .cart-coupon-modal-bg {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(60,48,80,.18); z-index: 3000;
    display: flex; justify-content: flex-end; align-items: stretch;
  }
  .cart-coupon-modal-slide {
    background: #fff;
    max-width: 470px; width: 100vw; height: 100%;
    overflow-y: auto; box-shadow: -2px 0 18px 0 #412d48a2;
    position: relative; animation: cartCouponSlideIn .32s cubic-bezier(.45,1.3,.53,.97) 1;
  }
  @keyframes cartCouponSlideIn {
    from { transform: translateX(110%); opacity: 0; }
    to   { transform: translateX(0); opacity: 1; }
  }
  .cart-coupon-panel {
    border-radius: 18px 0 0 18px;
    box-shadow: 0 4px 36px 0 #3a096b0e, 0 1.5px 2.5px 0 #cad0e4;
    background: #f7f9fc;
    min-height: 100vh;
    width: 470px;
    max-width: 100vw;
    display: flex;
    flex-direction: column;
    margin-right: 0;
    position: relative;
  }
  .cart-coupon-header {
    display: flex; align-items: center; gap: .7rem;
    font-size: 1.18rem; font-weight: 800; color: #212442;
    background: #fff; padding: 18px 18px 0 17px;
    border-radius: 18px 0 0 0;
  }
  .cart-coupon-back-btn, .cart-coupon-close-btn {
    border: none; background: none; cursor: pointer;
  }
  .cart-coupon-back-btn {
    color: #8e44ad; font-size: 1.48rem; font-weight: bold; line-height: 1;
  }
  .cart-coupon-header span { flex: 1; text-align: left; }
  .cart-coupon-close-btn { color: #ca62d7; font-size: 2rem; line-height: 1; }
  .cart-coupon-container { padding: 17px 15px 0 15px; }
  /* Input/top controls */
  .cart-coupon-input-row {
      display: flex
  ;
      background: #eff3f5;
      border-radius: 30px;
      box-shadow: 0 4px 4px #c4c4c426;  
      border: solid 1px #d6dee2;
      align-items: center;
      padding: 10px 12px;
      margin-bottom: 15px;
      margin-top: 16px;
      gap: 5px;
  }
  .cart-coupon-code-input {
    border: none; background: transparent;
    font-size: 1.13rem; flex-grow: 1; padding: 8px 0 8px 7px;
    outline: none;
  }
  .cart-coupon-apply-btn {
    background: #f6c7f1; color: #73297b; font-weight: 700;
    border: none; border-radius: 12px; font-size: 1.09rem;
    padding: 10px 24px; transition: background .13s;
  }
  .cart-coupon-apply-btn:hover { background: #e8b1e9; }
  .cart-coupon-tabs {
    display: flex; gap: 8px; margin-bottom: 16px; margin-top: 5px;
  }
  .cart-coupon-tab-btn {
    background: #f7f9fc; border: 1.3px solid #e0e4eb; border-radius: 7px;
    color: #818181; font-weight: 600; font-size: 1.01rem; cursor: pointer;
    padding: 6px 16px;
    transition: border .12s, background .12s, color .13s;
  }
  .cart-coupon-tab-btn.active {
    border: 1.6px solid #277ddf; color: #000; background: #f8fcff;
  }
  .cart-coupon-tab-btn:disabled {
    color: #babec4; background: #f7f9fc; cursor: default;
  }
  .cart-coupon-list { margin-top: 7px; padding-bottom: 40px; }
  /* Cards */
  .cart-coupon-card {
    display: flex; align-items: flex-start; background: #fff;
    border: 1.2px solid #e3e8ed; border-radius: 13px;
    margin-bottom: 17px; padding: 16px; flex-wrap: wrap;
    box-shadow: 0 3px 11px 0 #ededed7a; position: relative;
    min-height: 120px; padding-bottom: 46px; transition: box-shadow .17s;
  }
  .cart-coupon-card:not(.applied):hover {
    box-shadow: 0 8px 36px 0 #3a096b23;
  }
  .cart-coupon-left {
    flex-shrink: 0; margin-right: 14px;
  }
  .cart-coupon-img {
    width: 38px; height: 38px; object-fit: contain;
  }
  .cart-coupon-main { flex-grow: 1; min-width: 0; }
  .cart-coupon-title {
    font-weight: 700; font-size: 1.11rem;
    margin-bottom: 6px; color: #18192b;
  }
  .cart-coupon-code-row {
      font-size: 0.97rem;
      color: #323655;
      margin-bottom: 8px;
      padding-bottom: 10px;
      display: flex;
      border-bottom: 1px dashed #D6DBDE;
      align-items: center;
      gap: 7px;
  }
  .cart-coupon-code-label {
    color: #8e92a3; font-weight: 500; font-size: 0.94em; margin-right: 3px;
  }
  .cart-coupon-code-value {
    font-weight: 700; color: black; letter-spacing: 0.02em; margin-right: 8px;
  }
  .cart-coupon-view-products {
    margin-left: auto; color: #3085d6; font-weight: 600; text-decoration: none; font-size: 0.99em;
  }
  .cart-coupon-desc {
    font-size: 0.96em; color: #3d3e4f; margin-bottom: 4px;
  }
  .cart-coupon-cta {
    width: 100%; text-align: center; background: #f1f4f7;
    border-radius: 0 0 12px 12px; padding: 12px 0 12px 0;
    color: #5683ad; font-weight: 600; font-size: 1.09em;
    position: absolute; left: 0; right: 0; bottom: 0;
    border-top: 1px solid #e7ebef; transition: background .13s, color .14s;
  }
  .cart-coupon-card:not(.applied):hover .cart-coupon-cta {
    background: #277ddb19; color: #277ddf; cursor: pointer;
  }
  .cart-coupon-card.applied .cart-coupon-cta {
    background: #eaf2f8; color: #a6b3c3; cursor: not-allowed;
  }

    #toast {
      position: fixed;
      left: 50%;
      top: 20px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.92);
      color: #fff;
      padding: 10px 14px;
      border-radius: 38px;
      font-weight: 600;
      font-size: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 9999;
    }
    #toast.show {
      opacity: 1;
      pointer-events: auto;
    }

  .btn-dark {
      background: rgb(0, 0, 0);
      color: #fff;
      border: 1px solid var(--danger);
      height: 40px;
      padding: 8px 17px 8px 17px;
      border-radius: 8px;
      margin-bottom: 30px;
  }

  </style>

  <!-- Toast Element - ADD THIS -->
  <div id="toast"></div>

  <section class="checkout">
    <a href="{% url 'cancel_checkout' %}" class="btn btn-dark">Cancel</a>

    <!-- Address bar -->
    <div class="bar">
      <div class="icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-geo-alt" viewBox="0 0 16 16">
          <path d="M12.166 8.94c-.524 1.062-1.234 2.12-1.96 3.07A32 32 0 0 1 8 14.58a32 32 0 0 1-2.206-2.57c-.726-.95-1.436-2.008-1.96-3.07C3.304 7.867 3 6.862 3 6a5 5 0 0 1 10 0c0 .862-.305 1.867-.834 2.94M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10"/>
          <path d="M8 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4m0 1a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/>
        </svg>
      </div>
      <div class="title">Delivery Address</div>
      <div class="addr">
        {% if address %}
          <b>{{ address.full_name|default:request.user.get_full_name|default:request.user.username }}</b>
          {{ address.line1 }}{% if address.line2 %}, {{ address.line2 }}{% endif %},
          {{ address.city|default:"" }}{% if address.state %}, {{ address.state }}{% endif %}
          {% if address.postcode %} - <b>{{ address.postcode }}</b>{% endif %}
          {% if address.phone %} ¬∑ {{ address.phone }}{% endif %}
        {% else %}
          <span>No default address set.</span>
        {% endif %}
      </div>
      {% if address %}
        <a class="action" href="{% url 'address_check' %}">CHANGE</a>
      {% else %}
        <a class="action missing" href="{% url 'address_check' %}">ADD ADDRESS</a>
      {% endif %}
    </div>

    <div class="grid">
      <!-- Left: items -->
      <div>
        <h3 class="section-title">Order Summary</h3>
        <div class="list">
          {% for it in items %}
          <article class="item" data-product-id="{{ it.id }}">
            <div class="dock">
              <div class="qty">
                <button class="step js-dec">‚àí</button>
                {% if is_buy_now %}
                  <!-- Buy Now: single input synced to session -->
                  <input type="number" id="buyNowQtyInput"  value="{{ buy_now_qty }}" min="1" 
                    max="{{ buy_now_max_qty|default:10 }}" 
                    class="qty-input buy-now-qty" 
                    data-product-id="{{ it.id }}"
                    data-variant-id="{{ it.variant_id }}"
                  />
                {% else %}
                  <!-- Cart: normal cart quantity -->
                  <input 
                    type="number" 
                    value="{{ it.qty }}" 
                    min="1" 
                    max="{{ it.max_qty }}" 
                    class="qty-input" 
                    data-max="{{ it.max_qty }}"
                    data-product-id="{{ it.id }}"
                    data-variant-id="{{ it.variant_id }}"
                  />
                {% endif %}
                <button class="step js-inc">+</button>
              </div>
            </div>
            <div class="thumb">
              <img src="{% if it.image %}{{ it.image }}{% else %}{% static 'images/logo.png' %}{% endif %}" alt="{{ it.name }}">
            </div>
            <div class="info">
              <div class="title">{{ it.name }}</div>
              <div class="price-row">
                <span class="curr">‚Çπ<span class="js-line-sell" data-unit="{{ it.unit_sell }}">{{ it.line_sell }}</span></span>
                <span class="mrp">‚Çπ<span class="js-line-mrp" data-unit="{{ it.unit_mrp }}">{{ it.line_mrp }}</span></span>
                {% if it.discount_percent %}<span class="off">{{ it.discount_percent }}% off</span>{% endif %}
              </div>
              <div class="chips">
                {% if it.offer %}<span class="chip">{{ it.offer }}</span>{% endif %}
                <span class="chip">Signature Sound</span>
              </div>
            </div>
            <form class="js-qty-form" method="post" action="{% url 'cart_update_qty' %}" hidden>
              {% csrf_token %}
              <input type="hidden" name="product_id" value="{{ it.id }}">
              <input type="hidden" name="variant_id" value="{{ it.variant_id }}">
              <input type="hidden" name="qty" value="{{ it.qty }}">
            </form>
            <form class="js-remove-form" method="post" action="{% url 'cart_remove' %}">
              {% csrf_token %}
              <input type="hidden" name="product_id" value="{{ it.id }}">
              <input type="hidden" name="variant_id" value="{{ it.variant_id }}">
              <button class="remove" type="submit">Remove</button>
            </form>

          </article>
          {% endfor %}
        </div>

        <div class="save">Save ‚Çπ<span id="jsSaveLeft">{{ save_note }}</span></div>

        <!-- subtotal -->
        <div class="subtotal">
          <div class="label">SUBTOTAL</div>
          <div>
            <span class="compare">INR <span id="jsSubMrp">{{ subtotal_mrp }}</span></span>
            <span>INR <span id="jsSubSell">{{ subtotal_sell|floatformat:0 }}</span></span>
          </div>
        </div>
        <p class="note">MRP Include Taxes, and discount coupons calculated at checkout.</p>

        <a href="{% if address %}{% url 'payment' %}{% else %}{% url 'address' %}{% endif %}" style="text-decoration: none;">
          <button class="primary" type="button" {% if not address %}disabled style="opacity:.6;cursor:not-allowed"{% endif %}>
            CONTINUE
          </button>
        </a>
        {% if not address %}
          <p class="note">Add a delivery address to continue.</p>
        {% endif %}
      </div>

      <!-- Right: price details -->
      <div style="display:flex; flex-direction:column; gap:0px;">
        <!-- ‚úÖ FIXED: Dynamic Coupon Card -->
        <div class="coupon-card-modern">
          {% if applied_coupon %}
          <!-- Applied Coupon Display -->
          <div class="coupon-row">
            <span class="coupon-card-icn">
              <img src="{% static 'images/discount.png' %}" alt="" style="width: 22px; height:22px">
            </span>
            <span class="coupon-title-modern">{{ applied_coupon.title }}</span>
            <button class="coupon-apply-modern" onclick="removeCoupon()" style="background:#ff6b6b;">Remove</button>
          </div>
          <div class="coupon-code-row">
            <span class="coupon-code-label-modern">Code:</span>
            <span class="coupon-code-modern">{{ applied_coupon.code }}</span>
          </div>
          <div style="margin: 10px 0 5px 52px; font-size: 13px; color: #25d366; font-weight: 600;">
            ‚úì You're saving ‚Çπ{{ coupon_discount|floatformat:0 }} with this coupon!
          </div>
          {% else %}
          <!-- No Coupon Applied -->
          {% if coupons.0 %}
          <div class="coupon-row">
            <span class="coupon-card-icn">
              <img src="{% static 'images/discount.png' %}" alt="" style="width: 22px; height:22px">
            </span>
            <span class="coupon-title-modern">{{ coupons.0.title }}</span>
            <button class="coupon-apply-modern" onclick="applyCoupon('{{ coupons.0.code }}')">Apply</button>
          </div>
          <div class="coupon-code-row">
            <span class="coupon-code-label-modern">Code:</span>
            <span class="coupon-code-modern">{{ coupons.0.code }}</span>
          </div>
          {% else %}
          <div class="coupon-row">
            <span class="coupon-card-icn">
              <img src="{% static 'images/discount.png' %}" alt="" style="width: 22px; height:22px">
            </span>
            <span class="coupon-title-modern">No active coupons available</span>
          </div>
          {% endif %}
          {% endif %}
          
          <hr class="coupon-divider-modern" />
          <a href="#" class="coupon-viewall-modern" onclick="showCartCouponModal(); return false;">View all coupons &rarr;</a>
        </div>

        <aside class="summary-card checkout-summary">
          <h3>PRICE DETAILS</h3>

          <div class="summary-row">
            <span>Price (<span id="coProducts">{{ products_count }}</span> products)</span>
            <span>‚Çπ<span id="coMrp">{{ subtotal_mrp }}</span></span>
          </div>

          <div class="summary-row">
            <span>Discount</span>
            <span class="good">‚àí ‚Çπ<span id="coDiscount">{{ discount|floatformat:0 }}</span></span>
          </div>

          <!-- ‚úÖ ADDED: Coupon Discount Row -->
          <div class="summary-row">
            <span>Coupon Discount</span>
            <span class="good" id="jsCouponDiscount">‚àí ‚Çπ{{ coupon_discount|floatformat:0 }}</span>
          </div>

          <hr class="divider">

          <div class="summary-total">
            <span>Total Amount</span>
            <span class="total">‚Çπ<span id="coTotal">{{ total_payable|floatformat:0 }}</span></span>
          </div>

          <p class="save-note">You will save ‚Çπ<span id="coSave">{{ save_note }}</span> on this order</p>

          <div class="secure">
            <span class="shield">‚úì</span>
            <div class="secure-text">
              <p>Safe and Secure Payments. Easy returns. 100% Authentic products.</p>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </section>



  <!-- ‚úÖ FIXED: Dynamic Coupon Modal -->
  <div id="cartCouponModal" class="cart-coupon-modal-bg" style="display:none;">
    <div class="cart-coupon-modal-slide">
      <div class="cart-coupon-panel">
        <div class="cart-coupon-header">
          <button class="cart-coupon-back-btn" onclick="hideCartCouponModal()" aria-label="Close">&larr;</button>
          <span>Offers for you</span>
          <button class="cart-coupon-close-btn" onclick="hideCartCouponModal()" aria-label="Close">&times;</button>
        </div>

        <div class="cart-coupon-container">
          <div class="cart-coupon-input-row">
            <input class="cart-coupon-code-input" type="text" placeholder="Type coupon code here" />
            <button class="cart-coupon-apply-btn">APPLY</button>
          </div>
          <div class="cart-coupon-tabs">
            <button class="cart-coupon-tab-btn active">All</button>
            <button class="cart-coupon-tab-btn" disabled>Best Offers</button>
            <button class="cart-coupon-tab-btn" disabled>Bank Offers</button>
          </div>
          
          <!-- ‚úÖ FIXED: Dynamic Coupon List -->
          <div class="cart-coupon-list">
            {% for coupon in coupons %}
            <div class="cart-coupon-card">
              <div class="cart-coupon-left">
                <img class="cart-coupon-img" src="{% static 'images/discount.png' %}" />
              </div>
              <div class="cart-coupon-main">
                <div class="cart-coupon-title">{{ coupon.title }}</div>
                <div class="cart-coupon-code-row">
                  <span class="cart-coupon-code-label">Use Code:</span>
                  <span class="cart-coupon-code-value">{{ coupon.code }}</span>
                </div>
                <div class="cart-coupon-desc">{{ coupon.description }}</div>
                {% if coupon.min_purchase > 0 %}
                <div class="cart-coupon-condition" style="font-size:0.9em; color:#666; margin-top:4px;margin-bottom:14px;">
                  Min purchase: ‚Çπ{{ coupon.min_purchase|floatformat:0 }}
                </div>
                {% endif %}
              </div>
              <div class="cart-coupon-cta" onclick="applyCoupon('{{ coupon.code }}')">Tap To Apply</div>
            </div>
            {% empty %}
            <div style="padding:20px; text-align:center; color:#666;">
              No active coupons available right now.
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

    <!-- ‚úÖ COMPLETE FIXED JAVASCRIPT -->
<script>
(function(){
  // ========== UTILITY ==========
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  
  function fmt(n) { 
    try { return new Intl.NumberFormat('en-IN').format(n); } 
    catch(e) { return n; } 
  }
  
  function showToast(msg) {
    const t = document.getElementById('toast');
    if (t) {
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    } else {
      alert(msg);
    }
  }

  // ========== COUPON FUNCTIONS ==========
  window.applyCoupon = function(code) {
    const csrftoken = getCookie('csrftoken');
    if (!code) { showToast('‚ùå Please enter a coupon code'); return; }
    
    showToast('‚è≥ Applying coupon...');
    
    fetch('{% url "apply_coupon" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: new URLSearchParams({ coupon_code: code.toUpperCase() })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        showToast(`‚úì ${data.message}`);
        setTimeout(() => location.reload(), 1000);
      } else {
        showToast(`‚ùå ${data.message}`);
      }
    })
    .catch(e => {
      console.error('Coupon error:', e);
      showToast('‚ùå Failed to apply coupon');
    });
  };

  window.removeCoupon = function() {
    const csrftoken = getCookie('csrftoken');
    showToast('‚è≥ Removing coupon...');
    
    fetch('{% url "remove_coupon" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        showToast(`‚úì ${data.message}`);
        setTimeout(() => location.reload(), 1000);
      }
    })
    .catch(e => console.error('Remove coupon error:', e));
  };

  // ========== QTY & REMOVE HANDLERS ==========
  function bindCartHandlers() {
    const csrftoken = getCookie('csrftoken');

    document.querySelectorAll('.item').forEach(card => {
      const dec = card.querySelector('.js-dec');
      const inc = card.querySelector('.js-inc');
      const qtyInput = card.querySelector('.qty-input:not(.buy-now-qty)');
      const qtyForm = card.querySelector('.js-qty-form');
      const remForm = card.querySelector('.js-remove-form');
      const productName = card.querySelector('.title')?.textContent?.trim() || 'Item';

      if (!qtyInput) return;

      async function syncServer(newQty) {
        if (!qtyForm) return;
        
        const fd = new FormData(qtyForm);
        fd.set('qty', newQty);
        
        try {
          const res = await fetch('{% url "cart_update_qty" %}', {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrftoken,
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: fd
          });
          const data = await res.json();

          // ‚úÖ Check if coupon removed
          if (data.coupon_removed && data.coupon_message) {
            showToast('‚ùå ' + data.coupon_message);
            setTimeout(() => location.reload(), 2000);
            return;
          }

          // ‚úÖ Update all UI elements
          const updateEl = (id, val) => {
            const el = document.getElementById(id);
            if (el && val !== undefined) {
              el.textContent = fmt(Math.round(parseFloat(val) || 0));
            }
          };

          if (data.summary) {
            // Calculate discount
            if (data.summary.subtotal_mrp && data.summary.subtotal_sell) {
              const discount = parseFloat(data.summary.subtotal_mrp) - parseFloat(data.summary.subtotal_sell);
              updateEl('coDiscount', discount);
            }
            
            // Update summary panel
            updateEl('coMrp', data.summary.subtotal_mrp || data.summary.subtotal);
            updateEl('jsCouponDiscount', data.summary.coupon_amount || 0);
            updateEl('coTotal', data.summary.grand_total);
            
            // Update subtotal bar
            updateEl('jsSubSell', data.summary.subtotal_sell || data.summary.subtotal);
            updateEl('jsSubMrp', data.summary.subtotal_mrp || data.summary.subtotal);
            
            // Update save note
            if (data.summary.subtotal_mrp && data.summary.grand_total) {
              const saveNote = parseFloat(data.summary.subtotal_mrp) - parseFloat(data.summary.grand_total);
              updateEl('jsSaveLeft', saveNote);
              updateEl('coSave', saveNote);
            }
            
            // Update per-line prices
            if (data.summary.items && Array.isArray(data.summary.items)) {
              data.summary.items.forEach(function(item) {
                const itemCard = document.querySelector('.item[data-product-id="' + item.id + '"]');
                if (itemCard) {
                  const lineSell = itemCard.querySelector('.js-line-sell');
                  const lineMrp = itemCard.querySelector('.js-line-mrp');
                  
                  if (lineSell && item.line_sell !== undefined) {
                    lineSell.textContent = fmt(Math.round(item.line_sell));
                  }
                  if (lineMrp && item.line_mrp !== undefined) {
                    lineMrp.textContent = fmt(Math.round(item.line_mrp));
                  }
                }
              });
            }
          }
        } catch (e) {
          console.error('Error syncing server:', e);
        }
      }

      function setQty(newQty) {
        const maxQty = parseInt(qtyInput.dataset.max || qtyInput.max || '10', 10);
        if (newQty < 1) newQty = 1;
        if (newQty > maxQty) {
          newQty = maxQty;
          showToast(`ü•≤ Only ${maxQty} unit${maxQty > 1 ? 's' : ''} allowed`);
        } else {
          showToast(`üî• ${productName}: quantity updated to ${newQty}`);
        }
        qtyInput.value = newQty;
        syncServer(newQty);
      }

      inc?.addEventListener('click', () => {
        const cur = parseInt(qtyInput.value, 10) || 1;
        setQty(cur + 1);
      });

      dec?.addEventListener('click', () => {
        const cur = parseInt(qtyInput.value, 10) || 1;
        setQty(cur - 1);
      });

      // ‚úÖ FIXED: Remove handler - Always reload
      remForm?.addEventListener('submit', async e => {
        e.preventDefault();
        
        showToast('‚è≥ Removing item...');
        
        try {
          const res = await fetch(remForm.action, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrftoken,
              'X-Requested-With': 'XMLHttpRequest',
            },
            body: new FormData(remForm)
          });
          const data = await res.json();
          
          if (!res.ok || !data?.ok) throw new Error('Remove failed');
          
          // ‚úÖ ALWAYS RELOAD - This fixes your issue!
          showToast('‚úì Item removed');
          setTimeout(() => location.reload(), 500);
          
        } catch (err) {
          console.error(err);
          remForm.submit(); // fallback
        }
      });
    });
  }

  // ========== BUY NOW QTY HANDLER ==========
  function bindBuyNowHandler() {
    const buyNowInput = document.getElementById('buyNowQtyInput');
    if (!buyNowInput) return;
    
    const csrftoken = getCookie('csrftoken');
    const incBtn = buyNowInput.closest('.qty')?.querySelector('.js-inc');
    const decBtn = buyNowInput.closest('.qty')?.querySelector('.js-dec');
    let updating = false;

    function updateBuyNowQty(newQty) {
      const maxQty = parseInt(buyNowInput.max || '10', 10);
      if (newQty < 1) newQty = 1;
      if (newQty > maxQty) {
        newQty = maxQty;
        showToast(`Only ${maxQty} units available`);
      }

      updating = true;
      const fd = new FormData();
      fd.append('quantity', newQty);

      fetch("{% url 'buy_now_update_qty' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: fd
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          buyNowInput.value = data.qty;
          
          // Update UI
          if (data.subtotal_sell) document.getElementById('jsSubSell').textContent = fmt(data.subtotal_sell);
          if (data.subtotal_mrp) document.getElementById('jsSubMrp').textContent = fmt(data.subtotal_mrp);
          if (data.discount) document.getElementById('coDiscount').textContent = fmt(data.discount);
          if (data.coupon_discount) document.getElementById('jsCouponDiscount').textContent = fmt(data.coupon_discount);
          if (data.total_payable) document.getElementById('coTotal').textContent = fmt(data.total_payable);
          if (data.save_note) {
            document.getElementById('jsSaveLeft').textContent = fmt(data.save_note);
            document.getElementById('coSave').textContent = fmt(data.save_note);
          }
          
          const lineSell = document.querySelector('.js-line-sell');
          const lineMrp = document.querySelector('.js-line-mrp');
          if (lineSell && data.subtotal_sell) lineSell.textContent = fmt(data.subtotal_sell);
          if (lineMrp && data.subtotal_mrp) lineMrp.textContent = fmt(data.subtotal_mrp);
        }
        updating = false;
      })
      .catch(err => {
        console.error('Buy now update failed:', err);
        updating = false;
      });
    }

    incBtn?.addEventListener('click', () => {
      if (updating) return;
      const cur = parseInt(buyNowInput.value, 10) || 1;
      updateBuyNowQty(cur + 1);
    });
    
    decBtn?.addEventListener('click', () => {
      if (updating) return;
      const cur = parseInt(buyNowInput.value, 10) || 1;
      updateBuyNowQty(cur - 1);
    });
  }

  // ========== COUPON MODAL ==========
  window.showCartCouponModal = function() {
    document.getElementById('cartCouponModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  };

  window.hideCartCouponModal = function() {
    document.getElementById('cartCouponModal').style.display = 'none';
    document.body.style.overflow = '';
  };

  // ========== INITIALIZATION ==========
  document.addEventListener('DOMContentLoaded', () => {
    console.log('Checkout page initialized');
    bindCartHandlers();
    bindBuyNowHandler();
    
    // Modal click outside to close
    const modal = document.getElementById('cartCouponModal');
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === this) hideCartCouponModal();
      });
    }
    
    // Slider apply button
    const sliderApplyBtn = document.querySelector('.cart-coupon-apply-btn');
    if (sliderApplyBtn) {
      sliderApplyBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const input = document.querySelector('.cart-coupon-code-input');
        if (input && input.value.trim()) {
          applyCoupon(input.value.trim());
        } else {
          showToast('‚ùå Please enter a coupon code');
        }
      });
    }
  });
})();
</script>


  {% endblock %}
