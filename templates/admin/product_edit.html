{% extends 'admin/admin-base.html' %}
{% load static %}

{% block title %}Edit Product - Admin{% endblock %}

{% block content %}
<style>
  /* Enhanced Styles */
  .product-form {
    width: 100%;
    max-width: 1140px;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 2rem;
    margin: 0 auto 1.5rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  .modal-backdrop {
    position: absolute !important;
    top: -9999999px !important;
  }

  .section-header {
    font-size: 1.4rem;
    font-weight: 700;
    color: #a855f7;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid rgba(168, 85, 247, 0.3);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .form-control {
    background: #000 !important;
    border: 2px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 10px !important;
    color: #fff !important;
    padding: 0.75rem 1rem !important;
    transition: all 0.3s ease !important;
    font-size: 1rem !important;
  }

  .form-control:focus {
    border-color: #a855f7 !important;
    box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.2) !important;
    background: #0a0a0a !important;
  }

  .form-control.is-invalid {
    border-color: #ef4444 !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
  }

  .form-label {
    font-weight: 600;
    color: #e0e0e0;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
  }

  .required-star {
    color: #ef4444;
    font-weight: 700;
  }

  .form-text {
    margin-top: 0.25rem;
    font-size: 0.85em;
    color: rgba(186, 198, 210, 0.75);
  }

  .invalid-feedback {
    display: block !important;
    color: #ef4444 !important;
    font-size: 0.875rem !important;
    margin-top: 0.5rem !important;
    font-weight: 600 !important;
    animation: fadeInUp 0.3s ease !important;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .image-upload {
    border: 2px dashed #666;
    border-radius: 12px;
    padding: 40px 20px;
    text-align: center;
    background: #1e1e1e;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 150px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .image-upload:hover {
    border-color: #a855f7;
    background: #2a1a3a;
  }

  .image-upload.highlight {
    border-color: #a855f7;
    background: #2a1a3a;
  }

  .image-upload[tabindex="0"]:focus {
    outline: 2px solid #a855f7;
    outline-offset: 2px;
  }

  .upload-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: #a855f7;
  }

  .variant-card {
    border: 2px solid rgba(168, 85, 247, 0.3);
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    background: rgba(168, 85, 247, 0.05);
    color: #fff;
    transition: all 0.3s ease;
  }

  .variant-card:hover {
    border-color: rgba(168, 85, 247, 0.5);
    box-shadow: 0 4px 16px rgba(168, 85, 247, 0.2);
  }

  .variant-card.removing {
    opacity: 0.4;
    pointer-events: none;
  }

  .variant-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .preview-img {
    display: block;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }

  .image-item {
    position: relative;
    display: inline-block;
    margin: 0.5rem;
  }

  .image-item img {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid rgba(255, 255, 255, 0.1);
  }

  .image-item.removing {
    opacity: 0.4;
  }

  .remove-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    cursor: pointer;
    font-size: 1.2rem;
    line-height: 1;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }

  .remove-btn:hover {
    background: #dc2626;
    transform: scale(1.1);
  }

  .btn {
    padding: 0.75rem 1.5rem !important;
    border-radius: 10px !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
  }

  .btn-primary {
    background: linear-gradient(135deg, #a855f7, #9333ea) !important;
    border: none !important;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #9333ea, #7e22ce) !important;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(168, 85, 247, 0.4) !important;
  }

  .btn-success {
    background: linear-gradient(135deg, #10b981, #059669) !important;
    border: none !important;
  }

  .btn-success:hover {
    background: linear-gradient(135deg, #059669, #047857) !important;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4) !important;
  }

  .btn-outline-danger {
    border-color: #ef4444 !important;
    color: #ef4444 !important;
  }

  .btn-outline-danger:hover {
    background: #ef4444 !important;
    color: white !important;
  }

  .page-header {
    background: rgba(168, 85, 247, 0.1);
    border: 1px solid rgba(168, 85, 247, 0.3);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .page-header h2 {
    color: #a855f7;
    font-weight: 700;
    margin: 0;
    font-size: 2rem;
  }

  .alert {
    border-radius: 12px !important;
    border: none !important;
    animation: slideInDown 0.3s ease !important;
  }

  @keyframes slideInDown {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .input-group .btn {
    border-radius: 0 10px 10px 0 !important;
  }

  .input-group .form-control {
    border-radius: 10px 0 0 10px !important;
  }
</style>

<div class="container py-4">
  <!-- Alert Container -->
  <div id="error-alert" class="alert alert-danger d-none" role="alert"></div>

  <!-- Page Header -->
  <div class="page-header">
    <h2>‚úèÔ∏è Edit Product</h2>
  </div>

  <!-- Messages -->
  {% if messages %}
  <div class="mb-3">
    {% for m in messages %}
    <div class="alert alert-{% if m.tags == 'error' %}danger{% else %}{{ m.tags }}{% endif %} alert-dismissible fade show" role="alert">
      {{ m }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Product Form -->
  <form method="POST" enctype="multipart/form-data" class="product-form" id="product-form">
    {% csrf_token %}

    <!-- Basic Information -->
    <h5 class="section-header">üìù Basic Information</h5>
    
    <div class="mb-3">
      <label for="name" class="form-label">
        Product Name <span class="required-star">*</span>
      </label>
      <input 
        type="text" 
        id="name" 
        name="name"
        class="form-control {% if errors.name %}is-invalid{% endif %}"
        value="{{ product.name }}" 
        required
        maxlength="200"
      >
      <div class="form-text">Enter the product name (3-200 characters, letters, numbers, spaces, hyphens, underscores only)</div>
      {% if errors.name %}
      <div class="invalid-feedback">{{ errors.name }}</div>
      {% endif %}
    </div>

    <div class="mb-3">
      <label for="short_desc" class="form-label">Short Description</label>
      <input 
        type="text" 
        id="short_desc" 
        name="short_desc" 
        class="form-control" 
        value="{{ product.short_description|default:'' }}" 
        placeholder="Brief description"
        maxlength="255"
      >
    </div>

    <div class="mb-3">
      <label for="long_desc" class="form-label">Long Description</label>
      <textarea 
        id="long_desc" 
        name="long_desc" 
        class="form-control {% if errors.long_desc %}is-invalid{% endif %}" 
        rows="4" 
        placeholder="Detailed description"
        maxlength="2000"
      >{{ product.long_description|default:'' }}</textarea>
      <div class="form-text">Min 10 characters if provided</div>
      {% if errors.long_desc %}
      <div class="invalid-feedback">{{ errors.long_desc }}</div>
      {% endif %}
    </div>

    <div class="mb-3 row">
      <div class="col-md-6">
        <label class="form-label">Brand <span class="required-star">*</span></label>
        <div class="input-group">
          <select id="brand" name="brand" class="form-control {% if errors.brand %}is-invalid{% endif %}">
            <option value="">-- Select Brand --</option>
            {% for br in brands %}
            <option value="{{ br.id }}" {% if product.brand_id == br.id %}selected{% endif %}>{{ br.name }}</option>
            {% endfor %}
          </select>
          <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addBrandModal">+ Add</button>
        </div>
        {% if errors.brand %}
        <div class="invalid-feedback">{{ errors.brand }}</div>
        {% endif %}
      </div>
      
      <div class="col-md-6">
        <label class="form-label">Category <span class="required-star">*</span></label>
        <select id="category" name="category" class="form-control {% if errors.category %}is-invalid{% endif %}">
          <option value="">Select category</option>
          {% for cat in categories %}
          <option value="{{ cat.id }}" {% if product.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
          {% endfor %}
        </select>
        {% if errors.category %}
        <div class="invalid-feedback">{{ errors.category }}</div>
        {% endif %}
      </div>
    </div>

    <!-- Pricing -->
    <h5 class="section-header">üí∞ Pricing</h5>
    
    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label">Base Price (MRP) <span class="required-star">*</span></label>
        <input 
          type="number" 
          step="0.01" 
          min="0" 
          name="base_price" 
          id="base_price"
          class="form-control {% if errors.base_price %}is-invalid{% endif %}" 
          value="{{ product.base_price }}"
          required
        >
        <div class="form-text">Enter the base price (e.g., 999.99)</div>
        {% if errors.base_price %}
        <div class="invalid-feedback">{{ errors.base_price }}</div>
        {% endif %}
      </div>
      
      <div class="col-md-4">
        <label class="form-label">Discount Price</label>
        <input 
          type="number" 
          step="0.01" 
          min="0" 
          name="discount_price"
          id="discount_price" 
          class="form-control {% if errors.discount_price %}is-invalid{% endif %}" 
          value="{{ product.discount_price|default:'' }}"
        >
        <div class="form-text">Must be less than base price</div>
        {% if errors.discount_price %}
        <div class="invalid-feedback">{{ errors.discount_price }}</div>
        {% endif %}
      </div>
      
      <div class="col-md-4">
        <label class="form-label">Features</label>
        <input 
          type="text" 
          name="offer" 
          class="form-control" 
          value="{{ product.offer|default:'' }}" 
          placeholder="e.g., 8 Hours Playback"
        >
      </div>
    </div>

    <!-- Product Images -->
    <h5 class="section-header">üñºÔ∏è Product Images</h5>
    
    <!-- Existing Product Images -->
    <div class="mb-3">
      <label class="form-label">Existing Images</label>
      <div class="d-flex flex-wrap" id="product_existing_preview">
        {% for pi in product_images %}
        <div class="image-item" data-existing-product-image="{{ pi.id }}">
          <img src="{{ pi.image_url }}" alt="Product image">
          <button 
            type="button" 
            class="remove-btn remove-existing-product-image" 
            data-id="{{ pi.id }}"
            title="Remove image"
          >√ó</button>
          <input type="hidden" name="remove_product_image_ids[]" value="" data-hidden-for="{{ pi.id }}">
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Upload New Product Images -->
    <div class="mb-3">
      <label class="form-label">Add New Images</label>
      <div class="image-upload" id="product-drop" tabindex="0">
        <div class="upload-icon">üì∏</div>
        <p style="color: #999; margin: 0;">Drag & drop product images, or click to choose</p>
        <input type="file" name="product_images" id="product_images" multiple accept="image/*" style="display: none;">
        <button type="button" class="btn btn-sm btn-secondary mt-2" id="product_file_btn">Choose Images</button>
      </div>
      <div class="mt-3 d-flex flex-wrap" id="product_preview"></div>
      <div class="form-text">Max 15 total images (5MB each). JPG, PNG, WebP allowed.</div>
      {% if errors.product_images %}
      <div class="invalid-feedback">{{ errors.product_images }}</div>
      {% endif %}
    </div>

    <!-- Detailed Images -->
    <h5 class="section-header">üîç Detailed Images</h5>
    
    <!-- Existing Detailed Images -->
    <div class="mb-3">
      <label class="form-label">Existing Detailed Images</label>
      <div class="d-flex flex-wrap" id="detailed_existing_preview">
        {% for di in detailed_images %}
        <div class="image-item" data-existing-detailed-image="{{ di.id }}">
          <img src="{{ di.image_url }}" alt="Detailed image">
          <button 
            type="button" 
            class="remove-btn remove-existing-detailed-image" 
            data-id="{{ di.id }}"
            title="Remove image"
          >√ó</button>
          <input type="hidden" name="remove_detailed_image_ids[]" value="" data-hidden-for-detailed="{{ di.id }}">
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Upload New Detailed Images -->
    <div class="mb-3">
      <label class="form-label">Add New Detailed Images</label>
      <input type="file" name="detailed_images" id="detailed_images" multiple accept="image/*" class="form-control">
      <div class="mt-3 d-flex flex-wrap" id="detailed_preview"></div>
      <div class="form-text">Max 5 total detailed images (5MB each)</div>
      {% if errors.detailed_images %}
      <div class="invalid-feedback">{{ errors.detailed_images }}</div>
      {% endif %}
    </div>

    <!-- Variants -->
    <h5 class="section-header">üé® Variants & Stock</h5>
    
    <div id="variants-root">
      {% for v in variants %}
      <div class="variant-card" data-variant-existing="{{ v.id }}">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <strong style="font-size: 1.1rem;">üè∑Ô∏è Variant: {{ v.color }}</strong>
          <button type="button" class="btn btn-sm btn-outline-danger flag-remove-variant" data-id="{{ v.id }}">
            Remove Variant
          </button>
        </div>
        
        <input type="hidden" name="existing_variant_id[]" value="{{ v.id }}">
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Color <span class="required-star">*</span></label>
            <input 
              type="text" 
              name="color_existing[]" 
              class="form-control" 
              value="{{ v.color }}" 
              placeholder="e.g., Black"
            >
          </div>
          <div class="col-md-6">
            <label class="form-label">Stock <span class="required-star">*</span></label>
            <input 
              type="number" 
              min="0" 
              name="stock_existing[]" 
              class="form-control" 
              value="{{ v.stock }}" 
              placeholder="Quantity"
            >
          </div>
        </div>

        <!-- Existing Variant Images -->
        <div class="mb-3">
          <label class="form-label">Existing Variant Images</label>
          <div class="d-flex flex-wrap">
            {% for vi in v.images.all %}
            <div class="image-item" data-existing-variant-image="{{ vi.id }}" data-variant="{{ v.id }}">
              <img src="{{ vi.image_url }}" alt="Variant image" style="width: 100px; height: 100px;">
              <button 
                type="button" 
                class="remove-btn remove-existing-variant-image" 
                data-img-id="{{ vi.id }}" 
                data-variant-id="{{ v.id }}"
                title="Remove image"
              >√ó</button>
              <input type="hidden" name="remove_variant_image_ids_{{ v.id }}[]" value="" data-hidden-for-variant="{{ v.id }}" data-img="{{ vi.id }}">
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Add New Variant Images -->
        <div class="mb-3">
          <label class="form-label">Add New Images (Max 15)</label>
          <div class="image-upload" data-variant-drop="{{ v.id }}" tabindex="0">
            <div class="upload-icon" style="font-size: 2rem;">üñºÔ∏è</div>
            <p style="color: #999; margin: 0;">Drag & drop or click to choose</p>
            <input type="file" name="variant_images_{{ v.id }}" id="variant_images_{{ v.id }}" multiple accept="image/*" style="display: none;">
            <button type="button" class="btn btn-sm btn-secondary mt-2 variant-choose-btn" data-variant="{{ v.id }}">
              Choose Images
            </button>
          </div>
          <div class="variant-preview mt-3 d-flex flex-wrap" data-variant-preview="{{ v.id }}"></div>
        </div>

        <input type="hidden" name="remove_variant_ids[]" value="" data-remove-variant="{{ v.id }}">
      </div>
      {% endfor %}
    </div>

    <div class="mb-4">
      <button type="button" id="add-variant" class="btn btn-outline-primary">
        ‚ûï Add New Variant
      </button>
    </div>

    <!-- Video -->
    <h5 class="section-header">üé• Video</h5>
    <div class="mb-3">
      <label class="form-label">Video URL (YouTube/MP4)</label>
      <input 
        type="url" 
        name="video" 
        class="form-control" 
        value="{{ product.video|default:'' }}" 
        placeholder="https://youtube.com/watch?v=..."
      >
      <div class="form-text">Optional: Paste a YouTube or direct MP4 link</div>
    </div>

    <!-- Form Actions -->
    <div class="text-end mt-4">
      <a href="{% url 'product_list' %}" class="btn btn-light me-2">Cancel</a>
      <button type="submit" class="btn btn-success" id="submitBtn">
        üíæ Save Changes
      </button>
    </div>
  </form>
</div>

<!-- Add Brand Modal (Keep existing modal) -->
<div class="modal fade" id="addBrandModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="addBrandForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Brand</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="brand_name" class="form-control" placeholder="Enter brand name" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Cropper Modal (Keep existing) -->
<div class="modal fade" id="cropperModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Crop Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="cropperImage" style="max-width:100%;" alt="Image to crop" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cropSkip">Skip</button>
        <button type="button" class="btn btn-secondary" id="cropCancel">Cancel</button>
        <button type="button" class="btn btn-primary" id="cropSave">Save Crop</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Configuration
  const maxImagesPerVariant = 15;
  const maxImagesPerProduct = 15;
  const maxDetailedImages = 5;
  const maxFileSize = 5 * 1024 * 1024; // 5MB

  const variantFileStores = {};
  const newVariantFileStores = {};
  const productFileStore = new DataTransfer();
  let newVariantIndex = 0;

  function showError(message) {
    Swal.fire({
      icon: 'error',
      title: 'Validation Error',
      text: message,
      confirmButtonColor: '#a855f7'
    });
  }

  function getCsrfToken() {
    return document.querySelector('input[name="csrfmiddlewaretoken"]').value;
  }

  // ===== CLIENT-SIDE VALIDATION =====
  document.getElementById('product-form').addEventListener('submit', function(e) {
    let errors = [];

    // Product Name
    const name = document.getElementById('name').value.trim();
    if (!name) {
      errors.push('Product name is required');
    } else if (name.length < 3) {
      errors.push('Product name must be at least 3 characters');
    } else if (!/^[A-Za-z0-9 _-]+$/.test(name)) {
      errors.push('Product name can only contain letters, numbers, spaces, hyphens, and underscores');
    }

    // Long Description
    const longDesc = document.getElementById('long_desc').value.trim();
    if (longDesc && longDesc.length < 10) {
      errors.push('Description must be at least 10 characters if provided');
    }

    // Brand
    if (!document.getElementById('brand').value) {
      errors.push('Brand is required');
    }

    // Category
    if (!document.getElementById('category').value) {
      errors.push('Category is required');
    }

    // Base Price
    const basePrice = parseFloat(document.getElementById('base_price').value);
    if (!basePrice || basePrice <= 0) {
      errors.push('Base price must be greater than 0');
    }

    // Discount Price
    const discountPrice = parseFloat(document.getElementById('discount_price').value);
    if (discountPrice && discountPrice >= basePrice) {
      errors.push('Discount price must be less than base price');
    }

    // Product Images Check
    const existingProductCount = document.querySelectorAll("#product_existing_preview .image-item:not(.removing)").length;
    const newProductCount = productFileStore.files.length;
    if (existingProductCount + newProductCount === 0) {
      errors.push('At least one product image is required');
    }

    // Show errors if any
    if (errors.length > 0) {
      e.preventDefault();
      Swal.fire({
        icon: 'error',
        title: 'Please fix the following errors:',
        html: '<ul style="text-align: left;">' + errors.map(err => `<li>${err}</li>`).join('') + '</ul>',
        confirmButtonColor: '#a855f7'
      });
      return false;
    }
  });

  // ===== MARK EXISTING PRODUCT IMAGE FOR REMOVAL =====
  document.querySelectorAll(".remove-existing-product-image").forEach(btn => {
    btn.addEventListener("click", function() {
      const id = this.dataset.id;
      const hidden = document.querySelector(`input[data-hidden-for="${id}"]`);
      if (hidden) hidden.value = id;
      
      const item = this.closest(".image-item");
      item.classList.add("removing");
      
      Swal.fire({
        icon: 'success',
        title: 'Marked for removal',
        text: 'This image will be deleted when you save',
        timer: 2000,
        showConfirmButton: false
      });
    });
  });

  // ===== EXISTING DETAILED IMAGE REMOVAL =====
  document.querySelectorAll(".remove-existing-detailed-image").forEach(btn => {
    btn.addEventListener("click", function() {
      const id = this.dataset.id;
      const hidden = document.querySelector(`input[data-hidden-for-detailed="${id}"]`);
      if (hidden) hidden.value = id;
      
      const item = this.closest(".image-item");
      item.classList.add("removing");
    });
  });

  // ===== EXISTING VARIANT IMAGE REMOVAL =====
  document.querySelectorAll(".remove-existing-variant-image").forEach(btn => {
    btn.addEventListener("click", function() {
      const vid = this.dataset.variantId;
      const imgId = this.dataset.imgId;
      const hidden = document.querySelector(`input[data-hidden-for-variant="${vid}"][data-img="${imgId}"]`);
      if (hidden) hidden.value = imgId;
      
      const item = this.closest(".image-item");
      item.classList.add("removing");
    });
  });

  // ===== FLAG REMOVE VARIANT =====
  document.querySelectorAll(".flag-remove-variant").forEach(btn => {
    btn.addEventListener("click", async function() {
      const vid = this.dataset.id;
      
      const result = await Swal.fire({
        title: 'Remove Variant?',
        text: 'This variant will be deleted when you save',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, remove it',
        cancelButtonText: 'Cancel'
      });
      
      if (result.isConfirmed) {
        const hidden = document.querySelector(`input[data-remove-variant="${vid}"]`);
        if (hidden) hidden.value = vid;
        
        const card = this.closest("[data-variant-existing]");
        card.classList.add("removing");
        
        Swal.fire({
          icon: 'success',
          title: 'Marked for removal',
          text: 'Variant will be deleted when you save',
          timer: 2000,
          showConfirmButton: false
        });
      }
    });
  });

  // ===== PRODUCT NEW IMAGES =====
  const productFileInput = document.getElementById("product_images");
  const productFileBtn = document.getElementById("product_file_btn");
  const productDrop = document.getElementById("product-drop");
  const productPreview = document.getElementById("product_preview");

  function handleProductFiles(files) {
    if (!files || files.length === 0) return;
    
    const existingCount = document.querySelectorAll("#product_existing_preview .image-item:not(.removing)").length;
    
    [...files].forEach(f => {
      if (!f.type.startsWith("image/")) {
        return showError("Only image files are allowed");
      }
      if (f.size > maxFileSize) {
        return showError(`File size must be less than 5MB (${f.name} is ${(f.size / 1024 / 1024).toFixed(1)}MB)`);
      }
      if (existingCount + productFileStore.files.length >= maxImagesPerProduct) {
        return showError(`Maximum ${maxImagesPerProduct} product images allowed`);
      }
      
      productFileStore.items.add(f);
      renderProductPreview();
    });
  }

  function renderProductPreview() {
    productPreview.innerHTML = "";
    [...productFileStore.files].forEach((file, idx) => {
      const wrapper = document.createElement("div");
      wrapper.className = "image-item";
      
      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      img.alt = "Preview";
      
      const removeBtn = document.createElement("button");
      removeBtn.innerHTML = "√ó";
      removeBtn.className = "remove-btn";
      removeBtn.type = "button";
      removeBtn.addEventListener("click", () => {
        const dt = new DataTransfer();
        [...productFileStore.files].forEach((f, i) => {
          if (i !== idx) dt.items.add(f);
        });
        Object.assign(productFileStore, dt);
        productFileInput.files = dt.files;
        renderProductPreview();
      });
      
      wrapper.appendChild(img);
      wrapper.appendChild(removeBtn);
      productPreview.appendChild(wrapper);
    });
    
    productFileInput.files = productFileStore.files;
  }

  productFileBtn.addEventListener("click", () => productFileInput.click());
  productDrop.addEventListener("click", () => productFileInput.click());
  
  ["dragenter", "dragover"].forEach(ev => {
    productDrop.addEventListener(ev, e => {
      e.preventDefault();
      e.stopPropagation();
      productDrop.classList.add("highlight");
    });
  });
  
  ["dragleave", "drop"].forEach(ev => {
    productDrop.addEventListener(ev, e => {
      e.preventDefault();
      e.stopPropagation();
      productDrop.classList.remove("highlight");
    });
  });
  
  productDrop.addEventListener("drop", e => handleProductFiles(e.dataTransfer.files));
  productFileInput.addEventListener("change", () => handleProductFiles(productFileInput.files));

  // ===== DETAILED IMAGES =====
  const detailedInput = document.getElementById("detailed_images");
  const detailedPreview = document.getElementById("detailed_preview");

  detailedInput.addEventListener("change", function() {
    detailedPreview.innerHTML = "";
    const dt = new DataTransfer();
    const existingCount = document.querySelectorAll("#detailed_existing_preview .image-item:not(.removing)").length;
    
    [...this.files].forEach((file, idx) => {
      if (!file.type.startsWith("image/")) {
        return showError("Only image files are allowed");
      }
      if (file.size > maxFileSize) {
        return showError(`File must be less than 5MB`);
      }
      if (existingCount + idx + 1 > maxDetailedImages) {
        return showError(`Maximum ${maxDetailedImages} detailed images allowed`);
      }
      
      dt.items.add(file);
      
      const wrapper = document.createElement("div");
      wrapper.className = "image-item";
      
      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      
      const removeBtn = document.createElement("button");
      removeBtn.innerHTML = "√ó";
      removeBtn.className = "remove-btn";
      removeBtn.type = "button";
      removeBtn.addEventListener("click", () => {
        const dt2 = new DataTransfer();
        [...dt.files].forEach((f, i) => {
          if (i !== idx) dt2.items.add(f);
        });
        detailedInput.files = dt2.files;
        wrapper.remove();
      });
      
      wrapper.appendChild(img);
      wrapper.appendChild(removeBtn);
      detailedPreview.appendChild(wrapper);
    });
    
    this.files = dt.files;
  });

  // ===== VARIANT HANDLING =====
  document.querySelectorAll("[data-variant-existing]").forEach(card => {
    const variantId = card.getAttribute("data-variant-existing");
    const chooseBtn = card.querySelector(".variant-choose-btn");
    const fileInput = card.querySelector(`#variant_images_${variantId}`);
    const dropArea = card.querySelector(`[data-variant-drop="${variantId}"]`);
    const previewArea = card.querySelector(`[data-variant-preview="${variantId}"]`);
    
    variantFileStores[variantId] = new DataTransfer();
    
    chooseBtn.addEventListener("click", () => fileInput.click());
    dropArea.addEventListener("click", () => fileInput.click());
    
    ["dragenter", "dragover"].forEach(ev => {
      dropArea.addEventListener(ev, e => {
        e.preventDefault();
        e.stopPropagation();
        dropArea.classList.add("highlight");
      });
    });
    
    ["dragleave", "drop"].forEach(ev => {
      dropArea.addEventListener(ev, e => {
        e.preventDefault();
        e.stopPropagation();
        dropArea.classList.remove("highlight");
      });
    });
    
    dropArea.addEventListener("drop", e => handleVariantFiles(variantId, e.dataTransfer.files, previewArea, fileInput, true));
    fileInput.addEventListener("change", () => handleVariantFiles(variantId, fileInput.files, previewArea, fileInput, true));
  });

  function handleVariantFiles(key, files, previewArea, fileInput, isExisting) {
    const store = isExisting ? variantFileStores[key] : newVariantFileStores[key];
    if (!files || files.length === 0) return;
    
    [...files].forEach(f => {
      if (!f.type.startsWith("image/")) {
        return showError("Only image files allowed");
      }
      if (f.size > maxFileSize) {
        return showError("File must be less than 5MB");
      }
      if (store.files.length >= maxImagesPerVariant) {
        return showError(`Maximum ${maxImagesPerVariant} images per variant`);
      }
      
      store.items.add(f);
    });
    
    renderVariantPreview(key, previewArea, fileInput, isExisting);
  }

  function renderVariantPreview(key, previewArea, fileInput, isExisting) {
    previewArea.innerHTML = "";
    const store = isExisting ? variantFileStores[key] : newVariantFileStores[key];
    
    [...store.files].forEach((file, idx) => {
      const wrapper = document.createElement("div");
      wrapper.className = "image-item";
      
      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      img.style.width = "100px";
      img.style.height = "100px";
      
      const removeBtn = document.createElement("button");
      removeBtn.innerHTML = "√ó";
      removeBtn.className = "remove-btn";
      removeBtn.type = "button";
      removeBtn.addEventListener("click", () => {
        const dt = new DataTransfer();
        [...store.files].forEach((f, i) => {
          if (i !== idx) dt.items.add(f);
        });
        
        if (isExisting) {
          variantFileStores[key] = dt;
        } else {
          newVariantFileStores[key] = dt;
        }
        
        fileInput.files = dt.files;
        renderVariantPreview(key, previewArea, fileInput, isExisting);
      });
      
      wrapper.appendChild(img);
      wrapper.appendChild(removeBtn);
      previewArea.appendChild(wrapper);
    });
    
    fileInput.files = store.files;
  }

  // ===== ADD NEW VARIANT =====
  const variantsRoot = document.getElementById("variants-root");
  const addVariantBtn = document.getElementById("add-variant");

  addVariantBtn.addEventListener("click", function() {
    const i = newVariantIndex++;
    const wrapper = document.createElement("div");
    wrapper.className = "variant-card";
    wrapper.dataset.variantNewIndex = i;
    
    wrapper.innerHTML = `
      <div class="d-flex justify-content-between align-items-start mb-3">
        <strong style="font-size: 1.1rem;">üÜï New Variant #${i + 1}</strong>
        <button type="button" class="btn btn-sm btn-outline-danger remove-variant">Remove</button>
      </div>
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Color <span class="required-star">*</span></label>
          <input type="text" name="color_new[]" class="form-control" placeholder="e.g., Red">
        </div>
        <div class="col-md-6">
          <label class="form-label">Stock <span class="required-star">*</span></label>
          <input type="number" min="0" name="stock_new[]" class="form-control" placeholder="Quantity">
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Variant Images (Max 15)</label>
        <div class="image-upload" data-variant-new-drop="${i}" tabindex="0">
          <div class="upload-icon" style="font-size: 2rem;">üñºÔ∏è</div>
          <p style="color: #999; margin: 0;">Drag & drop or click</p>
          <input type="file" name="variant_images_new_${i}" id="variant_images_new_${i}" multiple accept="image/*" style="display: none;">
          <button type="button" class="btn btn-sm btn-secondary mt-2 variant-new-choose-btn" data-variant-new="${i}">Choose Images</button>
        </div>
        <div class="variant-preview mt-3 d-flex flex-wrap" data-variant-new-preview="${i}"></div>
      </div>
    `;
    
    variantsRoot.appendChild(wrapper);
    
    // Setup handlers for new variant
    const newFileInput = wrapper.querySelector(`#variant_images_new_${i}`);
    const newChooseBtn = wrapper.querySelector(".variant-new-choose-btn");
    const newDropArea = wrapper.querySelector(`[data-variant-new-drop="${i}"]`);
    const newPreviewArea = wrapper.querySelector(`[data-variant-new-preview="${i}"]`);
    
    newVariantFileStores[i] = new DataTransfer();
    
    newChooseBtn.addEventListener("click", () => newFileInput.click());
    newDropArea.addEventListener("click", () => newFileInput.click());
    
    ["dragenter", "dragover"].forEach(ev => {
      newDropArea.addEventListener(ev, e => {
        e.preventDefault();
        e.stopPropagation();
        newDropArea.classList.add("highlight");
      });
    });
    
    ["dragleave", "drop"].forEach(ev => {
      newDropArea.addEventListener(ev, e => {
        e.preventDefault();
        e.stopPropagation();
        newDropArea.classList.remove("highlight");
      });
    });
    
    newDropArea.addEventListener("drop", e => handleVariantFiles(i, e.dataTransfer.files, newPreviewArea, newFileInput, false));
    newFileInput.addEventListener("change", () => handleVariantFiles(i, newFileInput.files, newPreviewArea, newFileInput, false));
    
    wrapper.querySelector(".remove-variant").addEventListener("click", function() {
      wrapper.remove();
      delete newVariantFileStores[i];
    });
  });

  // Keep your existing brand modal and cropper code here...
});
</script>

{% endblock %}
