{% extends 'admin/admin-base.html' %}
{% load static %}

{% block title %}Product Edit{% endblock %}

{% block content %}
<style>
  .product-form{
        width: 1140px;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 1.75rem;
    margin-bottom: 1.5rem;
  }
      .modal-backdrop {
    position: absolute !important;
    top: -9999999px !important;
}
  #drop-area.highlight { border-color: #2109c2; background-color: #f0f0f0; }
  .variant-card { border: 1px solid #333; padding: 12px; border-radius: 8px; margin-bottom: 12px; background: #000; color: #fff; }
  .preview-img { display:block; border-radius:6px; }
  .variant-actions { display:flex; gap:8px; align-items:center; }
  .image-upload[tabindex="0"]:focus { outline: 2px solid #2109c2; }
  .form-text { margin-top:.25rem; font-size:.875em; color: rgba(186,198,210,.75); }
  .image-upload { border: 2px dashed #666; border-radius: 8px; padding: 40px 20px; text-align: center; background: #1e1e1e; cursor: pointer; transition: border .3s; height: 150px; }
  .ttl{
    font-size: 1.25rem;
    font-weight: 700;
    color: #a855f7;
    margin-bottom: 1.25rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid rgba(168, 85, 247, 0.3);

  }
  .form-control{
    background: #000 !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 8px !important;
    color: #fff !important;
    padding: 0.75rem 1rem !important;
    transition: all 0.3s ease !important;
  }
  .form-label{
    font-weight: 600;
    color: #fff;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  h5{
    font-weight: 600;
    color: #fff;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  label{
    font-weight: 600;
    color: #fff;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
</style>

<div class="container py-4">
  <div id="error-alert" class="alert alert-danger d-none" role="alert"></div>

  <h2 class="fw-bold mb-4">Edit Product</h2>
{% if messages %}
  <div class="mb-3">
    {% for m in messages %}
      <div class="alert alert-{% if m.tags == 'error' %}danger{% else %}{{ m.tags }}{% endif %} alert-dismissible fade show" role="alert">

        {{ m }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

{% if non_field_errors %}
  <div class="alert alert-danger" role="alert">
    <ul class="mb-0">
      {% for e in non_field_errors %}
        <li>{{ e }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

  <form method="POST" enctype="multipart/form-data" class="product-form" id="product-form"  action="{% url 'product_edit' product_id=product.id %}">
    {% csrf_token %}

    <!-- Basic Info -->
    <h5 class="ttl">Basic Information</h5>
    <div class="mb-3">
      <label for="name" class="form-label">Product Name</label>
      <input type="text" id="name" name="name"
            class="form-control {% if errors.name %}is-invalid{% endif %}"
            value="{{ product.name }}" required aria-describedby="name-help {% if errors.name %}name-error{% endif %}">
      <div id="name-help" class="form-text">Enter the product name (required).</div>
      {% if errors.name %}
        <div id="name-error" class="invalid-feedback d-block">{{ errors.name }}</div>
      {% endif %}
    </div>

    <div class="mb-3">
      <label for="short_desc" class="form-label">Short Description</label>
      <input type="text" id="short_desc" name="short_desc" class="form-control" value="{{ product.short_description|default:'' }}" placeholder="Brief description">
    </div>

    <div class="mb-3">
      <label for="long_desc" class="form-label">Long Description</label>
      <textarea id="long_desc" name="long_desc" class="form-control" rows="4" placeholder="Detailed description">{{ product.long_description|default:'' }}</textarea>
    </div>

    <div class="mb-3 row">
      <div class="col-md-6">
        <label class="form-label">Brand</label>
        <div class="input-group">
          <select id="brand" name="brand" class="form-control" aria-describedby="brand-help">
            <option value="">-- Select Brand --</option>
            {% for br in brands %}
              <option value="{{ br.id }}" {% if product.brand_id == br.id %}selected{% endif %}>{{ br.name }}</option>
            {% endfor %}
          </select>
          <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addBrandModal" aria-label="Add new brand">+ Add</button>
        </div>
        <div id="brand-help" class="form-text">Select a brand or add a new one.</div>
      </div>
      <div class="col-md-6">
        <label class="form-label">Category</label>
        <select id="category" name="category" class="form-control" aria-describedby="category-help">
          <option value="">Select category</option>
          {% for cat in categories %}
            <option value="{{ cat.id }}" {% if product.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
          {% endfor %}
        </select>
        <div id="category-help" class="form-text">Select a category (required).</div>
      </div>
    </div>

    <!-- Pricing -->
    <h5>Pricing</h5>
    <div class="row mb-3">
      <div class="col-md-4">
        <label>Base Price (MRP)</label>
        <input type="number" step="0.01" min="0" name="base_price" class="form-control" value="{{ product.base_price }}" aria-describedby="base-price-help">
        <div id="base-price-help" class="form-text">Enter the base price (e.g., 99.99).</div>
      </div>
      <div class="col-md-4">
        <label>Discount Price</label>
        <input type="number" step="0.01" min="0" name="discount_price" class="form-control" value="{{ product.discount_price|default:'' }}" aria-describedby="discount-price-help">
        <div id="discount-price-help" class="form-text">Enter the discounted price, if any.</div>
      </div>
      <div class="col-md-4">
        <label>Features</label>
        <input type="text" name="offer" class="form-control" value="{{ product.offer|default:'' }}" placeholder="Eg: 8 Hours Playback">
      </div>
    </div>

    <!-- Existing Product Images -->
    <h5>Product Images</h5>
    <div class="mb-2 d-flex flex-wrap gap-2" id="product_existing_preview">
      {% for pi in product_images %}
      <div class="position-relative" data-existing-product-image="{{ pi.id }}">
        <img src="{{ pi.image.url }}" alt="Product image" style="width:120px;height:120px;object-fit:cover;border-radius:6px;">
        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 remove-existing-product-image" data-id="{{ pi.id }}" aria-label="Remove product image">×</button>
        <input type="hidden" name="remove_product_image_ids[]" value="" data-hidden-for="{{ pi.id }}">
      </div>
      {% endfor %}
    </div>

    <!-- Upload New Product Images -->
    <div class="mb-3">
      <div class="image-upload p-2 border border-dashed rounded text-center" id="product-drop" tabindex="0" aria-label="Drag and drop or click to upload product images">
        <p>Drag & drop product images, or click to choose</p>
        <input type="file" name="product_images" id="product_images" multiple accept="image/*" style="opacity:0; width:1px; height:1px; position:absolute;">
        <button type="button" class="btn btn-sm btn-secondary" id="product_file_btn" aria-label="Choose product images">Choose Images</button>
      </div>
      <div class="mt-2 d-flex flex-wrap gap-2" id="product_preview"></div>
      <div class="form-text">Max 8 total including existing. Remove above to free slots.</div>
    </div>

    <!-- Existing Detailed Images -->
    <h5>Detailed Images</h5>
    <div class="mb-2 d-flex flex-wrap gap-2" id="detailed_existing_preview">
      {% for di in detailed_images %}
      <div class="position-relative" data-existing-detailed-image="{{ di.id }}">
        <img src="{{ di.image.url }}" alt="Detailed image" style="width:120px;height:120px;object-fit:cover;border-radius:6px;">
        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 remove-existing-detailed-image" data-id="{{ di.id }}" aria-label="Remove detailed image">×</button>
        <input type="hidden" name="remove_detailed_image_ids[]" value="" data-hidden-for-detailed="{{ di.id }}">
      </div>
      {% endfor %}
    </div>

    <!-- Upload New Detailed Images -->
    <div class="mb-3">
      <label class="form-label">Choose Detailed Images</label>
      <input type="file" name="detailed_images" id="detailed_images" multiple accept="image/*" class="form-control">
      <div class="mt-2 d-flex flex-wrap gap-2" id="detailed_preview"></div>
      <div class="form-text">Max 5 total including existing.</div>
    </div>

    <!-- Variants -->
    <h5>Variants & Stock</h5>
    <div id="variants-root">
      {% for v in variants %}
      <div class="variant-card" data-variant-existing="{{ v.id }}">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <strong>Variant: {{ v.color }}</strong>
          <div class="variant-actions">
            <button type="button" class="btn btn-sm btn-outline-danger flag-remove-variant" data-id="{{ v.id }}" aria-label="Remove variant">Remove</button>
          </div>
        </div>
        <input type="hidden" name="existing_variant_id[]" value="{{ v.id }}">
        <div class="row mb-2">
          <div class="col-md-5">
            <label class="form-label">Color</label>
            <input type="text" name="color_existing[]" class="form-control" value="{{ v.color }}" placeholder="Eg: Black" aria-describedby="color-help-{{ v.id }}">
            <div id="color-help-{{ v.id }}" class="form-text">Enter the variant color.</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Stock</label>
            <input type="number" min="0" name="stock_existing[]" class="form-control" value="{{ v.stock }}" placeholder="Qty" aria-describedby="stock-help-{{ v.id }}">
            <div id="stock-help-{{ v.id }}" class="form-text">Enter the stock quantity.</div>
          </div>
        </div>

        <!-- Existing images for this variant -->
        <div class="mb-2">
          <div class="d-flex flex-wrap gap-2">
            {% for vi in v.images.all %}
            <div class="position-relative" data-existing-variant-image="{{ vi.id }}" data-variant="{{ v.id }}">
              <img src="{{ vi.image.url }}" alt="Variant image" style="width:100px;height:100px;object-fit:cover;border-radius:6px;">
              <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 remove-existing-variant-image" data-img-id="{{ vi.id }}" data-variant-id="{{ v.id }}" aria-label="Remove variant image">×</button>
              <input type="hidden" name="remove_variant_image_ids_{{ v.id }}[]" value="" data-hidden-for-variant="{{ v.id }}" data-img="{{ vi.id }}">
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Add new images for this existing variant -->
        <div class="mb-2">
          <label class="form-label">Add Images (max 6)</label>
          <div class="image-upload p-2 border border-dashed rounded text-center" data-variant-drop="{{ v.id }}" tabindex="0" aria-label="Drag & drop or click to upload variant images">
            <p>Drag & drop images, or click to choose</p>
            <input type="file" name="variant_images_{{ v.id }}" id="variant_images_{{ v.id }}" multiple accept="image/*" style="opacity:0;width:1px;height:1px;position:absolute;">
            <button type="button" class="btn btn-sm btn-secondary variant-choose-btn" data-variant="{{ v.id }}" aria-label="Choose variant images">Choose Images</button>
          </div>
          <div class="variant-preview mt-2 d-flex flex-wrap gap-2" data-variant-preview="{{ v.id }}"></div>
          <div class="form-text">Existing + new must not exceed 6.</div>
        </div>

        <!-- Remove marker -->
        <input type="hidden" name="remove_variant_ids[]" value="" data-remove-variant="{{ v.id }}">
      </div>
      {% endfor %}
    </div>

    <div class="mb-3">
      <button type="button" id="add-variant" class="btn btn-outline-primary btn-sm" aria-label="Add new variant">➕ Add Variant</button>
    </div>

    <div class="mb-3">
      <label>Video (YouTube/mp4 link)</label>
      <input type="text" name="video" class="form-control" value="{{ product.video|default:'' }}" placeholder="Enter video URL">
    </div>

    <div class="text-end">
      <a href="{% url 'product_list' %}" class="btn btn-light" aria-label="Cancel">Cancel</a>
      <button type="submit" class="btn btn-success" aria-label="Save product">Save Changes</button>
    </div>
  </form>
</div>

<!-- Add Brand Modal -->
<div class="modal fade" id="addBrandModal" tabindex="-1" aria-labelledby="addBrandModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="addBrandForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addBrandModalLabel">Add Brand</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="brand_name" class="form-control" placeholder="Enter brand name" required aria-describedby="brand-name-help">
          <div id="brand-name-help" class="form-text">Enter a unique brand name (max 255 characters).</div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" aria-label="Save brand">Save</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Cropper Modal -->
<div class="modal fade" id="cropperModal" tabindex="-1" aria-labelledby="cropperModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cropperModalLabel">Crop Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="cropperImage" style="max-width:100%;" alt="Image to crop" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cropSkip" aria-label="Skip cropping">Skip</button>
        <button type="button" class="btn btn-secondary" id="cropCancel" aria-label="Cancel cropping">Cancel</button>
        <button type="button" class="btn btn-primary" id="cropSave" aria-label="Save cropped image">Save Crop</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Configs consistent with add page
  const maxImagesPerVariant = 15;
  const maxImagesPerProduct = 15;
  const maxDetailedImages = 5;
  const maxFileSize = 10 * 1024 * 1024; // UI-level 10MB; error text says 5MB to match previous text

  const variantFileStores = {};   // for NEW images per existing variant (keyed by existing variant id or new index)
  const newVariantFileStores = {}; // for NEW variants keyed by new index
  const productFileStore = new DataTransfer(); // for NEW product images
  let newVariantIndex = 0;

  function showError(message) {
    const alert = document.getElementById("error-alert");
    alert.textContent = message;
    alert.classList.remove("d-none");
    setTimeout(() => alert.classList.add("d-none"), 3000);
  }
  function getCsrfToken() {
    return document.querySelector('input[name="csrfmiddlewaretoken"]').value;
  }

  // ===== Mark existing product image for removal =====
  document.querySelectorAll(".remove-existing-product-image").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.id;
      const hidden = document.querySelector(`input[data-hidden-for="${id}"]`);
      if (hidden) hidden.value = id;
      btn.closest("[data-existing-product-image]").style.opacity = 0.4;
    });
  });

  // ===== Existing detailed image removal =====
  document.querySelectorAll(".remove-existing-detailed-image").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.id;
      const hidden = document.querySelector(`input[data-hidden-for-detailed="${id}"]`);
      if (hidden) hidden.value = id;
      btn.closest("[data-existing-detailed-image]").style.opacity = 0.4;
    });
  });

  // ===== Existing variant image removal =====
  document.querySelectorAll(".remove-existing-variant-image").forEach(btn => {
    btn.addEventListener("click", () => {
      const vid = btn.dataset.variantId;
      const imgId = btn.dataset.imgId;
      const hidden = document.querySelector(`input[data-hidden-for-variant="${vid}"][data-img="${imgId}"]`);
      if (hidden) hidden.value = imgId;
      btn.closest("[data-existing-variant-image]").style.opacity = 0.4;
    });
  });

  // ===== Flag remove variant (existing) =====
  document.querySelectorAll(".flag-remove-variant").forEach(btn => {
    btn.addEventListener("click", () => {
      const vid = btn.dataset.id;
      const hidden = document.querySelector(`input[data-remove-variant="${vid}"]`);
      if (hidden) hidden.value = vid;
      const card = btn.closest("[data-variant-existing]");
      card.style.opacity = 0.4;
    });
  });

  // ===== Product new images (additions) =====
  const productFileInput = document.getElementById("product_images");
  const productFileBtn = document.getElementById("product_file_btn");
  const productDrop = document.getElementById("product-drop");
  const productPreview = document.getElementById("product_preview");
  const existingProductCount = document.querySelectorAll("#product_existing_preview [data-existing-product-image]").length;

  function handleProductFiles(files) {
    if (!files || files.length === 0) return;
    [...files].forEach(f => {
      if (!f.type.startsWith("image/")) return showError("Only image files allowed.");
      if (f.size > maxFileSize) return showError("Max 5MB per image.");
      if (existingProductCount + [...productFileStore.files].length >= maxImagesPerProduct) {
        return showError(`Maximum ${maxImagesPerProduct} product images allowed.`);
      }
      enqueueCrop(productFileInput, productPreview, f, null, productPreview.children.length === 0);
    });
  }

  productFileBtn.addEventListener("click", () => productFileInput.click());
  productDrop.addEventListener("click", () => productFileInput.click());
  productDrop.addEventListener("keydown", e => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); productFileInput.click(); } });
  ["dragenter","dragover"].forEach(ev => productDrop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); productDrop.classList.add("highlight"); }));
  ["dragleave","drop"].forEach(ev => productDrop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); productDrop.classList.remove("highlight"); }));
  productDrop.addEventListener("drop", e => handleProductFiles(e.dataTransfer.files));
  productFileInput.addEventListener("change", () => handleProductFiles(productFileInput.files));

  // ===== Detailed new images (additions) =====
  const detailedInput = document.getElementById("detailed_images");
  const detailedPreview = document.getElementById("detailed_preview");
  const existingDetailedCount = document.querySelectorAll("#detailed_existing_preview [data-existing-detailed-image]").length;

  detailedInput.addEventListener("change", () => {
    detailedPreview.innerHTML = "";
    const dt = new DataTransfer();
    [...detailedInput.files].forEach((file, idx) => {
      if(!file.type.startsWith("image/")) return showError("Only image files allowed.");
      if(file.size > maxFileSize) return showError("Max 5MB per image.");
      if (existingDetailedCount + idx + 1 > maxDetailedImages) return showError(`Max ${maxDetailedImages} detailed images total.`);

      dt.items.add(file);
      const wrap = document.createElement("div");
      wrap.style.position = "relative";
      wrap.style.marginRight = "8px";

      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      img.style.width = "120px";
      img.style.height = "120px";
      img.style.objectFit = "cover";
      img.style.borderRadius = "6px";
      img.alt = "Detailed image";

      const removeBtn = document.createElement("button");
      removeBtn.innerHTML = "×";
      removeBtn.style.position = "absolute";
      removeBtn.style.top = "4px";
      removeBtn.style.right = "4px";
      removeBtn.style.background = "red";
      removeBtn.style.color = "white";
      removeBtn.style.border = "none";
      removeBtn.style.width = "22px";
      removeBtn.style.height = "22px";
      removeBtn.style.borderRadius = "50%";
      removeBtn.addEventListener("click", () => {
        const dt2 = new DataTransfer();
        [...dt.files].forEach((f, i) => { if (i !== idx) dt2.items.add(f); });
        detailedInput.files = dt2.files;
        detailedPreview.removeChild(wrap);
      });

      wrap.appendChild(img);
      wrap.appendChild(removeBtn);
      detailedPreview.appendChild(wrap);
    });
    detailedInput.files = dt.files;
  });

  // ===== Existing variant new images handling =====
  document.querySelectorAll("[data-variant-existing]").forEach(card => {
    const variantId = card.getAttribute("data-variant-existing");
    const chooseBtn = card.querySelector(".variant-choose-btn");
    const fileInput = card.querySelector(`#variant_images_${variantId}`);
    const dropArea = card.querySelector(`[data-variant-drop="${variantId}"]`);
    const previewArea = card.querySelector(`[data-variant-preview="${variantId}"]`);

    variantFileStores[variantId] = new DataTransfer();

    chooseBtn.addEventListener("click", () => fileInput.click());
    dropArea.addEventListener("click", () => fileInput.click());
    dropArea.addEventListener("keydown", e => { if(e.key==="Enter"||e.key===" "){ e.preventDefault(); fileInput.click(); } });

    ["dragenter","dragover"].forEach(ev => dropArea.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dropArea.classList.add("highlight"); }));
    ["dragleave","drop"].forEach(ev => dropArea.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dropArea.classList.remove("highlight"); }));
    dropArea.addEventListener("drop", e => handleVariantFiles(variantId, e.dataTransfer.files, previewArea, fileInput, true));
    fileInput.addEventListener("change", () => handleVariantFiles(variantId, fileInput.files, previewArea, fileInput, true));
  });

  function handleVariantFiles(key, files, previewArea, fileInput, isExistingVariant){
    const store = isExistingVariant ? variantFileStores[key] : newVariantFileStores[key];
    if(!files||files.length===0) return;
    [...files].forEach(f=>{
      if(!f.type.startsWith("image/")) return showError("Only image files allowed.");
      if(f.size>maxFileSize) return showError("Max 5MB per image.");
      if([...store.files].length>=maxImagesPerVariant) return showError(`Maximum ${maxImagesPerVariant} variant images allowed.`);
      enqueueCrop(fileInput, previewArea, f, key);
    });
    if (isExistingVariant) {
      variantFileStores[key] = store;
    } else {
      newVariantFileStores[key] = store;
    }
  }

  function renderVariantPreview(key, previewArea, fileInput, isExistingVariant){
    previewArea.innerHTML = "";
    const store = isExistingVariant ? variantFileStores[key] : newVariantFileStores[key];
    if(!store) return;
    [...store.files].forEach((file, idx) => {
      const wrapper = document.createElement("div");
      wrapper.style.position = "relative";

      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      img.style.width = "100px";
      img.style.height = "100px";
      img.style.objectFit = "cover";
      img.style.borderRadius = "6px";
      img.alt = "Variant image";

      const removeBtn = document.createElement("button");
      removeBtn.innerHTML = "×";
      removeBtn.style.position = "absolute";
      removeBtn.style.top = "4px";
      removeBtn.style.right = "6px";
      removeBtn.style.background = "red";
      removeBtn.style.color = "white";
      removeBtn.style.border = "none";
      removeBtn.style.width = "22px";
      removeBtn.style.height = "22px";
      removeBtn.style.borderRadius = "50%";
      removeBtn.setAttribute("aria-label","Remove variant image");

      removeBtn.addEventListener("click", () => {
        const dt = new DataTransfer();
        [...store.files].forEach((f, i) => { if(i !== idx) dt.items.add(f); });
        if (isExistingVariant) {
          variantFileStores[key] = dt;
        } else {
          newVariantFileStores[key] = dt;
        }
        fileInput.files = dt.files;
        renderVariantPreview(key, previewArea, fileInput, isExistingVariant);
      });

      wrapper.appendChild(img);
      wrapper.appendChild(removeBtn);
      previewArea.appendChild(wrapper);
    });

    fileInput.files = store.files;
  }

  // ===== Add new variant blocks =====
  const variantsRoot = document.getElementById("variants-root");
  const addVariantBtn = document.getElementById("add-variant");

  function createNewVariantBlock(i){
    const wrapper = document.createElement("div");
    wrapper.className = "variant-card";
    wrapper.dataset.variantNewIndex = i;
    wrapper.innerHTML = `
      <div class="d-flex justify-content-between align-items-start mb-2">
        <strong>New Variant #${i+1}</strong>
        <div class="variant-actions">
          <button type="button" class="btn btn-sm btn-outline-danger remove-variant" aria-label="Remove variant">Remove</button>
        </div>
      </div>
      <div class="row mb-2">
        <div class="col-md-5">
          <label class="form-label">Color</label>
          <input type="text" name="color_new[]" class="form-control" placeholder="Eg: Black">
        </div>
        <div class="col-md-4">
          <label class="form-label">Stock</label>
          <input type="number" min="0" name="stock_new[]" class="form-control" placeholder="Qty">
        </div>
      </div>
      <div class="mb-2">
        <label class="form-label">Variant Images (max ${maxImagesPerVariant})</label>
        <div class="image-upload p-2 border border-dashed rounded text-center" data-variant-new-drop="${i}" tabindex="0" aria-label="Drag & drop or click to upload variant images">
          <p>Drag & drop images, or click to choose</p>
          <input type="file" multiple accept="image/*" style="opacity:0;width:1px;height:1px;position:absolute;">
          <button type="button" class="btn btn-sm btn-secondary variant-choose-btn" data-variant-new="${i}" aria-label="Choose variant images">Choose Images</button>
        </div>
        <div class="variant-preview mt-2 d-flex flex-wrap gap-2" data-variant-new-preview="${i}"></div>
      </div>
    `;
    variantsRoot.appendChild(wrapper);
    newVariantFileStores[i] = new DataTransfer();

    const chooseBtn = wrapper.querySelector(".variant-choose-btn");
    const fileInput = wrapper.querySelector("input[type='file']");
    const dropArea = wrapper.querySelector(`[data-variant-new-drop="${i}"]`);
    const previewArea = wrapper.querySelector(`[data-variant-new-preview="${i}"]`);
    const removeBtn = wrapper.querySelector(".remove-variant");

    // set dynamic name recognized by backend
    fileInput.name = `variant_images_new_${i}`;

    chooseBtn.addEventListener("click", () => fileInput.click());
    dropArea.addEventListener("click", () => fileInput.click());
    dropArea.addEventListener("keydown", e => { if(e.key==="Enter"||e.key===" "){ e.preventDefault(); fileInput.click(); } });

    ["dragenter","dragover"].forEach(ev=>dropArea.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();dropArea.classList.add("highlight");}));
    ["dragleave","drop"].forEach(ev=>dropArea.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();dropArea.classList.remove("highlight");}));
    dropArea.addEventListener("drop", e => handleVariantFiles(i, e.dataTransfer.files, previewArea, fileInput, false));
    fileInput.addEventListener("change", ()=>handleVariantFiles(i, fileInput.files, previewArea, fileInput, false));

    removeBtn.addEventListener("click", ()=> {
      [...previewArea.children].forEach(c=>{ const img=c.querySelector("img"); if(img) URL.revokeObjectURL(img.src); });
      delete newVariantFileStores[i]; wrapper.remove();
    });
  }

  addVariantBtn.addEventListener("click", () => {
    createNewVariantBlock(newVariantIndex);
    newVariantIndex++;
  });

  // ===== Cropper logic (shared with add page behavior) =====
  let cropper, cropQueue=[], currentFileInput, currentPreviewArea, currentKey;
  function enqueueCrop(fileInput, previewArea, file, key=null, isCover=false){
    cropQueue.push({fileInput,previewArea,file,key,isCover});
    if(!cropper) processNextCrop();
  }
  function processNextCrop(){
    if(!cropQueue.length) return;
    const {fileInput,previewArea,file,key,isCover}=cropQueue.shift();
    currentFileInput=fileInput; currentPreviewArea=previewArea; currentKey=key;
    const reader=new FileReader();
    reader.onload=e=>{
      const cropperImage=document.getElementById("cropperImage"); cropperImage.src=e.target.result;
      const modal=new bootstrap.Modal(document.getElementById("cropperModal")); modal.show();
      if(cropper) cropper.destroy();
      cropper=new Cropper(cropperImage,{aspectRatio:1,viewMode:1,autoCropArea:1});
    }; reader.readAsDataURL(file);
  }
  document.getElementById("cropSkip").addEventListener("click",()=>{
    if(!cropper) return;
    // Determine context: product vs variant
    if(currentPreviewArea.id === "product_preview"){
      if([...productFileStore.files].length<maxImagesPerProduct){
        // append skip (original)
        productFileStore.items.add(cropQueue[0]?.file || currentFileInput.files[0]);
        currentFileInput.files=productFileStore.files;
        appendThumbTo(currentPreviewArea, cropQueue[0]?.file || currentFileInput.files[currentFileInput.files.length-1], true);
      } else showError(`Maximum ${maxImagesPerProduct} product images allowed.`);
    } else {
      // variant path; key can be existing variant id or new index
      const isExisting = !!document.querySelector(`[data-variant-existing="${currentKey}"]`);
      const store = isExisting ? variantFileStores[currentKey] : newVariantFileStores[currentKey];
      const file = cropQueue[0]?.file;
      if([...store.files].length<maxImagesPerVariant){
        store.items.add(file);
        currentFileInput.files = store.files;
        renderVariantPreview(currentKey, currentPreviewArea, currentFileInput, isExisting);
      } else showError(`Maximum ${maxImagesPerVariant} variant images allowed.`);
    }
    cropper.destroy(); cropper=null; bootstrap.Modal.getInstance(document.getElementById("cropperModal")).hide(); processNextCrop();
  });
  document.getElementById("cropCancel").addEventListener("click",()=>{
    if(!cropper) return;
    cropper.destroy(); cropper=null; bootstrap.Modal.getInstance(document.getElementById("cropperModal")).hide(); processNextCrop();
  });
  document.getElementById("cropSave").addEventListener("click",()=>{
    if(!cropper) return;
    cropper.getCroppedCanvas({width:800,height:800}).toBlob(blob=>{
      const newFile=new File([blob],"image_"+Date.now()+".jpg",{type:blob.type});
      if(currentPreviewArea.id === "product_preview"){
        if([...productFileStore.files].length<maxImagesPerProduct){
          productFileStore.items.add(newFile);
          currentFileInput.files=productFileStore.files;
          appendThumbTo(currentPreviewArea, newFile, currentPreviewArea.children.length===0);
        } else showError(`Maximum ${maxImagesPerProduct} product images allowed.`);
      } else {
        const isExisting = !!document.querySelector(`[data-variant-existing="${currentKey}"]`);
        const store = isExisting ? variantFileStores[currentKey] : newVariantFileStores[currentKey];
        if([...store.files].length<maxImagesPerVariant){
          store.items.add(newFile);
          currentFileInput.files=store.files;
          renderVariantPreview(currentKey,currentPreviewArea,currentFileInput,isExisting);
        } else showError(`Maximum ${maxImagesPerVariant} variant images allowed.`);
      }
      bootstrap.Modal.getInstance(document.getElementById("cropperModal")).hide(); cropper.destroy(); cropper=null; processNextCrop();
    },"image/jpeg",0.9);
  });

  function appendThumbTo(container, file, isCover=false){
    const wrapper=document.createElement("div");
    wrapper.style.position="relative";
    const img=document.createElement("img");
    img.src=URL.createObjectURL(file);
    img.style.width="120px"; img.style.height="120px"; img.style.objectFit="cover"; img.style.borderRadius="6px";
    img.alt="Product image"; if(isCover) img.style.border="3px solid gold";
    const removeBtn=document.createElement("button"); removeBtn.innerHTML="×"; removeBtn.style.position="absolute"; removeBtn.style.top="4px"; removeBtn.style.right="6px"; removeBtn.style.background="red"; removeBtn.style.color="white"; removeBtn.style.border="none"; removeBtn.style.width="22px"; removeBtn.style.height="22px"; removeBtn.style.borderRadius="50%"; removeBtn.setAttribute("aria-label","Remove product image");
    removeBtn.addEventListener("click",()=>{
      const dt2=new DataTransfer();
      [...productFileStore.files].forEach((f,i)=>{ if(i!==[...container.children].indexOf(wrapper)) dt2.items.add(f); });
      productFileStore.items.clear();
      [...dt2.files].forEach(f=>productFileStore.items.add(f));
      document.getElementById("product_images").files=productFileStore.files;
      URL.revokeObjectURL(img.src); wrapper.remove();
    });
    wrapper.appendChild(img); wrapper.appendChild(removeBtn); container.appendChild(wrapper);
  }

  // ===== Form validation =====
  const productForm = document.getElementById("product-form");
  productForm.addEventListener("submit", function(e){
    const name = productForm.querySelector("input[name='name']").value.trim();
    const brand = productForm.querySelector("#brand").value;
    const category = productForm.querySelector("#category").value;
    if(!name || !brand || !category){ e.preventDefault(); showError("Name, Brand, and Category are required."); return false; }

    // Prevent duplicate colors across remaining + new (client-side hint; server validates too)
    const existingColorInputs = [...document.querySelectorAll('input[name="color_existing[]"]')].map(i=>i.value.trim()).filter(Boolean);
    const newColorInputs = [...document.querySelectorAll('input[name="color_new[]"]')].map(i=>i.value.trim()).filter(Boolean);
    const colors = [...existingColorInputs, ...newColorInputs];
    const set = new Set(colors);
    if (set.size !== colors.length){ e.preventDefault(); showError("Duplicate variant colors not allowed."); return false; }

    // Enforce product image total (existing minus marked + new)
    const existingPI = document.querySelectorAll('#product_existing_preview [data-existing-product-image]').length;
    const markedPI = [...document.querySelectorAll('input[name="remove_product_image_ids[]"]')].filter(h => h.value).length;
    const newPI = productFileStore.files.length;
    if ((existingPI - markedPI + newPI) > maxImagesPerProduct) {
      e.preventDefault(); showError(`Maximum ${maxImagesPerProduct} product images allowed.`); return false;
    }

    // Detailed total
    const existingDI = document.querySelectorAll('#detailed_existing_preview [data-existing-detailed-image]').length;
    const markedDI = [...document.querySelectorAll('input[name="remove_detailed_image_ids[]"]')].filter(h => h.value).length;
    const newDI = document.getElementById("detailed_images").files.length;
    if ((existingDI - markedDI + newDI) > maxDetailedImages) {
      e.preventDefault(); showError(`Maximum ${maxDetailedImages} detailed images allowed.`); return false;
    }
  });

  // ===== Add Brand AJAX (same as add page) =====
  document.getElementById("addBrandForm").addEventListener("submit",function(e){
    e.preventDefault();
    const name=document.getElementById("brand_name").value.trim();
    if(!name) return showError("Brand name required.");
    if(name.length>255) return showError("Max 255 chars.");
    const submitBtn=this.querySelector('button[type="submit"]'); submitBtn.disabled=true; submitBtn.innerHTML="Saving...";
    fetch("{% url 'add_brand_ajax' %}",{ method:"POST", headers:{ "Content-Type":"application/json","X-CSRFToken":getCsrfToken() }, body:JSON.stringify({name}) })
      .then(r=>r.json())
      .then(data=>{
        if(data.success){
          const brandSelect=document.getElementById("brand");
          const option=new Option(data.name,data.id,true,true); brandSelect.appendChild(option);
          document.getElementById("addBrandForm").reset();
          bootstrap.Modal.getInstance(document.getElementById("addBrandModal")).hide();
        } else showError(data.message || "Failed to add brand.");
      }).catch(err=>{ showError("Failed to add brand: "+err.message); console.error(err); })
      .finally(()=>{ submitBtn.disabled=false; submitBtn.innerHTML="Save"; });
  });

});
</script>
{% endblock %}
