{% extends 'admin/admin-base.html' %}
{% load static %}

{% block title %}
    Sales Report
{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

  :root{
    --ink:#0f172a;
    --muted:#64748b;
    --bg-primary:#0a0e1a;
  }

  *{
    font-family:'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    box-sizing: border-box;
  }

  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow-x: hidden;
  }

  body{
    background:#0a0e1a;
    position:relative;
  }

  /* ‚úÖ REMOVED animations on body::before to prevent zoom */
  body::before{
    content:'';
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:
      radial-gradient(circle at 20% 30%, rgba(102,126,234,0.12) 0%, transparent 50%),
      radial-gradient(circle at 80% 70%, rgba(118,75,162,0.12) 0%, transparent 50%);
    pointer-events:none;
    z-index:0;
    opacity:0.8;
  }

  /* ‚úÖ REMOVED: All particle effects for performance */
  /* Particles were causing 404 errors and lag */

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-15px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes scaleIn {
    from { opacity: 0; transform: scale(0.97); }
    to { opacity: 1; transform: scale(1); }
  }

  .sales-report-container{
    padding: 40px;
    max-width: 1600px;
    margin: 0 auto;
    position:relative;
    z-index:2;
    animation: fadeInUp 0.4s ease-out;
  }

  .dash-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:24px;
    margin-bottom:40px;
    padding:32px 40px;
    background:rgba(15,23,42,0.7);
    backdrop-filter:blur(20px);
    border-radius:24px;
    border:1px solid rgba(102,126,234,0.3);
    box-shadow:0 10px 40px rgba(0,0,0,0.3);
    animation: slideDown 0.4s ease-out;
  }

  .dash-title h1{
    margin:0;
    font-size:38px;
    font-weight:900;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);
    -webkit-background-clip:text;
    background-clip:text;
    -webkit-text-fill-color:transparent;
    letter-spacing:-0.03em;
  }

  .dash-title p{
    margin:12px 0 0;
    font-size:15px;
    color:#94a3b8;
    font-weight:600;
  }

  .date-range{
    display:flex;
    align-items:center;
    gap:14px;
    background:rgba(30,41,59,0.8);
    padding:14px 24px;
    border-radius:16px;
    border:1px solid rgba(102,126,234,0.3);
    transition:all 0.2s;
  }

  .date-range:hover{
    box-shadow:0 8px 30px rgba(102,126,234,0.3);
    transform:translateY(-2px);
  }

  .date-input{
    border:2px solid rgba(102,126,234,0.3);
    border-radius:12px;
    padding:10px 16px;
    font-size:13px;
    font-weight:600;
    outline:none;
    transition:all 0.2s;
    background:rgba(15,23,42,0.6);
    color:#e2e8f0;
  }

  .date-input:focus{
    border-color:#667eea;
    box-shadow:0 0 0 3px rgba(102,126,234,0.15);
  }

  .filters{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
    gap:20px;
    margin-bottom:40px;
    animation: fadeInUp 0.4s ease-out 0.1s backwards;
  }

  .filter-card{
    background:rgba(15,23,42,0.7);
    backdrop-filter:blur(20px);
    border-radius:16px;
    padding:20px;
    box-shadow:0 10px 40px rgba(0,0,0,0.3);
    border:1px solid rgba(102,126,234,0.3);
    transition:all 0.2s;
  }

  .filter-card:hover{
    transform:translateY(-3px);
    box-shadow:0 15px 50px rgba(0,0,0,0.4);
    border-color:rgba(102,126,234,0.5);
  }

  .filter-card label{
    display:block;
    font-size:11px;
    font-weight:800;
    color:#94a3b8;
    text-transform:uppercase;
    letter-spacing:0.1em;
    margin-bottom:10px;
  }

  .filter-card select{
    width:100%;
    padding:10px 16px;
    background:rgba(30,41,59,0.8);
    border:2px solid rgba(102,126,234,0.3);
    border-radius:12px;
    color:#e2e8f0;
    font-size:13px;
    font-weight:600;
    cursor:pointer;
    transition:all 0.2s;
  }

  .filter-card select:focus{
    outline:none;
    border-color:#667eea;
    box-shadow:0 0 0 3px rgba(102,126,234,0.15);
  }

  .stats-row{
    display:grid;
    grid-template-columns:repeat(4,minmax(0,1fr));
    gap:24px;
    margin-bottom:40px;
  }

  .stat-card{
    background:rgba(15,23,42,0.7);
    backdrop-filter:blur(20px);
    border-radius:20px;
    padding:28px;
    box-shadow:0 10px 40px rgba(0,0,0,0.3);
    border:1px solid rgba(102,126,234,0.3);
    display:flex;
    align-items:center;
    gap:20px;
    transition:all 0.3s;
    animation: scaleIn 0.4s ease-out backwards;
  }

  .stat-card:nth-child(1){animation-delay:0.15s;}
  .stat-card:nth-child(2){animation-delay:0.2s;}
  .stat-card:nth-child(3){animation-delay:0.25s;}
  .stat-card:nth-child(4){animation-delay:0.3s;}

  .stat-card:hover{
    transform:translateY(-5px);
    box-shadow:0 15px 50px rgba(0,0,0,0.4),0 0 30px rgba(102,126,234,0.3);
  }

  .stat-icon{
    width:68px;
    height:68px;
    border-radius:18px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:32px;
    box-shadow:0 8px 24px rgba(0,0,0,0.3);
    transition:transform 0.3s;
  }

  .stat-card:hover .stat-icon{
    transform:scale(1.08);
  }

  .stat-meta{
    flex:1;
  }

  .stat-label{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.1em;
    color:#94a3b8;
    font-weight:800;
    margin-bottom:8px;
  }

  .stat-value{
    font-size:32px;
    font-weight:900;
    color:#f8fafc;
    letter-spacing:-0.03em;
  }

  .stat-pill{
    margin-top:10px;
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size:10px;
    padding:6px 14px;
    border-radius:999px;
    background:rgba(16,185,129,0.2);
    color:#6ee7b7;
    font-weight:800;
    text-transform:uppercase;
    letter-spacing:0.06em;
    border:1px solid rgba(16,185,129,0.3);
  }

  .charts-row{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:24px;
    margin-bottom:40px;
  }

  .chart-card{
    background:rgba(15,23,42,0.7);
    backdrop-filter:blur(20px);
    border-radius:20px;
    padding:32px;
    box-shadow:0 10px 40px rgba(0,0,0,0.3);
    border:1px solid rgba(102,126,234,0.3);
    transition:all 0.3s;
    animation: fadeInUp 0.4s ease-out backwards;
  }

  .chart-card:nth-child(1){animation-delay:0.35s;}
  .chart-card:nth-child(2){animation-delay:0.4s;}

  .chart-card:hover{
    transform:translateY(-3px);
    box-shadow:0 15px 50px rgba(0,0,0,0.4);
  }

  .chart-card h2{
    font-size:20px;
    font-weight:900;
    color:#f8fafc;
    margin-bottom:24px;
  }

  .chart-full{
    grid-column:1 / -1;
    animation-delay:0.45s;
  }

  .table-container{
    background:rgba(15,23,42,0.7);
    backdrop-filter:blur(20px);
    border-radius:20px;
    padding:32px;
    box-shadow:0 10px 40px rgba(0,0,0,0.3);
    border:1px solid rgba(102,126,234,0.3);
    animation: fadeInUp 0.4s ease-out 0.5s backwards;
  }

  .table-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
    flex-wrap:wrap;
    gap:16px;
  }

  .table-header h2{
    font-size:20px;
    font-weight:900;
    color:#f8fafc;
  }

  .sort-options{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }

  .sort-btn{
    padding:10px 20px;
    background:rgba(30,41,59,0.8);
    border:2px solid rgba(102,126,234,0.3);
    border-radius:12px;
    color:#e2e8f0;
    font-size:12px;
    font-weight:700;
    cursor:pointer;
    transition:all 0.2s;
    text-transform:uppercase;
    letter-spacing:0.08em;
  }

  .sort-btn:hover, .sort-btn.active{
    background:rgba(102,126,234,0.3);
    border-color:#667eea;
    transform:translateY(-2px);
    color:#fff;
  }

  .export-btn{
    padding:11px 28px;
    border:0;
    border-radius:12px;
    font-size:13px;
    font-weight:800;
    cursor:pointer;
    color:#ffffff;
    background:linear-gradient(135deg,#667eea,#764ba2);
    box-shadow:0 4px 20px rgba(102,126,234,0.4);
    transition:all 0.2s;
    text-transform:uppercase;
    letter-spacing:0.08em;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    gap:8px;
  }

  .export-btn:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 30px rgba(102,126,234,0.5);
  }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:20px;
  }

  thead{
    background:rgba(30,41,59,0.6);
  }

  th{
    padding:16px;
    text-align:left;
    font-weight:800;
    color:#94a3b8;
    text-transform:uppercase;
    font-size:11px;
    letter-spacing:0.1em;
    border-bottom:2px solid rgba(102,126,234,0.3);
  }

  tbody tr{
    border-bottom:1px solid rgba(102,126,234,0.1);
    transition:background 0.2s;
  }

  tbody tr:hover{
    background:rgba(102,126,234,0.1);
  }

  td{
    padding:16px;
    color:#e2e8f0;
    font-size:14px;
    font-weight:600;
  }

  .product-cell{
    display:flex;
    align-items:center;
    gap:12px;
  }

  .product-img{
    width:48px;
    height:48px;
    border-radius:12px;
    background:linear-gradient(135deg,#667eea,#764ba2);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:20px;
    flex-shrink:0;
  }

  .status-badge{
    padding:8px 18px;
    border-radius:20px;
    font-size:10px;
    font-weight:800;
    text-transform:uppercase;
    letter-spacing:0.08em;
    display:inline-block;
    white-space:nowrap;
  }

  .status-delivered{
    background:rgba(52,211,153,0.2);
    color:#6ee7b7;
    border:1.5px solid rgba(52,211,153,0.5);
  }

  .status-confirmed{
    background:rgba(96,165,250,0.2);
    color:#60a5fa;
    border:1.5px solid rgba(96,165,250,0.5);
  }

  .status-placed{
    background:rgba(196,181,253,0.2);
    color:#c4b5fd;
    border:1.5px solid rgba(196,181,253,0.5);
  }

  .status-cancelled{
    background:transparent;
    color:#f87171;
    border:1.5px solid #f87171;
  }

  .status-returned{
    background:rgba(251,146,60,0.2);
    color:#fb923c;
    border:1.5px solid rgba(251,146,60,0.5);
  }

  .status-pending{
    background:rgba(251,191,36,0.2);
    color:#fbbf24;
    border:1.5px solid rgba(251,191,36,0.5);
  }

  .status-shipped{
    background:rgba(34,211,238,0.2);
    color:#22d3ee;
    border:1.5px solid rgba(34,211,238,0.5);
  }

  .pagination-container{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:12px;
    margin-top:32px;
    flex-wrap:wrap;
  }

  .pagination-btn{
    padding:10px 20px;
    background:rgba(30,41,59,0.8);
    border:2px solid rgba(102,126,234,0.3);
    border-radius:12px;
    color:#e2e8f0;
    cursor:pointer;
    transition:all 0.2s;
    font-size:13px;
    font-weight:700;
  }

  .pagination-btn:hover:not(:disabled){
    background:rgba(102,126,234,0.3);
    border-color:#667eea;
    transform:translateY(-2px);
    color:#fff;
  }

  .pagination-btn:disabled{
    opacity:0.3;
    cursor:not-allowed;
  }

  .page-info{
    color:#c4b5fd;
    font-weight:700;
    padding:10px 24px;
    background:rgba(102,126,234,0.2);
    border-radius:12px;
    border:2px solid rgba(102,126,234,0.4);
    font-size:13px;
  }

  option{
    color:#000;
    background:#fff;
  }

  @media (max-width:1200px){
    .stats-row{grid-template-columns:repeat(2,minmax(0,1fr));}
    .charts-row{grid-template-columns:1fr;}
  }

  @media (max-width:768px){
    .sales-report-container{padding:20px;}
    .dash-header{flex-direction:column;align-items:flex-start;padding:24px;}
    .dash-title h1{font-size:28px;}
    .stats-row{grid-template-columns:1fr;gap:16px;}
    .stat-value{font-size:28px;}
    .date-range{flex-direction:column;width:100%;}
    .filters{grid-template-columns:1fr;}
    .sort-options{flex-direction:column;width:100%;}
    .sort-btn, .export-btn{width:100%;}
  }

  .apexcharts-canvas {
    border-radius: 20px !important;
  }

  .apexcharts-tooltip {
    background: rgba(15, 23, 42, 0.95) !important;
    border: 1px solid rgba(102, 126, 234, 0.5) !important;
    border-radius: 16px !important;
    color: #e2e8f0 !important;
  }
</style>

<div class="sales-report-container">
  <div class="dash-header">
    <div class="dash-title">
      <h1>üìä Sales Analytics Dashboard</h1>
      <p>
        {% if start and end %}
          üìà Showing data from {{ start }} to {{ end }}
        {% else %}
          üöÄ Complete sales overview and analytics
        {% endif %}
      </p>
    </div>
    <div class="date-range">
      <input type="date" class="date-input" id="startDate" value="{{ start }}" name="start">
      <span style="color:#94a3b8;">to</span>
      <input type="date" class="date-input" id="endDate" value="{{ end }}" name="end">
      <button class="export-btn" onclick="applyDateFilter()">Apply</button>
    </div>
  </div>

  <div class="filters">
    <div class="filter-card">
      <label>Product Category</label>
      <select id="categoryFilter">
        <option value="all" {% if selected_category == "all" %}selected{% endif %}>All Categories</option>
        {% for cat in categories_list %}
        <option value="{{ cat }}" {% if selected_category == cat %}selected{% endif %}>{{ cat }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="filter-card">
      <label>Order Status</label>
      <select id="statusFilter">
        <option value="all" {% if selected_status == "all" %}selected{% endif %}>All Status</option>
        <option value="delivered" {% if selected_status == "delivered" %}selected{% endif %}>Delivered</option>
        <option value="confirmed" {% if selected_status == "confirmed" %}selected{% endif %}>Confirmed</option>
        <option value="placed" {% if selected_status == "placed" %}selected{% endif %}>Placed</option>
        <option value="cancelled" {% if selected_status == "cancelled" %}selected{% endif %}>Cancelled</option>
        <option value="returned" {% if selected_status == "returned" %}selected{% endif %}>Returned</option>
      </select>
    </div>

    <div class="filter-card">
      <label>Price Range</label>
      <select id="priceFilter">
        <option value="all" {% if selected_price == "all" %}selected{% endif %}>All Prices</option>
        <option value="700-1500" {% if selected_price == "700-1500" %}selected{% endif %}>‚Çπ700 - ‚Çπ1,500</option>
        <option value="1500-3000" {% if selected_price == "1500-3000" %}selected{% endif %}>‚Çπ1,500 - ‚Çπ3,000</option>
        <option value="3000-5000" {% if selected_price == "3000-5000" %}selected{% endif %}>‚Çπ3,000 - ‚Çπ5,000</option>
        <option value="5000-10000" {% if selected_price == "5000-10000" %}selected{% endif %}>‚Çπ5,000 - ‚Çπ10,000</option>
        <option value="10000-20000" {% if selected_price == "10000-20000" %}selected{% endif %}>‚Çπ10,000 - ‚Çπ20,000</option>
        <option value="20000-60000" {% if selected_price == "20000-60000" %}selected{% endif %}>‚Çπ20,000 - ‚Çπ60,000</option>
        <option value="60000+" {% if selected_price == "60000+" %}selected{% endif %}>‚Çπ60,000+</option>
      </select>
    </div>

    <div class="filter-card">
      <label>Time Period</label>
      <select id="periodFilter">
        <option value="custom">Custom Range</option>
        <option value="today">Today</option>
        <option value="week">This Week</option>
        <option value="month">This Month</option>
        <option value="quarter">This Quarter</option>
        <option value="year">This Year</option>
      </select>
    </div>
  </div>

  <section class="stats-row">
    <article class="stat-card">
      <div class="stat-icon" style="background:linear-gradient(135deg,#10b981,#059669)">üí∞</div>
      <div class="stat-meta">
        <div class="stat-label">Total Revenue</div>
        <div class="stat-value">‚Çπ{{ total_revenue|floatformat:0 }}</div>
        <span class="stat-pill">üìà Period Total</span>
      </div>
    </article>

    <article class="stat-card">
      <div class="stat-icon" style="background:linear-gradient(135deg,#8b5cf6,#6d28d9)">üì¶</div>
      <div class="stat-meta">
        <div class="stat-label">Total Orders</div>
        <div class="stat-value">{{ total_orders }}</div>
        <span class="stat-pill" style="background:rgba(59,130,246,0.2);color:#60a5fa;border-color:rgba(59,130,246,0.3);">‚úì Completed</span>
      </div>
    </article>

    <article class="stat-card">
      <div class="stat-icon" style="background:linear-gradient(135deg,#3b82f6,#1d4ed8)">üéµ</div>
      <div class="stat-meta">
        <div class="stat-label">Products Sold</div>
        <div class="stat-value">{{ total_quantity }}</div>
        <span class="stat-pill">‚ö° Total Units</span>
      </div>
    </article>

    <article class="stat-card">
      <div class="stat-icon" style="background:linear-gradient(135deg,#f59e0b,#d97706)">üìà</div>
      <div class="stat-meta">
        <div class="stat-label">Avg Order Value</div>
        <div class="stat-value">‚Çπ{{ avg_order_value|floatformat:0 }}</div>
        <span class="stat-pill" style="background:rgba(245,158,11,0.2);color:#fbbf24;border-color:rgba(245,158,11,0.3);">üíé Average</span>
      </div>
    </article>
  </section>

  <section class="charts-row">
    <article class="chart-card">
      <h2>üíπ Revenue Trend</h2>
      <div id="revenueChart" style="height:280px;"></div>
    </article>

    <article class="chart-card">
      <h2>üéØ Top Categories</h2>
      <div id="categoryChart" style="height:280px;"></div>
    </article>
  </section>

  <article class="chart-card chart-full">
    <h2>üìÖ Sales Over Time</h2>
    <div id="salesLineChart" style="height:320px;"></div>
  </article>

  <div class="table-container">
    <div class="table-header">
      <h2>üõí Recent Orders</h2>
        <div class="sort-options">
        <button class="sort-btn active" data-sort="date">Sort by Date</button>
        <button class="sort-btn" data-sort="amount">Sort by Amount</button>
        <button class="sort-btn" data-sort="status">Sort by Status</button>
        
        <!-- ‚úÖ CSV Export Button -->
        <button class="export-btn" id="csvExportBtn">
            üìä Export CSV
        </button>
        <!-- PDF Export Button -->
        <a href="{% url 'export_sales_pdf' %}?start={{ start }}&end={{ end }}&category={{ selected_category }}&status={{ selected_status }}&price={{ selected_price }}" 
            class="export-btn">
            üìÑ Export PDF
        </a>
        </div>

    </div>

    <table id="ordersTable">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Product</th>
          <th>Customer</th>
          <th>Date</th>
          <th>Amount</th>
          <th>Quantity</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    
    <div id="paginationControls" class="pagination-container"></div>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  const salesReportOrders = {{ recent_orders|safe }};
  const salesReportMonthlyRevenue = {{ monthly_revenue|safe }};
  const salesReportMonthlyLabels = {{ monthly_labels|safe }};
  
  const salesReportCategoryData = {
    {% for cat, data in category_sales.items %}
    "{{ cat }}": {{ data.quantity }}{% if not forloop.last %},{% endif %}
    {% endfor %}
  };

  let salesCurrentPage = 1;
  const salesOrdersPerPage = 20;
  let salesFilteredOrders = [...salesReportOrders];

  function salesPopulateTable(data, page = 1) {
    const tbody = document.getElementById('tableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#94a3b8;">No orders found for selected filters</td></tr>';
      salesUpdatePagination(0, page);
      return;
    }
    
    const startIndex = (page - 1) * salesOrdersPerPage;
    const endIndex = startIndex + salesOrdersPerPage;
    const paginatedData = data.slice(startIndex, endIndex);
    
    paginatedData.forEach((order) => {
      const row = document.createElement('tr');
      const statusClass = `status-${order.status}`;
      
      const productImageHTML = (order.image && order.image !== '' && order.image !== 'null' && order.image !== null)
        ? `<img src="${order.image}" alt="${order.product || 'Product'}" loading="lazy" style="width:48px;height:48px;object-fit:cover;border-radius:12px;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
           <div class="product-img" style="display:none;">üîä</div>`
        : `<div class="product-img">üîä</div>`;
      
      row.innerHTML = `
        <td><strong>${order.order_id || 'N/A'}</strong></td>
        <td>
          <div class="product-cell">
            ${productImageHTML}
            <span>${order.product || 'Unknown Product'}</span>
          </div>
        </td>
        <td>${order.customer || 'Guest'}</td>
        <td>${order.date || 'N/A'}</td>
        <td><strong>‚Çπ${(order.amount || 0).toFixed(0)}</strong></td>
        <td>${order.quantity || 0}</td>
        <td><span class="status-badge ${statusClass}">${(order.status || 'pending').toUpperCase()}</span></td>
      `;
      tbody.appendChild(row);
    });
    
    salesUpdatePagination(data.length, page);
  }

  function salesUpdatePagination(totalOrders, currentPage) {
    const totalPages = Math.ceil(totalOrders / salesOrdersPerPage);
    const paginationDiv = document.getElementById('paginationControls');
    
    if (!paginationDiv) return;
    
    if (totalPages <= 1) {
      paginationDiv.innerHTML = '';
      return;
    }
    
    paginationDiv.innerHTML = `
      <button onclick="window.salesChangePage(1)" class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''}>
        ‚èÆÔ∏è First
      </button>
      <button onclick="window.salesChangePage(${currentPage - 1})" class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''}>
        ‚óÄÔ∏è Previous
      </button>
      <span class="page-info">Page ${currentPage} of ${totalPages}</span>
      <button onclick="window.salesChangePage(${currentPage + 1})" class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''}>
        Next ‚ñ∂Ô∏è
      </button>
      <button onclick="window.salesChangePage(${totalPages})" class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''}>
        Last ‚è≠Ô∏è
      </button>
    `;
  }

  window.salesChangePage = function(page) {
    salesCurrentPage = page;
    salesPopulateTable(salesFilteredOrders, page);
    const ordersTable = document.getElementById('ordersTable');
    if (ordersTable) {
      ordersTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  };

  salesPopulateTable(salesReportOrders, salesCurrentPage);

  // ‚úÖ Delayed chart initialization
  setTimeout(function() {
    // Revenue Chart
    if (document.querySelector('#revenueChart')) {
      new ApexCharts(document.querySelector('#revenueChart'), {
        chart: {
          type: 'bar',
          height: 280,
          toolbar: { show: false },
          fontFamily: 'Inter, sans-serif',
          foreColor: '#94a3b8',
          background: 'transparent',
          animations: { enabled: true, speed: 600 }
        },
        series: [{ name: 'Revenue (‚Çπ)', data: salesReportMonthlyRevenue }],
        plotOptions: {
          bar: { borderRadius: 8, columnWidth: '60%' }
        },
        colors: ['#667eea'],
        fill: {
          type: 'gradient',
          gradient: {
            shade: 'dark',
            type: 'vertical',
            gradientToColors: ['#764ba2'],
            opacityFrom: 1,
            opacityTo: 0.9
          }
        },
        dataLabels: { enabled: false },
        grid: {
          show: true,
          borderColor: 'rgba(102, 126, 234, 0.15)',
          strokeDashArray: 6
        },
        xaxis: {
          categories: salesReportMonthlyLabels,
          labels: { style: { colors: '#94a3b8', fontSize: '12px', fontWeight: 600 } }
        },
        yaxis: {
          labels: {
            formatter: val => '‚Çπ' + val.toFixed(0),
            style: { colors: '#94a3b8', fontSize: '12px', fontWeight: 600 }
          }
        },
        tooltip: {
          theme: 'dark',
          y: { formatter: val => '‚Çπ' + val.toLocaleString('en-IN') }
        }
      }).render();
    }

    // Category Chart
    if (document.querySelector('#categoryChart')) {
      new ApexCharts(document.querySelector('#categoryChart'), {
        chart: {
          type: 'donut',
          height: 280,
          fontFamily: 'Inter, sans-serif',
          foreColor: '#94a3b8',
          background: 'transparent'
        },
        series: Object.values(salesReportCategoryData),
        labels: Object.keys(salesReportCategoryData),
        colors: ['#667eea', '#ec4899', '#10b981', '#fbbf24', '#f87171'],
        legend: {
          position: 'bottom',
          labels: { colors: '#c4b5fd' }
        },
        plotOptions: {
          pie: {
            donut: {
              size: '70%',
              labels: {
                show: true,
                total: {
                  show: true,
                  label: 'Total',
                  color: '#c4b5fd',
                  formatter: () => Object.values(salesReportCategoryData).reduce((a,b) => a+b, 0)
                }
              }
            }
          }
        },
        dataLabels: {
          enabled: true,
          style: { fontSize: '12px', fontWeight: 700 }
        },
        tooltip: {
          theme: 'dark',
          y: { formatter: val => val + ' units' }
        }
      }).render();
    }

    // Sales Line Chart
    if (document.querySelector('#salesLineChart')) {
      new ApexCharts(document.querySelector('#salesLineChart'), {
        chart: {
          type: 'area',
          height: 320,
          toolbar: { show: false },
          fontFamily: 'Inter, sans-serif',
          foreColor: '#94a3b8',
          background: 'transparent',
          animations: { enabled: true, speed: 800 }
        },
        series: [{ name: 'Sales', data: salesReportMonthlyRevenue }],
        stroke: {
          curve: 'smooth',
          width: 4,
          colors: ['#67e8f9']
        },
        fill: {
          type: 'gradient',
          gradient: {
            shade: 'dark',
            type: 'vertical',
            gradientToColors: ['#a855f7'],
            opacityFrom: 0.85,
            opacityTo: 0.1
          }
        },
        markers: {
          size: 6,
          colors: ['#0f172a'],
          strokeColors: ['#67e8f9'],
          strokeWidth: 3
        },
        grid: {
          show: true,
          borderColor: 'rgba(102, 126, 234, 0.15)',
          strokeDashArray: 6
        },
        xaxis: {
          categories: salesReportMonthlyLabels,
          labels: { style: { colors: '#94a3b8', fontSize: '12px', fontWeight: 600 } }
        },
        yaxis: {
          labels: {
            formatter: val => '‚Çπ' + val.toFixed(0),
            style: { colors: '#94a3b8', fontSize: '12px', fontWeight: 600 }
          }
        },
        tooltip: {
          theme: 'dark',
          y: { formatter: val => '‚Çπ' + val.toLocaleString('en-IN') }
        }
      }).render();
    }
  }, 300);

  // Filter functions
  window.salesApplyAllFilters = function() {
    const start = document.getElementById('startDate')?.value;
    const end = document.getElementById('endDate')?.value;
    const category = document.getElementById('categoryFilter')?.value;
    const status = document.getElementById('statusFilter')?.value;
    const price = document.getElementById('priceFilter')?.value;
    
    const params = new URLSearchParams();
    if (start) params.append('start', start);
    if (end) params.append('end', end);
    if (category && category !== 'all') params.append('category', category);
    if (status && status !== 'all') params.append('status', status);
    if (price && price !== 'all') params.append('price', price);
    
    window.location.href = `?${params.toString()}`;
  };

  window.applyDateFilter = window.salesApplyAllFilters;

  // Event listeners
  document.getElementById('categoryFilter')?.addEventListener('change', window.salesApplyAllFilters);
  document.getElementById('statusFilter')?.addEventListener('change', window.salesApplyAllFilters);
  document.getElementById('priceFilter')?.addEventListener('change', window.salesApplyAllFilters);

  // Sort buttons
  document.querySelectorAll('.sort-btn[data-sort]').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.sort-btn[data-sort]').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      const sortBy = this.dataset.sort;
      let sortedOrders = [...salesFilteredOrders];
      
      if (sortBy === 'amount') {
        sortedOrders.sort((a, b) => (b.amount || 0) - (a.amount || 0));
      } else if (sortBy === 'status') {
        sortedOrders.sort((a, b) => (a.status || '').localeCompare(b.status || ''));
      } else {
        sortedOrders.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
      }
      
      salesFilteredOrders = sortedOrders;
      salesCurrentPage = 1;
      salesPopulateTable(salesFilteredOrders, salesCurrentPage);
    });
  });

  // ‚úÖ CSV Export functionality
  const csvExportBtn = document.getElementById('csvExportBtn');
  if (csvExportBtn) {
    csvExportBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      if (salesFilteredOrders.length === 0) {
        alert('No orders to export!');
        return;
      }
      
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Order ID,Product,Customer,Date,Amount,Quantity,Status\n";
      
      salesFilteredOrders.forEach(order => {
        const row = [
          order.order_id || 'N/A',
          `"${(order.product || 'Unknown Product').replace(/"/g, '""')}"`,
          (order.customer || 'Guest').replace(/,/g, ' '),
          order.date || 'N/A',
          (order.amount || 0).toFixed(2),
          order.quantity || 0,
          (order.status || 'pending').toUpperCase()
        ].join(",");
        csvContent += row + "\n";
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      
      const startDate = document.getElementById('startDate')?.value || 'all';
      const endDate = document.getElementById('endDate')?.value || 'all';
      link.setAttribute("download", `sales_report_${startDate}_to_${endDate}.csv`);
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  }

  // Period Filter
  document.getElementById('periodFilter')?.addEventListener('change', function() {
    const period = this.value;
    if (period === 'custom') return;
    
    const today = new Date();
    const endDate = today.toISOString().split('T')[0];
    
    const periodMap = {
      'today': 0,
      'week': 7,
      'month': 30,
      'quarter': 90,
      'year': 365
    };
    
    if (periodMap[period] !== undefined) {
      const daysAgo = new Date(today);
      daysAgo.setDate(daysAgo.getDate() - periodMap[period]);
      const startDate = daysAgo.toISOString().split('T')[0];
      
      document.getElementById('startDate').value = startDate;
      document.getElementById('endDate').value = endDate;
      window.salesApplyAllFilters();
    }
  });
})();
</script>

{% endblock %}
