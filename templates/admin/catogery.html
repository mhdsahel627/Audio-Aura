{% extends 'admin/admin-base.html' %}
{% load static %}

{% block title %}
  Category
{% endblock %}

{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

  :root {
    --bg-dark: #0a0e1a;
    --card-bg: rgba(15,23,42,0.6);
    --border-color: rgba(102,126,234,0.3);
    --text-light: #f8fafc;
    --text-muted: #94a3b8;
    --gradient-primary: linear-gradient(135deg, #667eea, #764ba2);
  }

  * {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    box-sizing: border-box;
  }

  body {
    background: var(--bg-dark);
    position: relative;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background:
      radial-gradient(circle at 20% 30%, rgba(102,126,234,0.15) 0%, transparent 50%),
      radial-gradient(circle at 80% 70%, rgba(118,75,162,0.15) 0%, transparent 50%);
    animation: backgroundPulse 15s ease-in-out infinite;
    pointer-events: none;
    z-index: 0;
  }

  @keyframes backgroundPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes slideInRight {
    from { opacity: 0; transform: translateX(30px); }
    to { opacity: 1; transform: translateX(0); }
  }

  @keyframes scaleIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }

  @keyframes shimmer {
    0% { background-position: -200% center; }
    100% { background-position: 200% center; }
  }

  .category-wrapper {
    padding: 32px;
    max-width: 1600px;
    margin: 0 auto;
    position: relative;
    z-index: 2;
    animation: fadeInUp 0.6s ease-out;
  }

  /* Enhanced Header */
  .category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    margin-bottom: 32px;
    padding: 28px 36px;
    background: var(--card-bg);
    backdrop-filter: blur(30px) saturate(180%);
    border-radius: 24px;
    border: 1px solid var(--border-color);
    box-shadow: 0 20px 60px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
    animation: slideInRight 0.7s ease-out;
  }

  .category-header h1 {
    margin: 0;
    font-size: 32px;
    font-weight: 900;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 3s linear infinite;
    letter-spacing: -0.02em;
  }

  /* Add Button */
  .btn-add {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 24px;
    border: none;
    border-radius: 16px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #fff;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 6px 24px rgba(102,126,234,0.4);
    transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
    position: relative;
    overflow: hidden;
    text-decoration: none;
  }

  .btn-add::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
  }

  .btn-add:hover::before {
    left: 100%;
  }

  .btn-add:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 36px rgba(102,126,234,0.5);
  }

  /* Table Container */
  .category-table-container {
    background: var(--card-bg);
    backdrop-filter: blur(30px) saturate(180%);
    border-radius: 24px;
    border: 1px solid var(--border-color);
    box-shadow: 0 20px 60px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
    overflow: hidden;
    animation: scaleIn 0.6s ease-out 0.2s backwards;
  }

  .category-table {
    border: none !important;
    width: 100%;
    border-collapse: collapse;
  }

  .category-table thead th {
    background: rgba(102,126,234,0.1);
    border-bottom: 2px solid var(--border-color);
    color: var(--text-light);
    font-weight: 800;
    padding: 20px 24px;
    text-align: left;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .category-table tbody tr {
    background: #000000;
    border-bottom: 1px solid rgba(102,126,234,0.1);
    transition: all 0.3s ease;
    position: relative;
  }

  .category-table tbody tr::before {
    
    position: absolute;
    left: 0;
    top: 0;
    width: 3px;
    height: 100%;
    background: var(--gradient-primary);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .category-table tbody tr:hover {
    background: rgb(80, 81, 86);
  }

  .category-table tbody tr:hover::before {
    opacity: 1;
  }

  .category-table tbody td {
    padding: 20px 24px;
    color: var(--text-light);
    font-weight: 600;
    font-size: 14px;
  }

  /* Category Image */
  .category-img-wrapper {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .category-img {
    width: 64px;
    height: 64px;
    border-radius: 16px;
    object-fit: cover;
    border: 2px solid var(--border-color);
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
  }

  .category-table tbody tr:hover .category-img {
    transform: scale(1.1) rotate(3deg);
    box-shadow: 0 12px 32px rgba(102,126,234,0.4);
  }

  .category-name {
    font-weight: 800;
    color: var(--text-light);
    font-size: 15px;
  }

  /* Action Buttons */
  .action-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .icon-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    border: 2px solid var(--border-color);
    background: rgba(30,41,59,0.6);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .icon-btn:hover {
    background: var(--gradient-primary);
    border-color: transparent;
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(102,126,234,0.4);
  }

  .icon-btn svg {
    width: 18px;
    height: 18px;
    fill: var(--text-light);
  }

  /* Offer Section */
  .offer-section {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .offer-badge {
    padding: 6px 14px;
    border-radius: 999px;
    background: rgba(16,185,129,0.2);
    color: #6ee7b7;
    font-weight: 800;
    font-size: 13px;
    border: 1px solid rgba(16,185,129,0.3);
  }

  .offer-actions {
    display: flex;
    gap: 4px;
  }

  .offer-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--border-color);
    background: rgba(30,41,59,0.6);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .offer-btn:first-child {
    border-radius: 8px 0 0 8px;
  }

  .offer-btn:last-child {
    border-radius: 0 8px 8px 0;
  }

  .offer-btn:hover {
    background: rgba(102,126,234,0.2);
    border-color: #667eea;
  }

  .offer-btn svg {
    width: 16px;
    height: 16px;
  }

  .add-offer-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    border: 2px solid var(--border-color);
    background: rgba(30,41,59,0.6);
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
  }

  .add-offer-btn:hover {
    background: rgba(16,185,129,0.2);
    border-color: #10b981;
    transform: scale(1.1);
  }

  .add-offer-btn svg {
    width: 20px;
    height: 20px;
    fill: #10b981;
  }

  /* Holographic Toggle Button */
  .toggle-container {
    position: relative;
    width: 120px;
    display: flex;
    flex-direction: column;
    align-items: center;
    perspective: 800px;
    z-index: 5;
  }

  .toggle-wrap {
    position: relative;
    width: 100%;
    height: 48px;
    transform-style: preserve-3d;
  }

  .toggle-input {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-track {
    margin-left: -79px;
    position: absolute;
    width: 100%;
    height: 100%;
    background: rgba(0, 30, 60, 0.4);
    border-radius: 24px;
    cursor: pointer;
    box-shadow: 0 0 15px rgba(0, 80, 255, 0.2), inset 0 0 10px rgba(0, 0, 0, 0.8);
    overflow: hidden;
    backdrop-filter: blur(5px);
    transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
    border: 1px solid rgba(0, 150, 255, 0.3);
  }

  .toggle-track::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(ellipse at center, rgba(0, 80, 255, 0.1) 0%, rgba(0, 0, 0, 0) 70%);
    opacity: 0.6;
    transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
  }

  .toggle-thumb {
    position: absolute;
    width: 42px;
    height: 42px;
    left: 3px;
    top: 3px;
    background: radial-gradient(circle, rgba(10, 40, 90, 0.9) 0%, rgba(0, 20, 50, 0.8) 100%);
    border-radius: 50%;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.5), inset 0 0 15px rgba(0, 150, 255, 0.5);
    transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
    z-index: 2;
    border: 1px solid rgba(0, 170, 255, 0.6);
    overflow: hidden;
  }

  .thumb-core {
    position: absolute;
    width: 32px;
    height: 32px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: radial-gradient(circle, rgba(0, 180, 255, 0.6) 0%, rgba(0, 50, 120, 0.2) 100%);
    border-radius: 50%;
    box-shadow: 0 0 20px rgba(0, 150, 255, 0.5);
    opacity: 0.9;
    transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
  }

  .thumb-inner {
    position: absolute;
    width: 20px;
    height: 20px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: radial-gradient(circle, rgba(255, 255, 255, 0.8) 0%, rgba(100, 200, 255, 0.5) 100%);
    border-radius: 50%;
    box-shadow: 0 0 10px rgba(100, 200, 255, 0.7);
    opacity: 0.7;
    animation: pulse 2s infinite alternate;
  }

  @keyframes pulse {
    0% { opacity: 0.5; transform: translate(-50%, -50%) scale(0.9); }
    100% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.1); }
  }

  .toggle-data {
    position: absolute;
    width: 100%;
    height: 100%;
    z-index: 1;
  }

  .data-text {
    position: absolute;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    transition: all 0.5s ease;
  }

  .data-text.off {
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    opacity: 1;
    color: rgba(0, 150, 255, 0.6);
    text-shadow: 0 0 5px rgba(0, 100, 255, 0.4);
  }

  .data-text.on {
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0;
    color: rgba(0, 255, 150, 0.6);
    text-shadow: 0 0 5px rgba(0, 255, 100, 0.4);
  }

  .toggle-input:checked + .toggle-track {
    background: rgba(0, 60, 30, 0.4);
    border-color: rgba(0, 255, 150, 0.3);
    box-shadow: 0 0 15px rgba(0, 255, 150, 0.2), inset 0 0 10px rgba(0, 0, 0, 0.8);
  }

  .toggle-input:checked + .toggle-track .toggle-thumb {
    left: calc(100% - 45px);
    background: radial-gradient(circle, rgba(10, 90, 40, 0.9) 0%, rgba(0, 50, 20, 0.8) 100%);
    border-color: rgba(0, 255, 150, 0.6);
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.5), inset 0 0 15px rgba(0, 255, 150, 0.5);
  }

  .toggle-input:checked + .toggle-track .thumb-core {
    background: radial-gradient(circle, rgba(0, 255, 150, 0.6) 0%, rgba(0, 120, 50, 0.2) 100%);
    box-shadow: 0 0 20px rgba(0, 255, 150, 0.5);
  }

  .toggle-input:checked + .toggle-track .thumb-inner {
    background: radial-gradient(circle, rgba(255, 255, 255, 0.8) 0%, rgba(100, 255, 200, 0.5) 100%);
    box-shadow: 0 0 10px rgba(100, 255, 200, 0.7);
  }

  .toggle-input:checked + .toggle-track .data-text.off {
    opacity: 0;
  }

  .toggle-input:checked + .toggle-track .data-text.on {
    opacity: 1;
  }

  /* Modal */
  #categoryOfferModal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(10px);
    display: none;
    align-items: center;
    justify-content: center;
  }

  #categoryOfferModal .modal-content {
    background: var(--card-bg);
    backdrop-filter: blur(30px);
    border-radius: 24px;
    border: 1px solid var(--border-color);
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
    max-width: 540px;
    width: 90%;
    padding: 40px;
    position: relative;
    animation: scaleIn 0.3s ease-out;
  }

  #categoryOfferModal h2 {
    font-weight: 900;
    font-size: 28px;
    margin-bottom: 28px;
    margin-top: 0;
    color: var(--text-light);
    text-align: center;
    letter-spacing: -0.02em;
  }

  #categoryOfferModal .close-btn {
    position: absolute;
    right: 20px;
    top: 20px;
    font-size: 32px;
    background: none;
    border: none;
    color: var(--text-light);
    cursor: pointer;
    transition: all 0.3s ease;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
  }

  #categoryOfferModal .close-btn:hover {
    background: rgba(239,68,68,0.2);
    color: #ef4444;
  }

  .form-row {
    margin-bottom: 20px;
  }

  .label-main {
    color: var(--text-light);
    font-weight: 700;
    font-size: 13px;
    margin-bottom: 8px;
    display: block;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .input-main {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    background: rgba(30,41,59,0.6);
    color: var(--text-light);
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .input-main:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102,126,234,0.2);
  }

  .discount-group {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .discount-percent,
  .discount-rupees {
    flex: 1;
  }

  .date-row {
    display: flex;
    gap: 16px;
  }

  .date-row > div {
    flex: 1;
  }

  .add-btn {
    width: 100%;
    padding: 14px;
    background: var(--gradient-primary);
    color: #fff;
    font-weight: 700;
    font-size: 15px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 24px rgba(102,126,234,0.4);
    margin-top: 10px;
  }

  .add-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 36px rgba(102,126,234,0.5);
  }

  /* Responsive */
  @media (max-width: 991px) {
    .category-header {
      flex-direction: column;
      align-items: stretch;
    }
  }

  @media (max-width: 768px) {
    .category-wrapper {
      padding: 20px;
    }

    .category-header h1 {
      font-size: 24px;
    }

    .category-table thead {
      display: none;
    }

    .category-table,
    .category-table tbody,
    .category-table tr,
    .category-table td {
      display: block;
      width: 100%;
    }

    .category-table tr {
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 16px;
    }

    .category-table td {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(102,126,234,0.1);
    }

    .category-table td:last-child {
      border-bottom: none;
    }

    .category-table td::before {
      content: attr(data-label);
      font-weight: 700;
      color: var(--text-muted);
      margin-right: 12px;
    }
  }
.category-table colgroup col:nth-child(1) { width: 60px; }   /* SNO */
.category-table colgroup col:nth-child(2) { width: 280px; }  /* Category */
.category-table colgroup col:nth-child(3) { width: 90px; }   /* Sales */
.category-table colgroup col:nth-child(4) { width: 90px; }   /* Stock */
.category-table colgroup col:nth-child(5) { width: 160px; }  /* Added */
.category-table colgroup col:nth-child(6) { width: 140px; }  /* Status */
.category-table colgroup col:nth-child(7) { width: 130px; }  /* Actions */
.category-table colgroup col:nth-child(8) { width: 160px; }  /* Offer */

.category-table thead th {
  padding: 16px 30px;
  font-size: 13px;
}

.category-table tbody td {
  padding: 18px 20px;
  font-size: 15px;
}

.category-name {
  font-size: 16px;
}

.category-table tbody tr {
  height: 78px;
}

</style>

<div class="category-wrapper">
  <!-- Header -->
  <div class="category-header">
    <div>
      <h1>üé® Categories</h1>
    </div>
    <a href="{% url 'add_catogery' %}" class="btn-add">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
      </svg>
      <span>Add Category</span>
    </a>
  </div>

  <!-- Table -->
  <div class="category-table-container">
    <table class="category-table">
      <thead>
        <tr>
          <th>SNO</th>
          <th>Category</th>
          <th>  </th>
          <th>  </th>
          <th>Added</th>
          <th>Status</th>
          <th>Actions</th>
          <th>Offer</th>
        </tr>
      </thead>
      <tbody>
        {% for category in categories %}
        <tr>
          <td data-label="SNO">{{ forloop.counter }}</td>
          <td data-label="Category">
            <div class="category-img-wrapper">
              {% if category.image %}
                <img src="{{ category.image.url }}" alt="{{ category.name }}" class="category-img">
              {% else %}
                <div class="category-img" style="background: var(--gradient-primary);"></div>
              {% endif %}
              <span class="category-name">{{ category.name }}</span>
            </div>
          </td>
          <td data-label="Sales">  </td>
          <td data-label="Stock"> </td>
          <td data-label="Added">{{ category.created_at|date:"M d, Y" }}</td>
          <td data-label="Status">
            <div class="toggle-container">
              <div class="toggle-wrap">
                <input class="toggle-input toggle-category" 
                       id="toggle-{{ category.id }}"
                       type="checkbox" 
                       data-id="{{ category.id }}"
                       data-url="{% url 'toggle_category' category.id %}"
                       {% if category.is_active %}checked{% endif %} />
                <label class="toggle-track" for="toggle-{{ category.id }}">
                  <div class="toggle-thumb">
                    <div class="thumb-core"></div>
                    <div class="thumb-inner"></div>
                  </div>
                  <div class="toggle-data">
                    <div class="data-text off">LIST</div>
                    <div class="data-text on">UNLIST</div>
                  </div>
                </label>
              </div>
            </div>
          </td>
          <td data-label="Actions">
            <div class="action-buttons">
              <a class="icon-btn" href="{% url 'category_edit' pk=category.id %}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                  <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                  <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                </svg>
              </a>
            </div>
          </td>
          <td data-label="Offer">
            {% if category.offers.last %}
              <div class="offer-section">
                <span class="offer-badge">{{ category.offers.last.discount_percent }}% Off</span>
                <div class="offer-actions">
                  <button class="offer-btn edit-category-offer-btn" data-offer-id="{{ category.offers.last.id }}">
                  üñãÔ∏è
                  </button>

                  <button class="offer-btn delete-category-offer-btn" data-offer-id="{{ category.offers.last.id }}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="#ef4444">
                      <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5z"/>
                    </svg>üóëÔ∏è
                  </button>
                </div>
              </div>
            {% else %}
              <a href="#" class="add-offer-btn cat-off-btn" data-category="{{ category.id }}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                  <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                </svg>
              </a>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">No categories found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


<!-- Offer Modal -->
<div id="categoryOfferModal" class="modal" style="display:none">
  <div class="modal-content">
    <button class="close-btn" type="button">&times;</button>
    <h2>üí∞ Category Offer</h2>
    
    <form id="categoryOfferForm" autocomplete="off">
      {% csrf_token %}
      <input type="hidden" name="category_id" id="modal_category_id">
      <input type="hidden" id="modal_category_offer_id" value="">
      
      <!-- Title -->
      <div class="form-row">
        <label class="label-main" for="offer_title">Offer Title</label>
        <input 
          class="input-main" 
          type="text" 
          name="title" 
          id="offer_title" 
          placeholder="e.g., Electronics Sale" 
          maxlength="100"
        >
      </div>

      <!-- Discount Percentage Only -->
      <div class="form-row">
        <label class="label-main" for="discount_percent">Discount Percentage (%)</label>
        <input 
          class="input-main" 
          type="number" 
          name="discount_percent" 
          id="discount_percent" 
          placeholder="e.g., 25" 
          step="0.01"
          min="0.01"
          max="100"
        >
        <span class="hint">Enter percentage between 0.01 and 100</span>
      </div>

      <!-- Dates -->
      <div class="form-row date-row">
        <div>
          <label class="label-main" for="start_date">Start Date</label>
          <input class="input-main" type="date" name="start_date" id="start_date">
        </div>
        <div>
          <label class="label-main" for="end_date">End Date</label>
          <input class="input-main" type="date" name="end_date" id="end_date">
        </div>
      </div>

      <button type="submit" class="add-btn">Save Offer</button>
    </form>
  </div>
</div>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// ===== CSRF TOKEN =====
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// ===== TOGGLE CATEGORY =====
document.querySelectorAll('.toggle-category').forEach(function(checkbox) {
  checkbox.addEventListener('change', function() {
    const url = this.dataset.url;
    const isChecked = this.checked;

    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json'
      }
    })
    .then(res => res.json())
    .then(data => {
      if(data.success) {
        this.checked = data.is_active;
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: 'Category status updated!',
          confirmButtonColor: '#6366f1',
          timer: 2000,
          timerProgressBar: true
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Failed',
          text: 'Failed to update category status!'
        });
        this.checked = !isChecked;
      }
    })
    .catch(err => {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Network error!'
      });
      this.checked = !isChecked;
    });
  });
});

// ===== CATEGORY OFFER MODAL =====
const categoryOfferModal = $('#categoryOfferModal');
const categoryOfferForm = $('#categoryOfferForm');

// Open modal for ADD
$(document).on('click', '.cat-off-btn', function(e) {
  e.preventDefault();
  clearCategoryOfferForm();
  clearErrors();
  $('#modal_category_id').val($(this).data('category'));
  $('#modal_category_offer_id').val('');
  $('#categoryOfferModal h2').text('üí∞ Add Category Offer');
  $('#categoryOfferModal .add-btn').text('Add Offer');
  categoryOfferModal.css('display', 'flex');
});

// Open modal for EDIT
$(document).on('click', '.edit-category-offer-btn', function(e) {
  e.preventDefault();
  clearErrors();
  const offerId = $(this).data('offer-id');
  
  $.ajax({
    url: `/categories/offers/edit/${offerId}/`,
    method: 'GET',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    },
    success: function(data) {
      if (data.success) {
        $('#modal_category_offer_id').val(offerId);
        $('#modal_category_id').val(data.category_id);
        $('#offer_title').val(data.title);
        $('#discount_percent').val(data.discount_percent);
        $('#start_date').val(data.start_date);
        $('#end_date').val(data.end_date);
        
        $('#categoryOfferModal h2').text('üí∞ Edit Category Offer');
        $('#categoryOfferModal .add-btn').text('Update Offer');
        categoryOfferModal.css('display', 'flex');
      }
    },
    error: function() {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Failed to load offer data'
      });
    }
  });
});

// DELETE offer
$(document).on('click', '.delete-category-offer-btn', async function(e) {
  e.preventDefault();
  const offerId = $(this).data('offer-id');
  
  const result = await Swal.fire({
    title: 'Delete Category Offer?',
    text: 'This action cannot be undone',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ef4444',
    cancelButtonColor: '#6b7280',
    confirmButtonText: 'Yes, delete it!',
    cancelButtonText: 'Cancel'
  });
  
  if (result.isConfirmed) {
    $.ajax({
      url: `/categories/offers/delete/${offerId}/`,
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'X-Requested-With': 'XMLHttpRequest'
      },
      success: function(resp) {
        if(resp.success) {
          Swal.fire({
            icon: 'success',
            title: 'Deleted!',
            text: resp.message,
            confirmButtonColor: '#6366f1'
          }).then(() => location.reload());
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Failed',
            text: resp.message
          });
        }
      },
      error: function() {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Network error. Please try again.'
        });
      }
    });
  }
});

// CLOSE modal
$('.close-btn, #categoryOfferModal').click(function(e) {
  if (e.target === this) {
    categoryOfferModal.hide();
    clearCategoryOfferForm();
    clearErrors();
  }
});

// ===== FORM SUBMISSION WITH VALIDATION =====
categoryOfferForm.submit(function(e) {
  e.preventDefault();
  clearErrors();
  
  let isValid = true;
  
  // 1. Title validation
  const title = $('#offer_title').val().trim();
  if (!title) {
    showError('offer_title', 'Title is required');
    isValid = false;
  } else if (title.length < 3) {
    showError('offer_title', 'Title must be at least 3 characters');
    isValid = false;
  }
  
  // 2. Discount percentage validation
  const discountPercent = $('#discount_percent').val().trim();
  if (!discountPercent) {
    showError('discount_percent', 'Discount percentage is required');
    isValid = false;
  } else {
    const percent = parseFloat(discountPercent);
    if (isNaN(percent) || percent <= 0 || percent > 100) {
      showError('discount_percent', 'Percentage must be between 0.01 and 100');
      isValid = false;
    }
  }
  
  // 3. Date validation
  const startDate = $('#start_date').val();
  const endDate = $('#end_date').val();
  
  if (!startDate) {
    showError('start_date', 'Start date is required');
    isValid = false;
  }
  
  if (!endDate) {
    showError('end_date', 'End date is required');
    isValid = false;
  }
  
  if (startDate && endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (start < today) {
      showError('start_date', 'Start date cannot be in the past');
      isValid = false;
    }
    
    if (end <= start) {
      showError('end_date', 'End date must be after start date');
      isValid = false;
    }
    
    const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
    if (duration > 365) {
      showError('end_date', 'Offer duration cannot exceed 1 year');
      isValid = false;
    }
  }
  
  if (!isValid) {
    return;
  }
  
  // Submit
  const offerId = $('#modal_category_offer_id').val();
  const url = offerId 
    ? `/categories/offers/edit/${offerId}/` 
    : '/categories/offers/add/';
  
  $.ajax({
    url: url,
    method: 'POST',
    data: $(this).serialize(),
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'X-Requested-With': 'XMLHttpRequest'
    },
    success: function(resp) {
      if(resp.success) {
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: resp.message,
          confirmButtonColor: '#6366f1'
        }).then(() => location.reload());
      } else {
        if (resp.errors) {
          Object.keys(resp.errors).forEach(field => {
            showError(field, resp.errors[field]);
          });
          
          if (resp.errors.general) {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: resp.errors.general
            });
          }
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: resp.message || 'Failed to save offer'
          });
        }
      }
    },
    error: function() {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Network error. Please try again.'
      });
    }
  });
});

// ===== REAL-TIME PERCENTAGE VALIDATION =====
$('#discount_percent').on('input', function() {
  const value = parseFloat($(this).val());
  if (value > 100) {
    $(this).val(100);
  } else if (value < 0) {
    $(this).val(0);
  }
  clearErrors();
});

// ===== DATE VALIDATION ON CHANGE =====
$('#end_date').on('change', function() {
  const startDate = $('#start_date').val();
  const endDate = $(this).val();
  
  if (startDate && endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (end <= start) {
      showError('end_date', 'End date must be after start date');
      $(this).val('');
    } else {
      const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
      if (duration > 365) {
        showError('end_date', 'Offer duration cannot exceed 1 year');
        $(this).val('');
      }
    }
  }
});

// ===== HELPER FUNCTIONS =====
function showError(fieldId, message) {
  const field = $('#' + fieldId);
  if (!field.length) return;
  
  field.css({
    'borderColor': '#ef4444',
    'boxShadow': '0 0 0 3px rgba(239, 68, 68, 0.1)'
  });
  
  // Remove existing error
  field.parent().find('.error-message').remove();
  
  // Add new error
  const errorDiv = $('<div></div>')
    .addClass('error-message')
    .css({
      'color': '#ef4444',
      'fontSize': '0.875rem',
      'marginTop': '6px',
      'fontWeight': '600',
      'animation': 'fadeInUp 0.3s ease'
    })
    .text(message);
  
  field.parent().append(errorDiv);
}

function clearErrors() {
  $('.error-message').remove();
  $('.input-main').css({
    'borderColor': '#e5e7eb',
    'boxShadow': 'none'
  });
}

function clearCategoryOfferForm() {
  categoryOfferForm[0].reset();
  $('#modal_category_id').val('');
  $('#modal_category_offer_id').val('');
}
</script>


{% endblock %}